<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>C64 Piano — Polished</title>
<style>
  :root{
    --key-w:64px; --key-h:220px; --black-w:38px; --black-h:132px;
    --c64-bg:#3b5dc9;           /* C64 blue */
    --c64-panel:#273fa8;        /* darker panel */
    --c64-text:#d6e0ff;         /* light text */
    --c64-border:#a9bbff;       /* border */
    --c64-accent:#f2f29b;       /* accent (yellowish) */
    --glow:#88a4ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    margin:0; background:radial-gradient(1200px 900px at 50% 0%, #4c6af0 0%, var(--c64-bg) 50%, #2f48a8 100%);
    color:var(--c64-text);
    display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; position:relative; overflow-x:hidden;
  }
  /* CRT scanlines + vignette */
  body::before, body::after{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
  }
  body::before{ background: repeating-linear-gradient( to bottom, rgba(0,0,0,0.12) 0, rgba(0,0,0,0.12) 1px, transparent 2px, transparent 3px ); mix-blend-mode:multiply; opacity:.35; }
  body::after{ box-shadow: inset 0 0 200px rgba(0,0,0,0.35), inset 0 0 100px rgba(0,0,0,0.2); }

  .panel{
    background:linear-gradient(180deg, rgba(20,32,120,.35), rgba(10,20,70,.35)), var(--c64-panel);
    border:2px solid var(--c64-border); border-radius:12px; padding:14px 16px; margin:12px; max-width:1200px; width:calc(100% - 24px);
    position:relative; z-index:1; backdrop-filter: blur(2px) saturate(1.05);
  }
  .panel::before{ content:""; position:absolute; inset:0; border-radius:12px; box-shadow:0 0 0 1px rgba(255,255,255,0.06) inset, 0 10px 30px rgba(0,0,0,0.2) inset; pointer-events:none; }

  .row{display:flex; gap:14px; flex-wrap:wrap; align-items:center}
  .row label{font-size:12px; display:flex; gap:6px; align-items:center}
  .title{font-weight:800; margin:0 0 10px 0; font-size:15px; letter-spacing:0.6px; text-shadow:0 1px 0 rgba(0,0,0,0.35)}

  .pill{padding:4px 10px; border-radius:999px; background:rgba(169,187,255,0.15); border:1px solid var(--c64-border); font-size:12px}
  .pill.glow{box-shadow:0 0 0 2px var(--glow) inset}

  .btn{padding:6px 10px; border-radius:6px; border:2px solid var(--c64-border); background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0.12)); color:var(--c64-text); cursor:pointer; font-size:12px; transition:transform .05s ease, background .2s ease}
  .btn:hover{background:linear-gradient(180deg, rgba(255,255,255,0.14), rgba(0,0,0,0.18))}
  .btn:active{transform:translateY(1px)}
  .btn:focus-visible{outline:2px dashed var(--c64-accent); outline-offset:2px}

  /* Segmented controls */
  .seg{display:flex; gap:6px; align-items:center}
  .segBtn{display:inline-flex; align-items:center; justify-content:center; gap:6px; height:30px; padding:0 10px; border:2px solid var(--c64-border); background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.12)); color:var(--c64-text); border-radius:8px; cursor:pointer; transition:filter .2s ease, transform .05s ease}
  .segBtn:hover{filter:brightness(1.1)}
  .segBtn:active{transform:translateY(1px)}
  .segBtn.active{background:linear-gradient(180deg, rgba(169,187,255,0.35), rgba(20,28,80,0.3)); box-shadow:0 0 0 1px rgba(255,255,255,0.06) inset}
  .segBtn svg{width:20px; height:16px; stroke:var(--c64-text); fill:none; stroke-width:2}

  /* Range inputs */
  input[type=range]{accent-color: var(--c64-accent)}

  /* Mini canvases */
  .miniWrap{display:flex; gap:12px; align-items:center}
  canvas.mini{background:linear-gradient(180deg, rgba(0,0,0,0.15), rgba(255,255,255,0.05)); border:2px solid var(--c64-border); border-radius:8px; backdrop-filter: blur(1px); box-shadow:0 4px 14px rgba(0,0,0,0.25)}

  .kbdWrap{display:flex; gap:14px; align-items:flex-start}
  .kbd{position:relative; display:flex; gap:2px; padding:12px; border:2px solid var(--c64-border); border-radius:12px; background:linear-gradient(180deg, rgba(0,0,0,0.12), rgba(255,255,255,0.06)); box-shadow:0 10px 30px rgba(0,0,0,.25) inset}
  .white{position:relative; width:var(--key-w); height:var(--key-h); background:linear-gradient(#ffffff,#eef2f6); border:1px solid #cbd2da; border-bottom-width:4px; border-radius:0 0 10px 10px; display:flex; align-items:center; justify-content:center; font-size:12px; user-select:none; cursor:pointer; z-index:1; color:#111; transition:transform .03s ease, filter .15s ease}
  .white:hover{filter:brightness(1.04)}
  .white:active{transform:translateY(1px)}
  .white.active{background:#e7f0ff; border-color:#8db9ff}
  .black{position:absolute; top:10px; width:var(--black-w); height:var(--black-h); background:linear-gradient(#222,#050505); border:1px solid #000; border-bottom-width:4px; border-radius:0 0 8px 8px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:10px; user-select:none; cursor:pointer; z-index:3; box-shadow:0 10px 18px rgba(0,0,0,0.35); transition:transform .03s ease, filter .15s ease}
  .black:hover{filter:brightness(1.1)}
  .black:active{transform:translateY(1px)}
  .black.active{background:#333}
  .note{position:absolute; bottom:10px; font-size:12px; color:#333}
  .hint{position:absolute; top:6px; left:6px; font-size:10px; color:#eee; background:#222; border:1px solid #333; padding:1px 5px; border-radius:6px; pointer-events:none}
  .white .hint{color:#555; background:#eef2f7; border-color:#d9dee5}

  /* History panel */
  .history{min-width:260px; max-width:340px; height:calc(var(--key-h) + 24px); border:2px solid var(--c64-border); border-radius:12px; padding:10px; background:linear-gradient(180deg, rgba(0,0,0,0.08), rgba(255,255,255,0.04)); display:flex; flex-direction:column; box-shadow:0 10px 24px rgba(0,0,0,0.25) inset}
  .historyHeader{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
  .historyTitle{font-size:13px; font-weight:800}
  .histList{flex:1; overflow:auto; background:rgba(0,0,0,0.06); border:1px solid var(--c64-border); border-radius:8px; padding:6px}
  .histRow{display:grid; grid-template-columns:64px 1fr 64px; gap:6px; font-size:12px; padding:4px 6px; border-bottom:1px dotted rgba(169,187,255,0.5)}
  .histRow:last-child{border-bottom:none}

  #unlock{position:fixed; inset:0; background:rgba(59,93,201,.96); display:flex; align-items:center; justify-content:center; z-index:9999}
  #unlock button{font-size:16px; padding:12px 18px; border-radius:8px; border:2px solid var(--c64-border); background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0.12)); color:var(--c64-text); cursor:pointer}

  /* Drum machine */
  .drums{display:grid; grid-template-columns:180px repeat(16,1fr); gap:8px; align-items:center}
  .drums .hdr{font-size:12px; color:var(--c64-text); text-align:center}
  .rowLbl{display:flex; gap:8px; align-items:center}
  .rowLbl .keytag{font-size:11px; background:#111; color:#fff; border-radius:6px; padding:2px 6px; box-shadow:0 1px 0 rgba(255,255,255,0.06) inset}
  .step{width:28px; height:28px; border:1px solid var(--c64-border); border-radius:8px; background:linear-gradient(180deg, rgba(169,187,255,0.2), rgba(20,30,90,0.25)); display:grid; place-items:center; cursor:pointer; transition:filter .15s ease, transform .05s ease}
  .step:hover{filter:brightness(1.1)}
  .step:active{transform:translateY(1px)}
  .step.on{background:linear-gradient(180deg, rgba(169,187,255,0.45), rgba(20,30,90,0.35))}
  .colHdr{font-size:10px; color:#cfd7ff; text-align:center}
  .playing{box-shadow:0 0 0 2px #222 inset, 0 0 12px var(--glow)}
  .transport{display:flex; gap:10px; align-items:center; margin-top:10px}

  /* Responsive tweaks */
  @media (max-width: 980px){ :root{ --key-w:54px; --key-h:200px; } .drums{grid-template-columns:140px repeat(16,1fr)} }
  @media (max-width: 760px){ :root{ --key-w:46px; --key-h:180px; --black-w:32px; --black-h:116px; } .drums{grid-template-columns:110px repeat(16,1fr)} }
  @media (max-width: 560px){ :root{ --key-w:40px; --key-h:160px; --black-w:28px; --black-h:100px; } }
</style>
</head>
<body>
<div id="unlock"><button id="unlockBtn" title="Browsers block audio until a user gesture. Click once to enable sound.">CLICK OR PRESS ANY KEY TO ENABLE SOUND</button></div>

<div class="panel">
  <div class="title">C64 Piano — Controls</div>

  <!-- Waveform controls: buttons + presets + visual -->
  <div class="row">
    <div class="seg" id="waveBtns" title="Select waveform">
      <button class="segBtn active" data-wave="pulse" aria-pressed="true" title="Pulse (square)">
        <svg viewBox="0 0 40 20"><path d="M1 10 H10 V2 H22 V18 H34 V10 H39"/></svg> Pulse
      </button>
      <button class="segBtn" data-wave="sawtooth" title="Sawtooth">
        <svg viewBox="0 0 40 20"><path d="M1 18 L13 2 L25 18 L37 2"/></svg> Saw
      </button>
      <button class="segBtn" data-wave="triangle" title="Triangle">
        <svg viewBox="0 0 40 20"><path d="M1 18 L13 2 L25 18 L37 2"/></svg> Tri
      </button>
      <button class="segBtn" data-wave="noise" title="Noise">
        <svg viewBox="0 0 40 20"><path d="M1 10 L5 6 L9 14 L13 8 L17 12 L21 5 L25 15 L29 7 L33 11 L37 4"/></svg> Noise
      </button>
    </div>
    <label title="Wave-specific preset">
      Preset
      <select id="wavePreset"></select>
    </label>
    <div class="miniWrap">
      <canvas id="waveVis" class="mini" width="300" height="80" title="Waveform view"></canvas>
    </div>
  </div>

  <!-- Mod + vibrato + octave -->
  <div class="row">
    <label title="Pulse width (duty cycle). 0.5 = classic square.">P.W. <input id="sidPW" type="range" min="0.05" max="0.95" step="0.01" value="0.5"></label>
    <label title="Pulse width modulation rate in Hz.">PWM Rate <input id="sidPWMRate" type="range" min="0" max="12" step="0.1" value="3"></label>
    <label title="Pulse width modulation depth.">PWM Depth <input id="sidPWMDepth" type="range" min="0" max="0.45" step="0.01" value="0.25"></label>
    <label title="Vibrato speed in Hz.">Vibrato Hz <input id="vibRate" type="range" min="0" max="12" step="0.1" value="5"></label>
    <label title="Vibrato depth in cents (100 = 1 semitone).">Vibrato Amt <input id="vibAmt" type="range" min="0" max="50" step="1" value="8"></label>
    <span class="pill" id="octPill" title=", lowers octave, . raises octave">Octave: <span id="octDisp">0</span>  &nbsp; (&lt; / &gt;)</span>
    <button class="btn" id="octDown" title="Octave down (,)">−</button>
    <button class="btn" id="octUp" title="Octave up (.)">＋</button>
  </div>

  <!-- ADSR + presets + visual -->
  <div class="row">
    <label title="Attack time (ms).">A <input id="sidA" type="range" min="0" max="200" step="1" value="8"></label>
    <label title="Decay time (ms).">D <input id="sidD" type="range" min="0" max="600" step="5" value="120"></label>
    <label title="Sustain level (0–1).">S <input id="sidS" type="range" min="0" max="1" step="0.01" value="0.5"></label>
    <label title="Release time (ms).">R <input id="sidR" type="range" min="0" max="1200" step="10" value="240"></label>
    <label title="ADSR preset">
      ADSR Preset
      <select id="adsrPreset"></select>
    </label>
    <div class="miniWrap">
      <canvas id="adsrVis" class="mini" width="260" height="80" title="ADSR envelope"></canvas>
    </div>
  </div>

  <!-- Arp + Filter buttons + presets + visual -->
  <div class="row">
    <label title="Chord-like fast note cycling.">Arp
      <select id="arp" title="Arpeggiator pattern">
        <option value="off" selected>Off</option>
        <option value="maj">Maj (0,4,7)</option>
        <option value="min">Min (0,3,7)</option>
        <option value="pwr">Power (0,7,12)</option>
      </select>
    </label>
    <label title="Arpeggiator rate (steps per second).">Arp Rate <input id="arpRate" type="range" min="4" max="24" step="1" value="12"></label>

    <div class="seg" id="filterBtns" title="Filter type">
      <button class="segBtn active" data-filter="lowpass" title="Low‑pass">
        <svg viewBox="0 0 40 20"><path d="M1 18 C12 6, 18 4, 39 4"/></svg> LP
      </button>
      <button class="segBtn" data-filter="bandpass" title="Band‑pass">
        <svg viewBox="0 0 40 20"><path d="M1 18 C10 18, 15 4, 20 4 C25 4, 30 18, 39 18"/></svg> BP
      </button>
      <button class="segBtn" data-filter="highpass" title="High‑pass">
        <svg viewBox="0 0 40 20"><path d="M1 18 C12 18, 18 16, 39 4"/></svg> HP
      </button>
      <button class="segBtn" data-filter="off" title="No filter">
        <svg viewBox="0 0 40 20"><path d="M1 10 H39"/><path d="M4 2 L36 18"/></svg> Off
      </button>
    </div>
    <label title="Filter preset">
      Filter Preset
      <select id="filterPreset"></select>
    </label>
    <label title="Filter cutoff frequency.">Cutoff <input id="sidCutoff" type="range" min="200" max="8000" step="1" value="1700"></label>
    <label title="Filter resonance (Q).">Res (Q) <input id="sidRes" type="range" min="0.1" max="18" step="0.1" value="5"></label>
    <label title="Adds 8‑bit style grit using a waveshaper.">Bit‑crush <input id="crush" type="checkbox" checked></label>
    <label title="Master output volume.">Volume <input id="master" type="range" min="0" max="1" step="0.01" value="0.8"></label>
    <div class="miniWrap">
      <canvas id="filterVis" class="mini" width="300" height="80" title="Filter magnitude"></canvas>
    </div>
  </div>

  <div style="margin-top:8px;font-size:12px">Keys: A S D F G H J K (white) and W E T Y U (black). Octave with , and . (display shows &lt; / &gt;).</div>
</div>

<div class="panel">
  <div class="title">C64 Piano — Keyboard</div>
  <div class="kbdWrap">
    <div class="kbd" id="kbd">
      <div class="white" data-note="C" data-key="A"><span class="note">C</span><span class="hint" title="Press A">A</span></div>
      <div class="white" data-note="D" data-key="S"><span class="note">D</span><span class="hint" title="Press S">S</span></div>
      <div class="white" data-note="E" data-key="D"><span class="note">E</span><span class="hint" title="Press D">D</span></div>
      <div class="white" data-note="F" data-key="F"><span class="note">F</span><span class="hint" title="Press F">F</span></div>
      <div class="white" data-note="G" data-key="G"><span class="note">G</span><span class="hint" title="Press G">G</span></div>
      <div class="white" data-note="A" data-key="H"><span class="note">A</span><span class="hint" title="Press H">H</span></div>
      <div class="white" data-note="B" data-key="J"><span class="note">B</span><span class="hint" title="Press J">J</span></div>
      <div class="white" data-note="C2" data-key="K"><span class="note">C</span><span class="hint" title="Press K">K</span></div>
      <div class="black" data-note="C#" data-key="W" style="left:calc(var(--key-w) - var(--black-w)/2)"><span class="hint" title="Press W">W</span></div>
      <div class="black" data-note="D#" data-key="E" style="left:calc(var(--key-w)*2 - var(--black-w)/2)"><span class="hint" title="Press E">E</span></div>
      <div class="black" data-note="F#" data-key="T" style="left:calc(var(--key-w)*4 - var(--black-w)/2)"><span class="hint" title="Press T">T</span></div>
      <div class="black" data-note="G#" data-key="Y" style="left:calc(var(--key-w)*5 - var(--black-w)/2)"><span class="hint" title="Press Y">Y</span></div>
      <div class="black" data-note="A#" data-key="U" style="left:calc(var(--key-w)*6 - var(--black-w)/2)"><span class="hint" title="Press U">U</span></div>
    </div>

    <div class="history">
      <div class="historyHeader">
        <div class="historyTitle">Played Notes</div>
        <div style="display:flex;gap:6px">
          <button class="btn" id="replayBtn" title="Replay the recorded notes in sequence">Replay</button>
          <button class="btn" id="clearBtn" title="Clear the note history">Clear</button>
        </div>
      </div>
      <div class="histList" id="histList" aria-live="polite"></div>
    </div>
  </div>
</div>

<div class="panel">
  <div class="title">C64‑style Drum Machine</div>
  <div class="drums" id="drums"></div>
  <div class="transport">
    <button class="btn" id="playBtn" title="Start the 16‑step sequencer">Play</button>
    <button class="btn" id="stopBtn" title="Stop and clear the playhead highlight">Stop</button>
    <label title="Beats per minute. 16th notes are steps.">Tempo <input id="bpm" type="range" min="60" max="180" step="1" value="120"></label>
    <span style="font-size:12px;opacity:.9">Trigger now: Z/X/C/V</span>
  </div>
</div>

<script>
// === Audio setup ===
const AudioContext = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioContext({ latencyHint: 'interactive' });
function ensureAudio(){ if(ctx.state!=='running') ctx.resume(); }
const master = ctx.createGain(); master.gain.value = 0.8; master.connect(ctx.destination);

// Unlock overlay – remove on first gesture (also resumes)
const unlockEl = document.getElementById('unlock');
function removeUnlock(){ if(unlockEl && unlockEl.parentNode){ unlockEl.parentNode.removeChild(unlockEl); } }
async function unlockAudio(){ try{ await ctx.resume(); }catch{} if(ctx.state==='running'){ removeUnlock(); } }
window.addEventListener('pointerdown', unlockAudio); window.addEventListener('keydown', unlockAudio);
document.getElementById('unlockBtn').addEventListener('click', unlockAudio);
if (unlockEl) unlockEl.addEventListener('click', unlockAudio);

const get = (id)=>document.getElementById(id);
function valNum(id, fallback=0){ const el=get(id); return el?parseFloat(el.value):fallback; }

// Bit‑crusher flavor (8‑bit)
function makeCrusher(bits=8){ const steps = 2**bits; const curve = new Float32Array(65536); for(let i=0;i<curve.length;i++){ const x=i/65535*2-1; const q=Math.round((x*0.5+0.5)*(steps-1))/(steps-1); curve[i]=(q-0.5)*2;} const sh=ctx.createWaveShaper(); sh.curve=curve; sh.oversample='4x'; return sh; }
let crusher = makeCrusher(8);

// Base note frequencies (A4=440)
const baseFreq = { 'C':261.63,'C#':277.18,'D':293.66,'D#':311.13,'E':329.63,'F':349.23,'F#':369.99,'G':392.00,'G#':415.30,'A':440.00,'A#':466.16,'B':493.88,'C2':523.25 };
let octave = 0; // -3..+3
const octDisp = get('octDisp'); const octPill = get('octPill');
function updateOct(n){ octave = Math.max(-3, Math.min(3, n)); if(octDisp) octDisp.textContent = octave; if(octPill){ octPill.classList.add('glow'); setTimeout(()=>octPill.classList.remove('glow'), 160); } }
get('octDown').addEventListener('click', ()=>updateOct(octave-1));
get('octUp').addEventListener('click', ()=>updateOct(octave+1));

function freqFor(note){ return (typeof note === 'number') ? note : baseFreq[note] * Math.pow(2, octave); }

// Pulse PeriodicWave
function makePulseWave(duty=0.5, harmonics=64){ duty=Math.min(0.98,Math.max(0.02,duty)); const real=new Float32Array(harmonics+1), imag=new Float32Array(harmonics+1); for(let n=1;n<=harmonics;n++){ const a=(1/(n*Math.PI))*(Math.sin(n*Math.PI*duty)*2); imag[n]=a; } return ctx.createPeriodicWave(real,imag,{disableNormalization:true}); }

// ======= State & Presets =======
const state = {
  wave: 'pulse',
  filter: 'lowpass'
};

const wavePresets = {
  pulse: {
    'Init': { pw:0.5, pwmRate:0, pwmDepth:0, vibRate:0, vibAmt:0 },
    'PWM Lead': { pw:0.5, pwmRate:3, pwmDepth:0.25, vibRate:5, vibAmt:8 },
    'Chiptune Bass': { pw:0.25, pwmRate:0.6, pwmDepth:0.08, vibRate:0, vibAmt:0 },
    'Detuned PWM': { pw:0.45, pwmRate:5, pwmDepth:0.35, vibRate:7, vibAmt:12 },
  },
  sawtooth: {
    'Init': { vibRate:0, vibAmt:0 },
    'SID Brass': { vibRate:5, vibAmt:10 },
    'Razor Lead': { vibRate:7, vibAmt:14 },
  },
  triangle: {
    'Init': { vibRate:0, vibAmt:0 },
    'Soft Bell': { vibRate:5, vibAmt:6 },
    'Flute': { vibRate:6, vibAmt:8 },
  },
  noise: {
    'Init': {},
    'Hi‑Hat': {},
    'Snare': {},
  }
};

const filterPresets = {
  'Bright LP': { type:'lowpass', cutoff:4000, res:2 },
  'Muffled': { type:'lowpass', cutoff:800, res:1.2 },
  'Nasal BP': { type:'bandpass', cutoff:1500, res:8 },
  'Thin HP': { type:'highpass', cutoff:1200, res:1.5 },
  'Off': { type:'off' }
};

const adsrPresets = {
  'Pluck': { A:5, D:120, S:0.2, R:120 },
  'Lead':  { A:8, D:140, S:0.5, R:220 },
  'Pad':   { A:40, D:400, S:0.7, R:600 },
  'Bass':  { A:3, D:100, S:0.3, R:80 }
};

function setWaveButtons(type){
  document.querySelectorAll('#waveBtns .segBtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.wave===type);
    b.setAttribute('aria-pressed', b.dataset.wave===type);
  });
  state.wave = type;
  populateWavePresets();
  updateWaveVis();
  // enable/disable PW controls for non-pulse
  const pulseOnly = ['sidPW','sidPWMRate','sidPWMDepth'];
  pulseOnly.forEach(id=>{ const el=get(id); if(!el) return; el.disabled = (type!=='pulse'); el.parentElement.style.opacity = el.disabled?0.5:1; });
}

function populateWavePresets(){
  const sel = get('wavePreset');
  sel.innerHTML='';
  const list = wavePresets[state.wave] || { 'Init':{} };
  Object.keys(list).forEach(name=>{
    const o=document.createElement('option'); o.textContent=name; sel.appendChild(o);
  });
  sel.value = Object.keys(list)[0] || 'Init';
}

function applyWavePreset(){
  const sel = get('wavePreset'); const p = (wavePresets[state.wave]||{})[sel.value]||{};
  if(p.pw!=null) get('sidPW').value=p.pw;
  if(p.pwmRate!=null) get('sidPWMRate').value=p.pwmRate;
  if(p.pwmDepth!=null) get('sidPWMDepth').value=p.pwmDepth;
  if(p.vibRate!=null) get('vibRate').value=p.vibRate;
  if(p.vibAmt!=null) get('vibAmt').value=p.vibAmt;
  updateWaveVis();
}

function setFilterButtons(type){
  document.querySelectorAll('#filterBtns .segBtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.filter===type);
  });
  state.filter = type;
  updateFilterVis();
}

function populateFilterPresets(){
  const sel=get('filterPreset'); sel.innerHTML='';
  Object.keys(filterPresets).forEach(name=>{ const o=document.createElement('option'); o.textContent=name; sel.appendChild(o); });
}
function applyFilterPreset(){
  const sel=get('filterPreset'); const p=filterPresets[sel.value]; if(!p) return;
  state.filter = p.type;
  if(p.cutoff!=null) get('sidCutoff').value=p.cutoff;
  if(p.res!=null) get('sidRes').value=p.res;
  setFilterButtons(state.filter);
  updateFilterVis();
}

function populateADSRPresets(){
  const sel=get('adsrPreset'); sel.innerHTML='';
  Object.keys(adsrPresets).forEach(name=>{ const o=document.createElement('option'); o.textContent=name; sel.appendChild(o); });
}
function applyADSRPreset(){
  const sel=get('adsrPreset'); const p=adsrPresets[sel.value]; if(!p) return;
  get('sidA').value=p.A; get('sidD').value=p.D; get('sidS').value=p.S; get('sidR').value=p.R;
  updateADSRVis();
}

// ======= Visuals =======
function clearCanvas(c){ const g=c.getContext('2d'); g.clearRect(0,0,c.width,c.height); return g; }

function updateWaveVis(){
  const c=get('waveVis'); if(!c) return; const g=clearCanvas(c); const w=c.width, h=c.height; g.strokeStyle='#d6e0ff'; g.lineWidth=2; g.beginPath();
  const wave=state.wave; const pw=parseFloat(get('sidPW').value);
  if(wave==='pulse'){
    const y1=10, y2=h-10; const midX=w*pw; g.moveTo(5,(y1+y2)/2); g.lineTo(midX, y1); g.lineTo(midX, y2); g.lineTo(w-5, y2); 
  } else if(wave==='sawtooth'){
    g.moveTo(5,h-10); g.lineTo(w-5,10); g.moveTo(5,h-10); g.lineTo(5,10);
  } else if(wave==='triangle'){
    g.moveTo(5,h-10); g.lineTo(w*0.5,10); g.lineTo(w-5,h-10);
  } else { // noise
    g.moveTo(5, h/2);
    for(let x=5;x<=w-5;x+=4){ const y=10 + Math.random()*(h-20); g.lineTo(x,y); }
  }
  g.stroke();
}

function updateFilterVis(){
  const c=get('filterVis'); if(!c) return; const g=clearCanvas(c); const w=c.width, h=c.height; g.strokeStyle='#d6e0ff'; g.lineWidth=2;
  if(state.filter==='off'){ g.beginPath(); g.moveTo(5,h/2); g.lineTo(w-5,h/2); g.stroke(); return; }
  const biq=ctx.createBiquadFilter(); biq.type=state.filter; biq.Q.value=valNum('sidRes',5); biq.frequency.value=valNum('sidCutoff',1700);
  const N=256; const freq=new Float32Array(N); const mag=new Float32Array(N); const phase=new Float32Array(N);
  const ny=ctx.sampleRate/2; for(let i=0;i<N;i++){ const f=20*Math.pow( (ny/20), i/(N-1) ); freq[i]=f; }
  biq.getFrequencyResponse(freq,mag,phase);
  g.beginPath();
  for(let i=0;i<N;i++){
    const db = 20*Math.log10(mag[i]||1e-6);
    const x = 5 + (w-10)*i/(N-1);
    const y = h-10 - ( (db+40)/60 )*(h-20); // map -40..+20 dB
    if(i===0) g.moveTo(x,y); else g.lineTo(x,y);
  }
  g.stroke();
}

function updateADSRVis(){
  const c=get('adsrVis'); if(!c) return; const g=clearCanvas(c); const w=c.width, h=c.height; g.strokeStyle='#d6e0ff'; g.lineWidth=2;
  const A=valNum('sidA',8), D=valNum('sidD',120), S=valNum('sidS',0.5), R=valNum('sidR',240);
  const total = A + D + 200 + R; // include a hold segment
  const x0=10, x1=x0 + (w-20)*(A/total), x2=x1 + (w-20)*(D/total), x3=x2 + (w-20)*(200/total), x4=w-10;
  const y0=h-10, y1=10, yS = 10 + (1-S)*(h-20);
  g.beginPath(); g.moveTo(x0,y0); g.lineTo(x1,y1); g.lineTo(x2,yS); g.lineTo(x3,yS); g.lineTo(x4,h-10);
  g.stroke();
}

// ======= Synth voice =======
function createSIDVoice(note){
  ensureAudio();
  const now=ctx.currentTime; const f=freqFor(note);
  const waveSel=state.wave; const cutoff=valNum('sidCutoff',1700); const res=valNum('sidRes',5);
  const A=valNum('sidA',8)/1000, D=valNum('sidD',120)/1000, S=valNum('sidS',0.5), R=valNum('sidR',240)/1000;
  const vibRate=valNum('vibRate',5), vibAmt=valNum('vibAmt',8); const filterMode=state.filter; const crushOn=(get('crush')?get('crush').checked:false); const pwBase=valNum('sidPW',0.5), pwmRate=valNum('sidPWMRate',3), pwmDepth=valNum('sidPWMDepth',0.25);

  let source, osc, noise;
  if(waveSel==='noise'){
    const len=2048, buf=ctx.createBuffer(1,len,ctx.sampleRate), d=buf.getChannelData(0); for(let i=0;i<len;i++) d[i]=Math.random()*2-1; noise=ctx.createBufferSource(); noise.buffer=buf; noise.loop=true; noise.playbackRate.value=f/440; source=noise;
  } else { osc=ctx.createOscillator(); if(waveSel==='pulse') osc.setPeriodicWave(makePulseWave(pwBase)); else osc.type=waveSel; osc.frequency.setValueAtTime(f,now); source=osc; }

  // Build graph with optional filter
  const vca=ctx.createGain(); vca.gain.setValueAtTime(0,now);
  if(filterMode!=='off'){
    const vcf = ctx.createBiquadFilter(); vcf.type=filterMode; vcf.Q.value=res; vcf.frequency.setValueAtTime(cutoff,now);
    source.connect(vcf); vcf.connect(vca);
  } else {
    source.connect(vca);
  }
  if(crushOn){ vca.connect(crusher); crusher.connect(master);} else { vca.connect(master); }

  // Envelope
  vca.gain.setValueAtTime(0,now); vca.gain.linearRampToValueAtTime(1,now+A); vca.gain.linearRampToValueAtTime(S,now+A+D);

  // PWM
  let pwmTimer=null, currentPW=pwBase; if(osc && waveSel==='pulse'){ const start=now; pwmTimer=setInterval(()=>{ const t=ctx.currentTime-start; const d=Math.max(0.02,Math.min(0.98,pwBase+pwmDepth*Math.sin(2*Math.PI*pwmRate*t))); if(Math.abs(d-currentPW)>0.004){ currentPW=d; osc.setPeriodicWave(makePulseWave(currentPW)); } },16); }
  // Vibrato
  let vib=null; if(osc && vibAmt>0 && vibRate>0){ vib=ctx.createOscillator(); vib.type='sine'; vib.frequency.value=vibRate; const g=ctx.createGain(); g.gain.value=vibAmt; vib.connect(g); g.connect(osc.detune); vib.start(now); }
  // Arpeggiator
  let arpTimer=null; const arpMode=(get('arp')?get('arp').value:'off'); const arpRate=valNum('arpRate',12); const arpPatterns={off:[0], maj:[0,4,7], min:[0,3,7], pwr:[0,7,12]};
  if(osc && arpPatterns[arpMode] && arpPatterns[arpMode].length>1){ let idx=0; const interval=Math.max(20, 1000*(1/arpRate)); arpTimer=setInterval(()=>{ const semis=arpPatterns[arpMode][idx%arpPatterns[arpMode].length]; const ff=f*Math.pow(2, semis/12); osc.frequency.setValueAtTime(ff, ctx.currentTime); idx++; }, interval); }

  source.start(now);
  return { stop:()=>{ const t=ctx.currentTime; vca.gain.setTargetAtTime(0.0001,t,Math.max(0.01,R)); source.stop(t+R+0.03); if(pwmTimer) clearInterval(pwmTimer); if(vib) vib.stop(t+0.01); if(arpTimer) clearInterval(arpTimer); } };
}

// === Piano UI wiring + history ===
const whites=document.querySelectorAll('.white'); const blacks=document.querySelectorAll('.black');
const active=new Map(); const keyMap={}; [...whites,...blacks].forEach(k=>{ const kk=k.dataset.key; if(kk) keyMap[kk.toLowerCase()]=k; });

// History state
let history=[];               // {note, freq, oct, t0, t1, dur}
const activeHist=new Map();   // el -> index
const histList = document.getElementById('histList');

function fmtTime(sec){ return (sec).toFixed(3)+'s'; }
function fmtNote(n, o){ return n + (o>0? ('+'+o) : (o<0? o : '')); }
function renderRow(i){ const h=history[i]; const baseT=(history[0]?history[0].t0:h.t0); const rel=h.t0-baseT; const row=document.createElement('div'); row.className='histRow'; row.id='hist-'+i; row.innerHTML=`<div>${fmtTime(rel)}</div><div>${fmtNote(h.note,h.oct)}</div><div class="dur">${h.dur?fmtTime(h.dur):''}</div>`; histList.appendChild(row); histList.scrollTop=histList.scrollHeight; }
function updateRow(i){ const row=document.getElementById('hist-'+i); if(!row) return; const durEl=row.querySelector('.dur'); const h=history[i]; if(durEl) durEl.textContent=h.dur?fmtTime(h.dur):''; }

function noteOn(el){ const n=el.dataset.note; const v=createSIDVoice(n); active.set(el,v); el.classList.add('active'); // history add
  const entry={ note:n, freq:freqFor(n), oct:octave, t0:ctx.currentTime, t1:null, dur:null }; const idx=history.push(entry)-1; activeHist.set(el, idx); renderRow(idx); }
function noteOff(el){ const v=active.get(el); if(v){ v.stop(); active.delete(el);} el.classList.remove('active'); const idx=activeHist.get(el); if(idx!=null){ history[idx].t1=ctx.currentTime; history[idx].dur=Math.max(0.01, history[idx].t1-history[idx].t0); updateRow(idx); activeHist.delete(el);} }

whites.forEach(w=>{ w.addEventListener('mousedown',e=>{ if(e.button!==0) return; noteOn(w); }); w.addEventListener('mouseup',()=>noteOff(w)); w.addEventListener('mouseleave',()=>noteOff(w)); w.addEventListener('touchstart',e=>{ e.preventDefault(); noteOn(w); },{passive:false}); w.addEventListener('touchend',e=>{ e.preventDefault(); noteOff(w); },{passive:false}); });
blacks.forEach(b=>{ const down=e=>{ e.stopPropagation(); if(e.type==='mousedown'&&e.button!==0) return; noteOn(b); }; const up=e=>{ e.stopPropagation(); noteOff(b); }; b.addEventListener('mousedown',down); b.addEventListener('mouseup',up); b.addEventListener('mouseleave',up); b.addEventListener('touchstart',e=>{ e.preventDefault(); e.stopPropagation(); noteOn(b); },{passive:false}); b.addEventListener('touchend',e=>{ e.preventDefault(); e.stopPropagation(); noteOff(b); },{passive:false}); });

const pressed=new Set();
document.addEventListener('keydown',e=>{
  // octave keys: , and . (also accept < and >)
  if(e.key===',' || e.key=='<'){ updateOct(octave-1); return; }
  if(e.key==='.' || e.key==='>'){ updateOct(octave+1); return; }
  const key=e.key.toLowerCase(); if(pressed.has(key)) return; const el=keyMap[key]; if(el){ pressed.add(key); noteOn(el);} 
});
document.addEventListener('keyup',e=>{ const key=e.key.toLowerCase(); const el=keyMap[key]; if(el){ noteOff(el);} pressed.delete(key); });

get('master').addEventListener('input', e=>{ master.gain.value=parseFloat(e.target.value); });

document.getElementById('replayBtn').addEventListener('click',()=>{
  if(history.length===0) return; const baseT=history[0].t0; const startAt=ctx.currentTime+0.05; history.forEach(h=>{ const when=startAt + (h.t0-baseT); const dur=(h.dur||0.15); setTimeout(()=>{ const voice=createSIDVoice(h.freq); setTimeout(()=>voice.stop(), dur*1000); }, Math.max(0, (when-ctx.currentTime)*1000)); });
});
document.getElementById('clearBtn').addEventListener('click',()=>{ history=[]; histList.innerHTML=''; activeHist.clear(); });

// ======= Drum machine =======
const drumGrid=get('drums');
const steps=16; const rowInstruments=['Snare','Kick','Hat','Tom'];
const instruments=['Kick','Snare','Hat','Tom','Clap','Cowbell'];
const pattern={0:Array(steps).fill(false),1:Array(steps).fill(false),2:Array(steps).fill(false),3:Array(steps).fill(false)};

function buildGrid(){
  drumGrid.innerHTML='';
  // Header
  drumGrid.appendChild(Object.assign(document.createElement('div'),{className:'hdr'}));
  for(let i=0;i<steps;i++){ const h=document.createElement('div'); h.className='hdr colHdr'; h.textContent=(i+1); drumGrid.appendChild(h); }
  // Rows
  for(let r=0;r<4;r++){
    const left=document.createElement('div'); left.className='rowLbl';
    const tag=document.createElement('span'); tag.className='keytag'; tag.textContent=['Z','X','C','V'][r]; left.appendChild(tag);
    const sel=document.createElement('select'); sel.className='drumSel'; sel.title='Choose the drum sound for this row'; instruments.forEach(n=>{ const o=document.createElement('option'); o.textContent=n; if(n===rowInstruments[r]) o.selected=true; sel.appendChild(o); }); sel.addEventListener('change',()=>{ rowInstruments[r]=sel.value; }); left.appendChild(sel);
    drumGrid.appendChild(left);
    for(let i=0;i<steps;i++){ const cell=document.createElement('div'); cell.className='step'; cell.title=`Step ${i+1} (click to toggle)`; if(pattern[r][i]) cell.classList.add('on'); cell.addEventListener('click',()=>{ pattern[r][i]=!pattern[r][i]; cell.classList.toggle('on'); }); drumGrid.appendChild(cell); }
  }
}
buildGrid();

// Drum synths
function playKick(t){ const o=ctx.createOscillator(); o.type='triangle'; const g=ctx.createGain(); g.gain.setValueAtTime(1,t); o.frequency.setValueAtTime(160,t); o.frequency.exponentialRampToValueAtTime(45,t+0.12); g.gain.exponentialRampToValueAtTime(0.001,t+0.18); o.connect(g); g.connect(master); o.start(t); o.stop(t+0.2); }
function playSnare(t){ const len=2048, buf=ctx.createBuffer(1,len,ctx.sampleRate), d=buf.getChannelData(0); for(let i=0;i<len;i++) d[i]=Math.random()*2-1; const n=ctx.createBufferSource(); n.buffer=buf; n.loop=true; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=800; const g=ctx.createGain(); g.gain.setValueAtTime(0.9,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.15); n.connect(hp); hp.connect(g); g.connect(master); n.start(t); n.stop(t+0.16); }
function playHat(t){ const len=2048, buf=ctx.createBuffer(1,len,ctx.sampleRate), d=buf.getChannelData(0); for(let i=0;i<len;i++) d[i]=Math.random()*2-1; const n=ctx.createBufferSource(); n.buffer=buf; n.loop=true; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000; const g=ctx.createGain(); g.gain.setValueAtTime(0.7,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.07); n.connect(hp); hp.connect(g); g.connect(master); n.start(t); n.stop(t+0.08); }
function playTom(t){ const o=ctx.createOscillator(); o.type='triangle'; const g=ctx.createGain(); g.gain.setValueAtTime(1,t); o.frequency.setValueAtTime(220,t); o.frequency.exponentialRampToValueAtTime(120,t+0.12); g.gain.exponentialRampToValueAtTime(0.001,t+0.18); o.connect(g); g.connect(master); o.start(t); o.stop(t+0.2); }
function playClap(t){ const bursts=[0,0.02,0.04]; bursts.forEach((dly)=>{ const len=2048, buf=ctx.createBuffer(1,len,ctx.sampleRate), data=buf.getChannelData(0); for(let i=0;i<len;i++) data[i]=Math.random()*2-1; const n=ctx.createBufferSource(); n.buffer=buf; n.loop=true; const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2000; bp.Q.value=0.7; const g=ctx.createGain(); g.gain.setValueAtTime(0.7,t+dly); g.gain.exponentialRampToValueAtTime(0.001,t+dly+0.08); n.connect(bp); bp.connect(g); g.connect(master); n.start(t+dly); n.stop(t+dly+0.09); }); }
function playCowbell(t){ const o1=ctx.createOscillator(), o2=ctx.createOscillator(); o1.type=o2.type='square'; o1.frequency.setValueAtTime(560,t); o2.frequency.setValueAtTime(845,t); const g=ctx.createGain(); g.gain.setValueAtTime(0.8,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.2); o1.connect(g); o2.connect(g); g.connect(master); o1.start(t); o2.start(t); o1.stop(t+0.22); o2.stop(t+0.22); }
function triggerDrum(name,t){ ({Kick:playKick,Snare:playSnare,Hat:playHat,Tom:playTom,Clap:playClap,Cowbell:playCowbell}[name] || playKick)(t); }

let isPlaying=false, currStep=0, schedId=null, lastSchedule=0;
function schedule(){ const bpm=valNum('bpm',120); const secPerStep=(60/bpm)/4; const lookahead=0.1; const now=ctx.currentTime; while(lastSchedule < now+lookahead){ for(let r=0;r<4;r++){ if(pattern[r][currStep]) triggerDrum(rowInstruments[r], lastSchedule); } // highlight
 const cells=drumGrid.querySelectorAll('.step'); cells.forEach((c,i)=>{ const col=i%steps; c.classList.toggle('playing', col===currStep); }); currStep=(currStep+1)%steps; lastSchedule+=secPerStep; } }
function start(){ if(isPlaying) return; isPlaying=true; currStep=0; lastSchedule=ctx.currentTime; schedId=setInterval(schedule,25); }
function stop(){ if(!isPlaying) return; isPlaying=false; clearInterval(schedId); schedId=null; drumGrid.querySelectorAll('.step').forEach(c=>c.classList.remove('playing')); }

document.getElementById('playBtn').addEventListener('click',start); document.getElementById('stopBtn').addEventListener('click',stop);

// Keyboard triggers for drums
const drumKeyMap={z:0,x:1,c:2,v:3};
document.addEventListener('keydown',e=>{ const k=e.key.toLowerCase(); if(drumKeyMap.hasOwnProperty(k)){ triggerDrum(['Kick','Snare','Hat','Tom','Clap','Cowbell'].includes(rowInstruments[drumKeyMap[k]])?rowInstruments[drumKeyMap[k]]:'Kick', ctx.currentTime); }});

// ======= Wire up segmented controls & presets =======
// Wave buttons
Array.from(document.querySelectorAll('#waveBtns .segBtn')).forEach(btn=>{
  btn.addEventListener('click', ()=>{ setWaveButtons(btn.dataset.wave); });
});
populateWavePresets();
get('wavePreset').addEventListener('change', applyWavePreset);
applyWavePreset();

// Filter buttons
Array.from(document.querySelectorAll('#filterBtns .segBtn')).forEach(btn=>{
  btn.addEventListener('click', ()=>{ setFilterButtons(btn.dataset.filter); });
});
populateFilterPresets();
get('filterPreset').addEventListener('change', applyFilterPreset);
updateFilterVis();

// ADSR presets
populateADSRPresets();
get('adsrPreset').addEventListener('change', applyADSRPreset);
updateADSRVis();

// Live updates -> visuals
['sidPW','sidPWMRate','sidPWMDepth','vibRate','vibAmt'].forEach(id=>{ const el=get(id); if(el) el.addEventListener('input', updateWaveVis); });
['sidCutoff','sidRes'].forEach(id=>{ const el=get(id); if(el) el.addEventListener('input', updateFilterVis); });
['sidA','sidD','sidS','sidR'].forEach(id=>{ const el=get(id); if(el) el.addEventListener('input', updateADSRVis); });

// Initial visuals
updateWaveVis(); updateFilterVis(); updateADSRVis();
</script>
</body>
</html>
