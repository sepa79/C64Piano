<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>C64 Piano</title>
<style>
  @font-face {
    font-family: "C64 Pro Mono";
    src: url("data:font/woff2;base64,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") format("woff2"); /* TODO: replace with real font */
    font-display: swap;
  }
  :root{
    --key-w:64px; --key-h:220px; --black-w:38px; --black-h:132px;
    --c64-bg:#352879;
    --c64-fg:#b3caff;
    --c64-accent:#d9a7ff;
    --c64-border:#241a46;
    --c64-panel:#44327f;
    --c64-text: var(--c64-fg);
    --glow:#88a4ff;
    --drum-left:180px;
  }
  *{box-sizing:border-box}
        html,body{height:100vh}
        body{
    margin:0;
    background: var(--c64-bg);
    color: var(--c64-fg);
    letter-spacing:0.02em;
    font-size:15px; line-height:1.3;
    font-family: "C64 Pro Mono", monospace;
    display:flex;
    flex-direction:column;
    overflow:hidden;
        }
  /* Scanlines overlay */
  body::before{
    content:"";
    position:fixed; inset:0;
    pointer-events:none;
    background: repeating-linear-gradient(
      to bottom,
      rgba(0,0,0,0.12) 0px,
      rgba(0,0,0,0.12) 1px,
      rgba(0,0,0,0.00) 2px,
      rgba(0,0,0,0.00) 3px
    );
    mix-blend-mode:multiply;
  }
  /* Background oscilloscopes */
  #oscWrap{position:fixed; inset:0; display:flex; flex-direction:column; z-index:0; pointer-events:none;}
#oscWrap canvas{flex:1; width:100%; opacity:0.2;}

.row{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
  .row label{font-size:12px; display:flex; gap:6px; align-items:center}
  .title{font-weight:800; margin:0 0 10px 0; font-size:15px; letter-spacing:0.6px; text-shadow:0 1px 0 rgba(0,0,0,0.35); display:flex; justify-content:space-between; align-items:center; gap:6px}

  .pill{padding:4px 10px; border-radius:999px; background:rgba(169,187,255,0.15); border:1px solid var(--c64-border); font-size:12px}
  .pill.glow{box-shadow:0 0 0 2px var(--glow) inset}

  .c64-window {
    width:100vw;
    height:100vh;
    border: 4px solid var(--c64-border);
    box-shadow: 0 0 0 2px #000 inset, 0 0 32px rgba(0,0,0,0.45);
    padding: 16px 18px 20px;
    background: linear-gradient(180deg, #44327f 0%, #3a2b6d 100%);
    border-radius: 8px;
    display:flex;
    flex-direction:column;
    overflow:auto;
  }
  .c64-title {
    text-align: center;
    font-size: 24px;
    margin: 4px 0 12px;
    text-shadow: 0 0 6px rgba(128,255,128,0.8), 0 0 14px rgba(128,255,128,0.5);
  }
  .c64-btn {
    background: #201050;
    color: var(--c64-fg);
    border: 2px solid var(--c64-border);
    padding: 8px 12px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    border-radius: 6px;
  }
  .c64-btn:hover { outline: 2px solid var(--c64-accent); }
  .c64-btn:active { transform: translateY(1px); }
  .c64-seg {
    display: inline-flex; border: 2px solid var(--c64-border);
    border-radius: 6px; overflow: hidden;
  }
  .c64-seg button {
    background: #201050; color: var(--c64-fg);
    padding: 8px 10px; border: 0; cursor: pointer; min-width: 64px;
  }
  .c64-seg button.active { background: var(--c64-fg); color: #201050; }
  .c64-seg button svg{width:20px; height:16px; stroke:var(--c64-fg); fill:none; stroke-width:2}
  .block {
    margin-top: 14px; padding: 10px 12px;
    border: 2px dashed var(--c64-border);
    background: rgba(0,0,0,0.15);
    border-radius: 6px;
    line-height: 1.5;
  }

  /* Range inputs */
  input[type=range]{accent-color: var(--c64-accent)}

  /* Mini canvases */
  .miniWrap{display:flex; gap:12px; align-items:center}
  canvas.mini{background:linear-gradient(180deg, rgba(0,0,0,0.15), rgba(255,255,255,0.05)); border:2px solid var(--c64-border); border-radius:8px; backdrop-filter: blur(1px); box-shadow:0 4px 14px rgba(0,0,0,0.25)}
  .ctrlCard{display:flex;gap:12px;align-items:flex-start;margin-bottom:10px;}
  .ctrlCard .ctrls{display:flex;flex-direction:column;gap:6px;min-width:180px;flex:1}
  .ctrlCard .ctrls label{display:flex;align-items:center;gap:6px;width:100%}
  .ctrlCard .ctrls label span{width:130px;text-align:left;white-space:nowrap}
  .ctrlCard .ctrls label select{flex:1;min-width:0}
  #wavePreset{width:100%}
  .sliderWrap{display:flex;align-items:center;gap:6px;flex:1}
  .sliderWrap input[type=range]{flex:1}
  .sliderWrap input[type=number]{width:60px;background:var(--c64-bg);color:var(--c64-fg);border:1px solid var(--c64-border);border-radius:4px;padding:2px}
  .ctrlCard .miniWrap{margin-left:auto;flex-shrink:0}
  .ctrlCard .miniWrap.expand{flex:1;margin-left:0}
  .ctrlCard .miniWrap.expand canvas{width:100%}
  #oscCard, #filterCard{flex-direction:column}
  .ctrlCard .topRow{display:flex;gap:12px;align-items:flex-start}
  .ctrlCard .topRow .ctrls{flex:0 0 auto;min-width:180px}
  .ctrlCard .sliderCol{width:100%}
  #instCard{flex-direction:column;flex:0 0 140px}
  #instCard .ctrls{min-width:0;gap:4px;display:flex;flex-wrap:wrap}
  #instCard button{flex:1 1 60px}
  #instCard button.active{background:var(--c64-fg);color:#201050}
  .octControls{display:flex;align-items:center;gap:6px;justify-content:center}
  .octBtns{display:flex;gap:4px}
  .octBtns button.active{background:var(--c64-fg);color:#201050}

  .synthSection{border-bottom:1px solid var(--c64-border);padding-bottom:12px;margin-bottom:12px}
  .synthSection:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
  .sectionHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .cardHelp{background:none;border:0;color:var(--c64-fg);cursor:pointer;font-size:12px}

  .kbdWrap{display:flex; gap:14px; align-items:flex-start}
  .kbd{position:relative; display:flex; gap:2px; padding:12px; border:2px solid var(--c64-border); border-radius:12px; background:linear-gradient(180deg, rgba(0,0,0,0.12), rgba(255,255,255,0.06)); box-shadow:0 10px 30px rgba(0,0,0,.25) inset}
  .white{position:relative; width:var(--key-w); height:var(--key-h); background:linear-gradient(#ffffff,#eef2f6); border:1px solid #cbd2da; border-bottom-width:4px; border-radius:0 0 10px 10px; display:flex; align-items:center; justify-content:center; font-size:12px; user-select:none; cursor:pointer; z-index:1; color:#111; transition:transform .03s ease, filter .15s ease}
  .white:hover{filter:brightness(1.04)}
  .white:active{transform:translateY(1px)}
  .white.active{background:#e7f0ff; border-color:#8db9ff}
  .black{position:absolute; top:10px; width:var(--black-w); height:var(--black-h); background:linear-gradient(#222,#050505); border:1px solid #000; border-bottom-width:4px; border-radius:0 0 8px 8px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:10px; user-select:none; cursor:pointer; z-index:3; box-shadow:0 10px 18px rgba(0,0,0,0.35); transition:transform .03s ease, filter .15s ease}
  .black:hover{filter:brightness(1.1)}
  .black:active{transform:translateY(1px)}
  .black.active{background:#333}
  .kLabel{position:absolute; bottom:10px; font-size:12px; color:#333}
  .hint{position:absolute; top:6px; left:6px; font-size:10px; color:#eee; background:#222; border:1px solid #333; padding:1px 5px; border-radius:6px; pointer-events:none}
  .white .hint{color:#555; background:#eef2f7; border-color:#d9dee5}

  .key { background: #f7f7f7; border-color: #000; }
  .key.black { background: #101010; }
  .key.active { background: #ff8080 !important; }

  /* History panel */
  .history{flex:1; min-height:0; width:100%; height:100%; border:2px solid var(--c64-border); border-radius:12px; padding:10px; background:linear-gradient(180deg, rgba(0,0,0,0.08), rgba(255,255,255,0.04)); display:flex; flex-direction:column; box-shadow:0 10px 24px rgba(0,0,0,0.25) inset}
  .historyHeader{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
  .historyTitle{font-size:13px; font-weight:800}
  .patternGrid{flex:1; min-height:0; width:100%; overflow:auto; display:grid; grid-template-columns:repeat(16,1fr); grid-auto-rows:24px; background:rgba(0,0,0,0.06); border:1px solid var(--c64-border); border-radius:8px; position:relative;}
  .patternCell{border:1px solid var(--c64-border);}
  .patternNote{background:rgba(0,128,255,0.5); border:1px solid #08f; z-index:10; cursor:move; position:relative;}
  .patternNote::after{content:""; position:absolute; right:0; top:0; width:4px; height:100%; background:rgba(0,0,0,0.2); cursor:ew-resize;}
  .playhead{position:absolute; top:0; bottom:0; width:2px; background:rgba(255,0,0,0.7); pointer-events:none;}
  .patternCursor{border:2px solid red; background:rgba(255,0,0,0.1); pointer-events:none;}
  .patternStatus{margin-top:4px; font-size:12px;}

/* Boot overlay */
#bootOverlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; flex-direction:column; font-family:"C64 Pro Mono", monospace; background:#6C5EB5; color:#6C5EB5; transform-origin:center; padding:120px; box-sizing:border-box;}
#bootOverlay::before{content:""; position:fixed; inset:0; pointer-events:none; background:repeating-linear-gradient(to bottom, rgba(0,0,0,0.12) 0, rgba(0,0,0,0.12) 1px, transparent 2px, transparent 3px); mix-blend-mode:multiply; opacity:.35;}
#bootPanel{display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:left; font-size:min(calc((100vw - 240px)/40), calc((100vh - 240px)/25)); width:40ch;}
#bootText{white-space:pre-wrap; line-height:1; width:40ch; height:25em; background:var(--c64-bg);}
  #bootCursor{display:inline-block; width:1ch; height:1em; background:currentColor; animation:blink 1s steps(1) infinite;}
@keyframes blink{50%{opacity:0;}}
#bootOverlay.poweroff{animation:c64-off .8s steps(8) forwards; pointer-events:none;}
.bootControls{margin-top:24px; display:flex; flex-direction:column; gap:20px; align-items:center; color:var(--c64-bg);}
.bootControls button{background:none; border:none; color:inherit; font:inherit; font-size:24px; cursor:pointer;}
.bootControls button:focus{outline:none;}
.bootControls label{font-size:16px;}
@keyframes c64-off{0%{transform:scaleY(1);opacity:1;}80%{transform:scaleY(0.02);opacity:1;}100%{transform:scaleY(0.02);opacity:0;}}

/* Help modal */
#helpModal{position:fixed; inset:0; background:var(--c64-bg); color:var(--c64-fg); display:none; align-items:center; justify-content:center; z-index:9999; font-family:"C64 Pro Mono", monospace;}
#helpModal.show{display:flex;}
#helpPanel{background:linear-gradient(180deg, rgba(20,32,120,.35), rgba(10,20,70,.35)), var(--c64-panel); border:2px solid var(--c64-border); padding:20px; max-width:600px; width:90%; max-height:80vh; overflow:auto;}
.helpPopup{position:absolute; background:linear-gradient(180deg, rgba(20,32,120,.35), rgba(10,20,70,.35)), var(--c64-panel); border:2px solid var(--c64-border); padding:12px; border-radius:6px; z-index:1000; max-width:240px;}
.helpPopup h3{margin-top:0;font-size:14px}


  /* Drum machine */
  .drums{display:grid; gap:8px; align-items:center}
  .drums .hdr{font-size:12px; color:var(--c64-text); text-align:center}
  .rowLbl{display:flex; gap:8px; align-items:center}
  .rowLbl .keytag{font-size:11px; background:#111; color:#fff; border-radius:6px; padding:2px 6px; box-shadow:0 1px 0 rgba(255,255,255,0.06) inset}
  .step{width:28px; height:28px; border:1px solid var(--c64-border); border-radius:8px; background:linear-gradient(180deg, rgba(169,187,255,0.2), rgba(20,30,90,0.25)); display:grid; place-items:center; cursor:pointer; transition:filter .15s ease, transform .05s ease}
  .step:hover{filter:brightness(1.1)}
  .step:active{transform:translateY(1px)}
  .step.on{background:#08f; border-color:#08f;}
  .colHdr{font-size:10px; color:#cfd7ff; text-align:center}
  .playing{box-shadow:0 0 0 2px #222 inset, 0 0 12px var(--glow)}
  .transport{display:flex; gap:10px; align-items:center; margin-top:10px}

  /* Responsive tweaks */
  @media (max-width: 980px){ :root{ --key-w:54px; --key-h:200px; --drum-left:140px; } }
  @media (max-width: 760px){ :root{ --key-w:46px; --key-h:180px; --black-w:32px; --black-h:116px; --drum-left:110px; } }
  @media (max-width: 560px){ :root{ --key-w:40px; --key-h:160px; --black-w:28px; --black-h:100px; } }

  /* App layout */
  #layout{display:grid; flex:1; min-height:0; overflow:hidden; grid-template-columns:600px 1fr 300px; grid-template-rows:1fr; gap:20px;}
  #leftRegion,#middleRegion,#rightRegion{display:flex; flex-direction:column; gap:12px; min-height:0; overflow:auto; height:100%;}
  #leftRegion .ctrlCard{justify-content:flex-start;}
  #topBar{margin-bottom:20px;}
  #trackerWrap{display:flex; flex:1; gap:12px; min-height:0;}
  #trackerWrap .tracker{flex:1; border:2px solid var(--c64-border); border-radius:8px; padding:8px; overflow:auto; display:flex; flex-direction:column;}
  #trackerWrap .tracker .title{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
  #trackerWrap .tracker .title .trackerLen{margin-left:auto;font-size:12px;}
  .trackerRow{font-size:12px;padding:2px 0;}
  .tabBtns{display:flex; gap:6px; margin-bottom:8px;}
  #middleRegion .block:last-child{flex:1; display:flex; flex-direction:column; min-height:0;}
  .tabContent{display:none; flex:1; overflow:auto;}
  .tabContent.active{display:block;}
</style>
</head>
<body>
<div id="bootOverlay">
  <div id="bootPanel">
    <div id="bootText"><span id="bootCursor"></span></div>
    <div class="bootControls">
      <button id="bootStart">Press Return to enable sound</button>
      <label><input type="checkbox" id="bootSkip"> Skip intro next time</label>
    </div>
  </div>
</div>
<div id="oscWrap"></div>

<div id="helpModal">
  <div id="helpPanel">
    <h2>Help</h2>
    <section id="help-osc"><h3>Oscillator</h3><p>Select waveforms and adjust pulse width, PWM, and vibrato.</p></section>
    <section id="help-adsr"><h3>ADSR</h3><p>Shape attack, decay, sustain, and release of notes.</p></section>
    <section id="help-filter"><h3>Filter</h3><p>Pick low/band/high-pass or off and tweak cutoff, resonance, bit-crush, and volume.</p></section>
    <section id="help-arp"><h3>Arpeggiator</h3><p>Cycle held notes using mode, rate, and gate settings.</p></section>
    <section id="help-oct"><h3>Octave</h3><p>Shift the keyboard range with the arrow buttons or , and . keys.</p></section>
    <section id="help-keyboard"><h3>Keyboard</h3><p>Play with A–K and W–U keys or click; use &lt; / &gt; or , / . for octave.</p></section>
    <section id="help-track"><h3>Track Editor</h3><p>Edit patterns; global length sets default size. Use arrow keys to move, Enter to insert notes, and Delete/Backspace to remove.</p></section>
    <section id="help-fx"><h3>FX</h3><p>Choose instruments and adjust Delay, Chorus, Crush, and Drive.</p></section>
    <section id="help-trackers"><h3>Trackers</h3><p>Right column shows two voice trackers referencing patterns.</p></section>
    <section id="help-drums"><h3>Drum Machine</h3><p>Program Kick, Snare, Hat, and Tom steps with its own length.</p></section>
    <button class="c64-btn" id="helpClose">Close</button>
  </div>
</div>

<div class="c64-window">
  <div class="c64-title">C64 PIANO / TRACKER</div>
  <div id="topBar" class="block">
    <div class="row">
      <label>Project <select id="projectSel"></select></label>
      <label>Engine <select id="engineSel"></select></label>
      <label>Global Track Length <input id="globalTrackLen" type="number" min="1" value="16"></label>
      <label>Quantize <input id="quantize" type="number" min="1" value="1"></label>
      <button class="c64-btn" id="loadBtnTop">Load</button>
      <button class="c64-btn" id="saveBtnTop">Save</button>
      <button class="c64-btn" id="saveAsBtnTop">Save As</button>
      <button class="c64-btn" id="helpBtn" title="Show help">Help</button>
      <div class="transport" style="margin-left:auto">
        <button class="c64-btn" id="transportPlay" title="Play">▶</button>
        <button class="c64-btn" id="transportStop" title="Stop">■</button>
        <span class="pill" id="transportStatus">●</span>
      </div>
    </div>
  </div>

  <div id="layout">
    <div id="leftRegion">
      <div class="block">
        <div class="title">Instrument edit: <span id="instName">Default</span><button class="c64-btn" id="openFx" title="Open FX options">FX</button></div>
    <!-- Engine toggle moved to top bar -->
    <div class="synthSection" id="octSection">
      <div class="sectionHeader"><span>Octave</span><button class="cardHelp" data-help="oct">?</button></div>
      <div class="ctrlCard" id="octCard">
        <div class="ctrls">
          <div class="octControls" title="Octave (, lowers, . raises)">
            <button class="c64-btn" id="octDown" title="Octave down (,)" >&lt;</button>
            <div class="octBtns" id="octBtns">
              <button class="c64-btn octBtn" data-oct="-3">-3</button>
              <button class="c64-btn octBtn" data-oct="-2">-2</button>
              <button class="c64-btn octBtn" data-oct="-1">-1</button>
              <button class="c64-btn octBtn" data-oct="0">0</button>
              <button class="c64-btn octBtn" data-oct="1">1</button>
              <button class="c64-btn octBtn" data-oct="2">2</button>
              <button class="c64-btn octBtn" data-oct="3">3</button>
            </div>
            <button class="c64-btn" id="octUp" title="Octave up (.)" >&gt;</button>
          </div>
        </div>
      </div>
    </div>
    <div class="synthSection" id="oscSection">
      <div class="sectionHeader"><span>Oscillator</span><button class="cardHelp" data-help="osc">?</button></div>
      <div class="ctrlCard" id="oscCard">
        <div class="topRow">
          <div class="ctrls">
            <div class="c64-seg" id="waveBtns" title="Select waveform">
              <button class="segBtn active" data-wave="pulse" aria-pressed="true" title="Pulse (square)">
                <svg viewBox="0 0 40 20"><path d="M1 10 H10 V2 H22 V18 H34 V10 H39"/></svg> Pulse
              </button>
              <button class="segBtn" data-wave="sawtooth" title="Sawtooth">
                <svg viewBox="0 0 40 20"><path d="M1 18 L13 2 L25 18 L37 2"/></svg> Saw
              </button>
              <button class="segBtn" data-wave="triangle" title="Triangle">
                <svg viewBox="0 0 40 20"><path d="M1 18 L13 2 L25 18 L37 2"/></svg> Tri
              </button>
              <button class="segBtn" data-wave="noise" title="Noise">
                <svg viewBox="0 0 40 20"><path d="M1 10 L5 6 L9 14 L13 8 L17 12 L21 5 L25 15 L29 7 L33 11 L37 4"/></svg> Noise
              </button>
            </div>
            <label title="Wave preset"><span>Preset</span><select id="wavePreset"></select></label>
          </div>
          <div class="miniWrap expand">
            <canvas id="waveVis" class="mini" height="80" title="Waveform view"></canvas>
          </div>
        </div>
        <div class="ctrls sliderCol">
          <label title="Pulse width (duty cycle). 0.5 = classic square."><span>P.W.</span><input id="sidPW" type="range" min="0.05" max="0.95" step="0.01" value="0.5"></label>
          <label title="Pulse width modulation rate in Hz."><span>PWM Rate</span><input id="sidPWMRate" type="range" min="0" max="12" step="0.1" value="3"></label>
          <label title="Pulse width modulation depth."><span>PWM Depth</span><input id="sidPWMDepth" type="range" min="0" max="0.45" step="0.01" value="0.25"></label>
          <label title="Vibrato speed in Hz."><span>Vib Hz</span><input id="vibRate" type="range" min="0" max="12" step="0.1" value="5"></label>
          <label title="Vibrato depth in cents (100 = 1 semitone)."><span>Vib Amt</span><input id="vibAmt" type="range" min="0" max="50" step="1" value="8"></label>
        </div>
      </div>
    </div>

    <div class="synthSection" id="adsrSection">
      <div class="sectionHeader"><span>ADSR</span><button class="cardHelp" data-help="adsr">?</button></div>
      <div class="ctrlCard" id="adsrCard">
    <div class="ctrls">
      <label title="Attack time (ms)."><span>A</span><input id="sidA" type="range" min="0" max="200" step="1" value="8"></label>
      <label title="Decay time (ms)."><span>D</span><input id="sidD" type="range" min="0" max="600" step="5" value="120"></label>
      <label title="Sustain level (0–1)."><span>S</span><input id="sidS" type="range" min="0" max="1" step="0.01" value="0.5"></label>
      <label title="Release time (ms)."><span>R</span><input id="sidR" type="range" min="0" max="1200" step="10" value="240"></label>
      <label title="ADSR preset"><span>Preset</span><select id="adsrPreset"></select></label>
    </div>
    <div class="miniWrap">
      <canvas id="adsrVis" class="mini" width="180" height="80" title="ADSR envelope"></canvas>
    </div>
      </div>
    </div>

    <div class="synthSection" id="filterSection">
      <div class="sectionHeader"><span>Filter</span><button class="cardHelp" data-help="filter">?</button></div>
      <div class="ctrlCard" id="filterCard">
        <div class="topRow">
          <div class="ctrls">
            <div class="c64-seg" id="filterBtns" title="Filter type">
              <button class="segBtn active" data-filter="lowpass" title="Low‑pass">
                <svg viewBox="0 0 40 20"><path d="M1 18 C12 6, 18 4, 39 4"/></svg> LP
              </button>
              <button class="segBtn" data-filter="bandpass" title="Band‑pass">
                <svg viewBox="0 0 40 20"><path d="M1 18 C10 18, 15 4, 20 4 C25 4, 30 18, 39 18"/></svg> BP
              </button>
              <button class="segBtn" data-filter="highpass" title="High‑pass">
                <svg viewBox="0 0 40 20"><path d="M1 18 C12 18, 18 16, 39 4"/></svg> HP
              </button>
              <button class="segBtn" data-filter="off" title="No filter">
                <svg viewBox="0 0 40 20"><path d="M1 10 H39"/><path d="M4 2 L36 18"/></svg> Off
              </button>
            </div>
            <label title="Filter preset"><span>Preset</span><select id="filterPreset"></select></label>
            <label title="Adds 8‑bit style grit using a waveshaper."><span>Bit‑crush</span><input id="crush" type="checkbox" checked></label>
          </div>
          <div class="miniWrap expand">
            <canvas id="filterVis" class="mini" height="80" title="Filter magnitude"></canvas>
          </div>
        </div>
        <div class="ctrls sliderCol">
          <label title="Filter cutoff frequency."><span>Cutoff</span><input id="sidCutoff" type="range" min="200" max="8000" step="1" value="1700"></label>
          <label title="Filter resonance (Q)."><span>Res (Q)</span><input id="sidRes" type="range" min="0.1" max="18" step="0.1" value="5"></label>
          <label title="Master output volume."><span>Vol</span><input id="master" type="range" min="0" max="1" step="0.01" value="0.8"></label>
        </div>
      </div>
    </div>

    <div class="synthSection" id="arpSection">
      <div class="sectionHeader"><span>Arpeggiator</span><button class="cardHelp" data-help="arp">?</button></div>
      <div class="ctrlCard" id="arpCard">
    <div class="ctrls">
      <div class="c64-seg" id="arpModeBtns" title="Arpeggiator mode">
        <button class="segBtn active" data-mode="off">Off</button>
        <button class="segBtn" data-mode="up">Up</button>
        <button class="segBtn" data-mode="down">Down</button>
        <button class="segBtn" data-mode="updown">Up/Down</button>
        <button class="segBtn" data-mode="random">Random</button>
      </div>
      <label title="Arpeggiator rate (steps per second)"><span>Rate</span><input id="arpRate" type="range" min="1" max="24" step="1" value="12"></label>
      <label title="Arpeggiator gate (fraction of step)"><span>Gate</span><input id="arpGate" type="range" min="0.1" max="1" step="0.05" value="0.5"></label>
    </div>
      </div>
    </div>
  </div>
</div>
    <div id="middleRegion">
      <div class="block">
        <div class="tabBtns">
          <button class="tabBtn active" data-tab="piano">Piano</button>
          <button class="tabBtn" data-tab="drums">Drums</button>
        </div>
        <div id="pianoTab" class="tabContent active">
  <div class="title">C64 Piano — Keyboard<button class="cardHelp" data-help="keyboard">?</button></div>
  <div class="kbdWrap">
    <div class="ctrlCard" id="instCard">
      <div class="ctrls" id="instBtnWrap"></div>
    </div>
    <div class="kbd" id="kbd">
      <div class="key white" data-note="C" data-key="A"><span class="kLabel">C</span><span class="hint" title="Press A">A</span></div>
      <div class="key white" data-note="D" data-key="S"><span class="kLabel">D</span><span class="hint" title="Press S">S</span></div>
      <div class="key white" data-note="E" data-key="D"><span class="kLabel">E</span><span class="hint" title="Press D">D</span></div>
      <div class="key white" data-note="F" data-key="F"><span class="kLabel">F</span><span class="hint" title="Press F">F</span></div>
      <div class="key white" data-note="G" data-key="G"><span class="kLabel">G</span><span class="hint" title="Press G">G</span></div>
      <div class="key white" data-note="A" data-key="H"><span class="kLabel">A</span><span class="hint" title="Press H">H</span></div>
      <div class="key white" data-note="B" data-key="J"><span class="kLabel">B</span><span class="hint" title="Press J">J</span></div>
      <div class="key white" data-note="C2" data-key="K"><span class="kLabel">C</span><span class="hint" title="Press K">K</span></div>
      <div class="key black" data-note="C#" data-key="W" style="left:calc(var(--key-w) - var(--black-w)/2)"><span class="hint" title="Press W">W</span></div>
      <div class="key black" data-note="D#" data-key="E" style="left:calc(var(--key-w)*2 - var(--black-w)/2)"><span class="hint" title="Press E">E</span></div>
      <div class="key black" data-note="F#" data-key="T" style="left:calc(var(--key-w)*4 - var(--black-w)/2)"><span class="hint" title="Press T">T</span></div>
      <div class="key black" data-note="G#" data-key="Y" style="left:calc(var(--key-w)*5 - var(--black-w)/2)"><span class="hint" title="Press Y">Y</span></div>
      <div class="key black" data-note="A#" data-key="U" style="left:calc(var(--key-w)*6 - var(--black-w)/2)"><span class="hint" title="Press U">U</span></div>
    </div>

    </div>
        </div>
        <div id="drumsTab" class="tabContent">
  <div class="title" style="justify-content:flex-start;gap:6px;flex-wrap:wrap">
    <span>Drums</span>
    <label style="display:flex;align-items:center;gap:4px">Track
      <select id="drumPatternSel"></select>
    </label>
    <label style="display:flex;align-items:center;gap:4px" title="16 steps × n bars">Len
      <input id="drumLen" type="number" min="1" value="1" style="width:3em">
    </label>
    <button class="c64-btn" id="saveDrumBtn" title="Save drum track">Save</button>
    <button class="c64-btn" id="loadDrumBtn" title="Load drum track">Load</button>
    <button class="c64-btn" id="clearDrumBtn" title="Clear drum track">✖</button>
    <button class="c64-btn" id="playDrumBtn" title="Play drums">▶</button>
    <button class="c64-btn" id="stopDrumBtn" title="Stop drums">■</button>
    <button class="cardHelp" data-help="drums">?</button>
  </div>
  <div class="drums" id="drums"></div>
  <div class="transport">
    <label title="Beats per minute. 16th notes are steps.">Tempo <input id="bpm" type="range" min="60" max="180" step="1" value="120"></label>
    <span style="font-size:12px;opacity:.9">Trigger now: Z/X/C/V</span>
  </div>
        </div>
      </div>
      <div class="block">
        <div class="tabBtns">
          <button class="tabBtn active" data-tab="track">Track Editor</button>
          <button class="tabBtn" data-tab="fx">FX</button>
        </div>
        <div id="trackTab" class="tabContent active">
          <div class="history">
            <div class="historyHeader">
              <div style="display:flex;align-items:center;gap:6px"><div class="historyTitle">Pattern Editor</div><button class="cardHelp" data-help="track">?</button></div>
              <div style="display:flex;gap:6px;align-items:center">
                <label style="display:flex;align-items:center;gap:4px">Track
                  <select id="patternSel"></select>
                </label>
                <label style="display:flex;align-items:center;gap:4px">Res
                  <select id="stepResSel">
                    <option value="8">1/8</option>
                    <option value="16" selected>1/16</option>
                  </select>
                </label>
                <label style="display:flex;align-items:center;gap:4px">Len
                  <input id="patternLen" type="number" min="1" value="1" style="width:40px">
                </label>
                <button class="c64-btn" id="savePatternBtn" title="Save pattern to track">Save</button>
                <button class="c64-btn" id="loadPatternBtn" title="Load pattern by name">Load</button>
                <button class="c64-btn" id="playPatternBtn" title="Play selected track">▶</button>
                <button class="c64-btn" id="stopPatternBtn" title="Stop playback">■</button>
                <button class="c64-btn" id="clearPatternBtn" title="Clear selected track">✖</button>
              </div>
            </div>
            <div class="patternGrid" id="patternGrid" role="grid"></div>
            <div id="patternStatus" class="patternStatus"></div>
          </div>
        </div>
        <div id="fxTab" class="tabContent">
          <div class="row" style="gap:6px;align-items:center;flex-wrap:wrap">
            <label><span>Instrument</span><select id="instrumentSel"></select></label>
            <button class="c64-btn" id="instLoadBtn" title="Load instrument">⬇</button>
            <button class="c64-btn" id="instSaveBtn" title="Save instrument">💾</button>
            <button class="c64-btn" id="instSaveAsBtn" title="Save instrument as">✎</button>
            <button class="cardHelp" data-help="fx">?</button>
          </div>
          <div class="row">
            <label>Delay <input id="fxDelay" type="range" min="0" max="1" step="0.01" value="0"></label>
            <label>Chorus <input id="fxChorus" type="range" min="0" max="1" step="0.01" value="0"></label>
            <label>Bit/Crush <input id="fxCrush" type="checkbox"></label>
            <label>Drive <input id="fxDrive" type="range" min="0" max="1" step="0.01" value="0"></label>
          </div>
        </div>
      </div>
    </div>
    <div id="rightRegion">
      <div id="trackerWrap">
        <div class="block tracker">
          <div class="title">Voice 1 — Track
            <select class="trackerTrackSel" data-voice="0"></select>
            <span class="trackerLen" id="trackerLen1"></span>
            <button class="cardHelp" data-help="trackers">?</button>
          </div>
          <div id="tracker1"></div>
        </div>
        <div class="block tracker">
          <div class="title">Voice 2 — Track
            <select class="trackerTrackSel" data-voice="1"></select>
            <span class="trackerLen" id="trackerLen2"></span>
            <button class="cardHelp" data-help="trackers">?</button>
          </div>
          <div id="tracker2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// === Audio setup ===
const AudioContext = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioContext({ latencyHint: 'interactive' });
let audioReady=false;
async function unlockAudio(){
  if(audioReady) return;
  try{
    if(ctx.state==='suspended') await ctx.resume();
    const osc=ctx.createOscillator();
    const g=ctx.createGain();
    g.gain.value=0;
    osc.frequency.value=880;
    osc.connect(g); g.connect(ctx.destination);
    const now=ctx.currentTime;
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(0.1, now+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.2);
    osc.start();
    osc.stop(now+0.21);
    await new Promise(r=>osc.onended=r);
    audioReady=true;
    state.audioReady=true;
    console.log('Audio unlocked', ctx.state, ctx.sampleRate);
  }catch(e){ console.warn('Audio unlock failed', e); }
}
function ensureAudio(){ if(!audioReady) unlockAudio(); else if(ctx.state!=='running') ctx.resume(); }
const get = (id)=>document.getElementById(id);
function valNum(id, fallback=0){ const el=get(id); return el?parseFloat(el.value):fallback; }
const master = ctx.createGain(); master.gain.value = 0.8; master.connect(ctx.destination);

const sidWorkletCode = `
class SIDProcessor extends AudioWorkletProcessor {
  constructor(){
    super();
    this.ready=false;
    this.dspReady=false;
    this.eventQueue=[];
    this.params={pwmRate:0,pwmDepth:0,vibRate:0,vibCents:0,master:0.2};
    this.activeVoices=0;
    this.silentCount=0;
    this.ptr=0;
    this.mem=null;
    this.sampleRate=sampleRate;
    this.scratch=new Float32Array(128);
    this.port.onmessage=e=>{
      const d=e.data||{};
      if(d.type==='loadWasm'){ this._loadWasm(d); return; }
      if(d.type==='wasmReadyAck'){ if(this.dspReady) this.ready=true; return; }
      this.eventQueue.push(d);
    };
  }
  async _loadWasm(d){
    this.ready=false;
    this.dspReady=false;
    this.eventQueue.length=0;
    this.exports=null;
    this.mem=null;
    this.ptr=0;
    try{
      const imports=d.imports||{};
      const bytes=d.bytes instanceof Uint8Array?d.bytes:new Uint8Array(d.bytes);
      const {instance}=await WebAssembly.instantiate(bytes, imports);
      this.exports=instance.exports;
      this.mem=new Float32Array(this.exports.memory.buffer);
      this.ptr=this.exports.get_buffer_ptr?this.exports.get_buffer_ptr():(this.exports.OUT_BUF||0);
      const sr=Number.isFinite(d.sampleRate)?d.sampleRate:sampleRate;
      this.sampleRate=sr;
      if(this.mem) this.mem.fill(0);
      if(this.exports.init) this.exports.init(sr);
      this.dspReady=true;
      this.port.postMessage({type:'wasmReady'});
    }catch(err){
      this.ready=false;
      this.dspReady=false;
      this.port.postMessage({type:'wasmError', message:err.message});
    }
  }
  _finite(v, fallback){ return Number.isFinite(v)?v:fallback; }
  _clamp(v,min,max,fallback){ const val=this._finite(v,fallback); return Math.min(max, Math.max(min, val)); }
  _sanitizeGlobals(ev){
    return {
      pwmRate: Math.max(0, this._finite(ev.pwmRate, 0)),
      pwmDepth: this._clamp(ev.pwmDepth, 0, 0.96, 0),
      vibRate: Math.max(0, this._finite(ev.vibRate, 0)),
      vibCents: this._clamp(ev.vibCents, -2400, 2400, 0),
      master: this._clamp(ev.master, 0, 1.5, 0.2)
    };
  }
  _sanitizeCutoff(value){
    const nyquist=this.sampleRate*0.5;
    return this._clamp(value, 20, Math.max(40, nyquist-1), 1000);
  }
  _sanitizeQ(value){
    return this._clamp(value, 0.1, 20, 1);
  }
  _dispatch(ev){
    if(!this.exports) return;
    if(ev.type==='noteOn'){
      const freq=this._clamp(ev.freq, 1, 20000, 440);
      const pw=this._clamp(ev.pw, 0.02, 0.98, 0.5);
      const a=Math.max(0, this._finite(ev.a, 0.01));
      const d=Math.max(0, this._finite(ev.d, 0.1));
      const s=this._clamp(ev.s, 0, 1, 0.5);
      const r=Math.max(0, this._finite(ev.r, 0.1));
      if(this.exports.note_on) this.exports.note_on(ev.voice|0, freq, pw, a, d, s, r);
      if(this.activeVoices<3) this.activeVoices++;
      return;
    }
    if(ev.type==='noteOff'){
      if(this.exports.note_off) this.exports.note_off(ev.voice|0);
      if(this.activeVoices>0) this.activeVoices--;
      return;
    }
    if(ev.type==='setFilter'){
      if(this.exports.set_filter){
        const cutoff=this._sanitizeCutoff(ev.cutoff)+1e-6;
        const q=this._sanitizeQ(ev.q)+1e-6;
        this.exports.set_filter(ev.mode|0, cutoff, q);
      }
      return;
    }
    if(ev.type==='setGlobal'){
      this.params=this._sanitizeGlobals(ev);
      if(this.exports.set_global) this.exports.set_global(this.params.pwmRate,this.params.pwmDepth,this.params.vibRate,this.params.vibCents,this.params.master);
      return;
    }
    if(ev.type==='setMaster'){
      this.params.master=this._clamp(ev.master,0,1.5,this.params.master||0.2);
      if(this.exports.set_global) this.exports.set_global(this.params.pwmRate,this.params.pwmDepth,this.params.vibRate,this.params.vibCents,this.params.master);
    }
  }
  process(inputs,outputs){
    const output=outputs[0];
    if(!output || output.length===0) return true;
    const frames=output[0].length;
    for(let ch=0; ch<output.length; ch++) output[ch].fill(0);
    if(!this.ready || !this.exports){
      return true;
    }
    let ev;
    while((ev=this.eventQueue.shift())) this._dispatch(ev);
    if(this.exports.memory && this.mem && this.mem.buffer!==this.exports.memory.buffer){
      this.mem=new Float32Array(this.exports.memory.buffer);
    }
    const base=this.ptr>>2;
    const mem=this.mem;
    if(!mem || base<0 || base>=mem.length){
      return true;
    }
    if(this.scratch.length<frames) this.scratch=new Float32Array(frames);
    try{
      if(this.exports.render) this.exports.render(this.ptr, frames);
    }catch(err){
      this.ready=false;
      this.port.postMessage({type:'wasmError', message:err.message});
      return true;
    }
    let silent=true;
    const available=Math.max(0, Math.min(frames, mem.length-base));
    for(let i=0;i<frames;i++){
      let sample=0;
      if(i<available){
        sample=mem[base+i];
        if(!Number.isFinite(sample)) sample=0;
      }
      this.scratch[i]=sample;
      if(sample!==0) silent=false;
    }
    for(let ch=0; ch<output.length; ch++) output[ch].set(this.scratch);
    if(silent && this.activeVoices>0){
      if(++this.silentCount>50){ this.port.postMessage({type:'underrun'}); this.silentCount=0; }
    } else {
      this.silentCount=0;
    }
    return true;
  }
}
registerProcessor('sid-processor', SIDProcessor);
`;

const SID_WASM_BASE64='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FxsOEQESBgAAAjkBAw4AAAMuAG4OAw46CzsLIAsAAAQuAREBEgZAGG4OAw46CzsLAAAFHQExEFUXWAtZC1cLAAAGHQAxEBEBEgZYC1kLVwsAAAcdADETEQESBlgLWQtXCwAACB0AMRNVF1gLWQtXCwAACS4Abg4DDjoLOwUgCwAAChEBJQ4TBQMOEBcbDgAAAAERASUOEwUDDhAXGw4RARIGAAACOQEDDgAAAy4BEQESBkAYAw46CzsFPxkAAAQdADEQEQESBlgLWQVXCwAABREBJQ4TBQMOEBcbDgAABi4Abg4DDjoLOwU/GSALAAAAAJczCy5kZWJ1Z19pbmZvtQQAAAQAAAAAAAQB5SMAABwAsSMAAAAAAABqIgAAAAAAACAAAAACwwIAAAJHAgAAA/////8NAAAAB+0DAAAAAJ9ODwAARRoAAAHYAgT/////DQAAAAftAwAAAACfXhcAAEUaAAAB2AIDAksDAAAD/////zkAAAAE7QACn8kGAAAzGgAAAQEDAAL7AAAABW8YAACKAgAAAaoBAwECigIAAAagAwAAbwAAAAGxAQEAAgsCAAAGoA4AAG8AAAABvAEBAAcGDwAACwIAAAG7AQEACP////+ZAAAABO0ABJ/UEAAA9gEAAAEbAwmNAAAA/////0YAAAABIQMWCQYEAAD/////HQAAAAGrAS8K9AMAAP////8dAAAABFwMGgAJXQMAAP////8gAAAAAbEBGwlQAwAA/////yAAAAAIFwEUCaAAAAD/////IAAAAAg7AQwLIAQAAAAAAAABsgEsCToEAAD/////BwAAAAG2AQ8JLQQAAP////8HAAAABa0BDgp1BAAA/////wcAAAAF9wEJAAAAAAAACZsDAAD/////DgAAAAE4AxEJ9QIAAP////8OAAAACXEBGAxHBAAA/////wkAAAAHExsAAAnBAAAA/////wcAAAABUAMFCXcDAAD/////BwAAAAG8ARsJagMAAP////8HAAAACBcBFAmzAAAA/////wcAAAAIOwEMCWEEAAD/////BwAAAAG+AQ8JVAQAAP////8HAAAABa0BDgqCBAAA/////wcAAAAF9wEJAAAAAAAAAAj/////AwAAAAftAwAAAACf8gIAAA8DAAABfQMN3AQAAP////8DAAAAAX4DGQ7EAwAA/////wMAAAANMgUO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AACvFgAAAQAAAAI9DQAHOgAAAAUXAABLAAAAAV4PB0wAAABWFwAASQAAAAFbDgc6AAAAohcAAE0AAAABXA4ITAAAAAgDAAABXQ4HTAAAAGcYAABJAAAAAVAQBzoAAADIGAAASwAAAAFNGQc6AAAAJRkAAE0AAAABSxgITAAAACADAAABQBAHOgAAAP8ZAABNAAAAAT0YBzoAAABbGgAASwAAAAE7GQdMAAAAuRoAAEkAAAABNBAHWgEAACMbAAAGAAAACAMSAAAAAAACkwIAAAKLAQAACQwIAABdHQAABygIAQAAAF4AAAAEAFgEAAAECuUjAAAcAJoiAAABIQAAaiIAAAJcAQAAAjgCAAACMwIAAAJlAgAAAxAUAABlAgAAASMBAAAAAAKTAgAAAgUjAAACZgAAAAmoFQAAJQEAAAJwBAEAAAAAZQAAAAQA8wQAAAQB5SMAABwAniEAAJohAABqIgAAORsAAAoAAAACXAEAAAI4AgAAAnsAAAACWgIAAAM5GwAACgAAAAftAwAAAACfWgIAAALeAQR6GQAAORsAAAkAAAAC4AEpAAAAAAAAOgAAAAQA8wQAAAQF5SMAABwAfh4AAE4iAABqIgAAAlwBAAACOAIAAAJ7AAAABqsYAABaAgAAAdUBAQAAAAAAxgYNLmRlYnVnX3Jhbmdlc/7////+/////v////7////+/////v///wAAAAAAAAAA/v////7////+/////v////7////+/////v////7////+/////v////7////+/////v////7////+/////v///wAAAAAAAAAAhwAAAI0AAACsAAAAtwAAAAAAAAAAAAAAIQAAAEAAAABOAAAAmgAAAKYAAAC3AAAAwAAAADYBAAAAAAAAAAAAAIcAAACNAAAArAAAALcAAAAAAAAAAAAAAEICAABWAgAAhwIAAJACAACmAgAAswIAAAAAAAAAAAAAQgIAAFYCAACOAgAAkAIAAKYCAACzAgAAAAAAAAAAAAAeBAAAKAQAAC4EAAAwBAAAAAAAAAAAAAAMCAAADggAAJUIAACzCAAAAAAAAAAAAAAMCAAADggAAKQIAACzCAAAAAAAAAAAAACVCAAAnAgAAJ8IAACkCAAAAAAAAAAAAABxCAAAcwgAAHsIAACECAAAAAAAAAAAAACMCgAAlgoAAMsKAAD4CgAALAsAAEELAABICwAAXwsAAAAAAAAAAAAAjAoAAJYKAADPCgAA+AoAAE8LAABfCwAAAAAAAAAAAAAsCwAAQQsAAEgLAABPCwAAAAAAAAAAAAAeDAAAJAwAACsMAAAtDAAAAAAAAAAAAABzDAAAsAwAAL4MAADmDAAAEQ0AACYNAAAAAAAAAAAAAHMMAACnDAAAvgwAAOYMAAAfDQAAJg0AAAAAAAAAAAAAkQ0AAM4NAADcDQAABA4AAC8OAABEDgAAAAAAAAAAAACRDQAAxQ0AANwNAAAEDgAAPQ4AAEQOAAAAAAAAAAAAAGEOAABoDgAAsg4AAMwOAAAAAAAAAAAAAGEOAABoDgAAwQ4AAMwOAAAAAAAAAAAAAMwOAADODgAAEA8AADMPAAAAAAAAAAAAAMwOAADODgAAEQ8AABUPAAAjDwAAMw8AAAAAAAAAAAAATg8AAFIPAABgDwAAZQ8AAAAAAAAAAAAAcQAAAP8AAAAAAQAAGwEAAAAAAAAAAAAAIAIAACUCAAAqAgAAbAIAAAAAAAAAAAAAywMAANADAADVAwAAFQQAAAAAAAAAAAAAAKlICi5kZWJ1Z19zdHJ7aW1wbCM1OH0Ae2ltcGwjNDE4fQB7aW1wbCMxNn0Ae2ltcGwjMzM1fQB7aW1wbCMxNX0Ae2ltcGwjMTR9AHtpbXBsIzE0Mn0Ae2ltcGwjMn0Ae2ltcGwjMTIxfQB7aW1wbCMxfQB7aW1wbCMwfQB7Y2xvc3VyZSMwfQBwYXJ0aWFsX2F2YWlsYWJpbGl0eQBydXN0X2VoX3BlcnNvbmFsaXR5AExvY2FsS2V5AGluZGV4AHJldgBjYXN0AHN1cHBvcnQAX1JOdkNzNzNmQWRTcmdPSkxfN19fX3J1c3RjMTJfX19ydXN0X2Fib3J0AHBhbmljX2Fib3J0AHBhbmljX2NvdW50AGhpbnQAbHQAYml0AEZsb2F0AHN5cwB0b19iaXRzAGZyb21fYml0cwBpbnRfdHJhaXRzAGZsb2F0X3RyYWl0cwBwcm9jZXNzAGFkYXB0ZXJzAG9wcwBjb21waWxlcl9idWlsdGlucwBpbXBscwBSYW5nZUJvdW5kcwBub190aHJlYWRzAHB0cgBmNjRfZmxvb3IAaXRlcgBjbXAAcG9pc29uAGNvbW1vbgBtdWxfYXNzaWduAHNjYWxibgB3YXNtAG1lbQBtdWwAY2VsbABDZWxsAHNobABwYWwAYWJvcnRfaW50ZXJuYWwAbG9jYWwAcnVzdF9wYW5pY193aXRoX2hvb2sAZmluaXNoZWRfcGFuaWNfaG9vawByd2xvY2sAUndMb2NrAGFyaXRoAGxpYm1fbWF0aABjb3JlX2FyY2gAcGFuaWNraW5nAGtfY29zZgBrX3NpbmYAZXhwMmYAcmVtX3BpbzJmAEF0b21pY1VzaXplAFJhbmdlSW5jbHVzaXZlAGluY3JlYXNlAGNvcmUAcmVtX3BpbzJfbGFyZ2UAcmFuZ2UAUmFuZ2UAc2xpY2UAYmFja3RyYWNlAHN0ZABmZXRjaF9hZGQAUGFuaWNQYXlsb2FkAHRocmVhZABzeW5jAGdlbmVyaWMAX1JOdkNzNzNmQWRTcmdPSkxfN19fX3J1c3RjMTBydXN0X3BhbmljAF9STnZDczczZkFkU3JnT0pMXzdfX19ydXN0YzE4X19fcnVzdF9zdGFydF9wYW5pYwBiZWdpbl9wYW5pYwBhdG9taWMAX1pONGNvcmUzZjY0MjFfJExUJGltcGwkdTIwJGY2NCRHVCQ5ZnJvbV9iaXRzMTdoMmZkMWVmM2NiZmM5ZWVlZkUAX1pOM3N0ZDlwYW5pY2tpbmcxMXBhbmljX2NvdW50OGluY3JlYXNlMjhfJHU3YiQkdTdiJGNsb3N1cmUkdTdkJCR1N2QkMTdoNmZlNjBmYjQ2MDk1ZmNkZkUAX1pONGNvcmUzb3BzNXJhbmdlMTZSYW5nZSRMVCRJZHgkR1QkOGNvbnRhaW5zMTdoYjljMDcyYThjNDU1OGNiZkUAX1pOMTdjb21waWxlcl9idWlsdGluczRtYXRoMjBwYXJ0aWFsX2F2YWlsYWJpbGl0eTVleHAyZjE3aDg3YjRkOTliZjgxMDg1YmZFAF9aTjRjb3JlNXNsaWNlMjlfJExUJGltcGwkdTIwJCR1NWIkVCR1NWQkJEdUJDEzZ2V0X3VuY2hlY2tlZDE3aDllMjFmYmQ5OTQ0ZTNkNWZFAF9aTjE3Y29tcGlsZXJfYnVpbHRpbnM0bWF0aDlsaWJtX21hdGg0c2luZjRzaW5mMTdoMzc2NTAyMGMxNjYyYTcxZkUAX1pONzVfJExUJHVzaXplJHUyMCRhcyR1MjAkY29yZS4uc2xpY2UuLmluZGV4Li5TbGljZUluZGV4JExUJCR1NWIkVCR1NWQkJEdUJCRHVCQxM2dldF91bmNoZWNrZWQxN2gyNmI5ZWUxOWM5OTc2OWNlRQBfWk4zc3RkM3N5czNwYWw0d2FzbTZjb21tb24xNGFib3J0X2ludGVybmFsMTdoODAzN2MxNzkzNTJmMjM5ZUUAX1pONzVfJExUJHVzaXplJHUyMCRhcyR1MjAkY29yZS4uc2xpY2UuLmluZGV4Li5TbGljZUluZGV4JExUJCR1NWIkVCR1NWQkJEdUJCRHVCQxM2dldF91bmNoZWNrZWQxN2gyMmNmZjdjMzAzYmI0MjhlRQBfWk45Nl8kTFQkVCR1MjAkYXMkdTIwJGNvbXBpbGVyX2J1aWx0aW5zLi5tYXRoLi5saWJtX21hdGguLnN1cHBvcnQuLmludF90cmFpdHMuLkNhc3RGcm9tJExUJFUkR1QkJEdUJDljYXN0X2Zyb20xN2hkNWQ1ZGUzZDdjYTI3ODdlRQBfWk4zc3RkOXBhbmlja2luZzExYmVnaW5fcGFuaWMyOF8kdTdiJCR1N2IkY2xvc3VyZSR1N2QkJHU3ZCQxN2g2MDA2OTU2NDVjNDBlZDZlRQBfWk40Y29yZTVzbGljZTI5XyRMVCRpbXBsJHUyMCQkdTViJFQkdTVkJCRHVCQxM2dldF91bmNoZWNrZWQxN2g5YTBmM2RhZmRmMTkzZDZlRQBfWk4zc3RkN3Byb2Nlc3M1YWJvcnQxN2gwYzVmMDk0NWY0NTI3MDBlRQBfWk40NV8kTFQkZjY0JHUyMCRhcyR1MjAkY29yZS4ub3BzLi5hcml0aC4uTXVsJEdUJDNtdWwxN2g0NmRhMGUzMjU0N2E1MGVkRQBfWk40Y29yZTRoaW50OWJsYWNrX2JveDE3aDQ5MDQ1M2ZlMzkxNDA4ZGRFAF9aTjRjb3JlM3B0cjEzcmVhZF92b2xhdGlsZTE3aDFhYzkyZTU3OTNiOTVhYmRFAF9aTjE3Y29tcGlsZXJfYnVpbHRpbnM0bWF0aDlsaWJtX21hdGgxNHJlbV9waW8yX2xhcmdlMTRyZW1fcGlvMl9sYXJnZTE3aGUxMDMwM2FhYWU4NTJmYWRFAF9aTjk4XyRMVCRjb3JlLi5pdGVyLi5hZGFwdGVycy4ucmV2Li5SZXYkTFQkSSRHVCQkdTIwJGFzJHUyMCRjb3JlLi5pdGVyLi50cmFpdHMuLml0ZXJhdG9yLi5JdGVyYXRvciRHVCQ0bmV4dDE3aDE3MWE4OWJmOTJlZDgxYWRFAF9aTjRjb3JlNXNsaWNlMjlfJExUJGltcGwkdTIwJCR1NWIkVCR1NWQkJEdUJDEzZ2V0X3VuY2hlY2tlZDE3aGQ3ZGFhMGZlZWM2NWU2NWNFAF9aTjE3Y29tcGlsZXJfYnVpbHRpbnM0bWF0aDlsaWJtX21hdGg3Z2VuZXJpYzZzY2FsYm42c2NhbGJuMTdoZjA4OGEzYmY2NGQxNmEyY0UAX1pONGNvcmU0aXRlcjVyYW5nZTEyNV8kTFQkaW1wbCR1MjAkY29yZS4uaXRlci4udHJhaXRzLi5kb3VibGVfZW5kZWQuLkRvdWJsZUVuZGVkSXRlcmF0b3IkdTIwJGZvciR1MjAkY29yZS4ub3BzLi5yYW5nZS4uUmFuZ2VJbmNsdXNpdmUkTFQkQSRHVCQkR1QkOW5leHRfYmFjazE3aDIwZjBmZmZmMmZjNGVmY2JFAF9aTjRjb3JlNXBhbmljMTJQYW5pY1BheWxvYWQ2YXNfc3RyMTdoZTc3YWI2Yzc2MDYxYTVjYkUAX1pOMTA3XyRMVCRjb3JlLi5vcHMuLnJhbmdlLi5SYW5nZUluY2x1c2l2ZSRMVCRUJEdUJCR1MjAkYXMkdTIwJGNvcmUuLml0ZXIuLnJhbmdlLi5SYW5nZUluY2x1c2l2ZUl0ZXJhdG9ySW1wbCRHVCQxNHNwZWNfbmV4dF9iYWNrMTdoMDQ1YTIyZWYzNzI4NTQ4YkUAX1pONGNvcmU5Y29yZV9hcmNoNndhc20zMjlmNjRfZmxvb3IxN2g2ZWFiMDUzYjNiMTQ1YzRiRQBfWk4xN2NvbXBpbGVyX2J1aWx0aW5zNG1hdGg5bGlibV9tYXRoNmtfY29zZjZrX2Nvc2YxN2hhYTUzZjRhMGQzNzEyYTNiRQBfWk4zc3RkNnRocmVhZDVsb2NhbDE3TG9jYWxLZXkkTFQkVCRHVCQ4dHJ5X3dpdGgxN2hmMTA2ZWQ3MmVmNjI3ZDBiRQBfWk40Y29yZTVzbGljZTI5XyRMVCRpbXBsJHUyMCQkdTViJFQkdTVkJCRHVCQxN2dldF91bmNoZWNrZWRfbXV0MTdoMWY3YzZiYTZjNDE4ZjcwYkUAX1pONzVfJExUJHVzaXplJHUyMCRhcyR1MjAkY29yZS4uc2xpY2UuLmluZGV4Li5TbGljZUluZGV4JExUJCR1NWIkVCR1NWQkJEdUJCRHVCQxN2dldF91bmNoZWNrZWRfbXV0MTdoMzhmOTg4MGUzZGI3MjJmYUUAX1pOMTA3XyRMVCRjb3JlLi5vcHMuLnJhbmdlLi5SYW5nZUluY2x1c2l2ZSRMVCRUJEdUJCR1MjAkYXMkdTIwJGNvcmUuLml0ZXIuLnJhbmdlLi5SYW5nZUluY2x1c2l2ZUl0ZXJhdG9ySW1wbCRHVCQ5c3BlY19uZXh0MTdoNjJiMTgwMGQ3OGZkNmNkYUUAX1pOMTAwXyRMVCR1MzIkdTIwJGFzJHUyMCRjb21waWxlcl9idWlsdGlucy4ubWF0aC4ubGlibV9tYXRoLi5zdXBwb3J0Li5pbnRfdHJhaXRzLi5DYXN0SW50byRMVCR1NjQkR1QkJEdUJDRjYXN0MTdoNjc0NjNjMGUyZTc4NWRhYUUAX1pOODhfJExUJGY2NCR1MjAkYXMkdTIwJGNvbXBpbGVyX2J1aWx0aW5zLi5tYXRoLi5saWJtX21hdGguLnN1cHBvcnQuLmZsb2F0X3RyYWl0cy4uRmxvYXQkR1QkOWZyb21fYml0czE3aDNlOWYwNWRlYWM5NDY3YWFFAF9aTjE3Y29tcGlsZXJfYnVpbHRpbnM0bWF0aDlsaWJtX21hdGg1Zmxvb3I1Zmxvb3IxN2g0MDdjZGQyYTk5ZjJmYjdhRQBfWk4zc3RkOXBhbmlja2luZzExcGFuaWNfY291bnQxOWZpbmlzaGVkX3BhbmljX2hvb2syOF8kdTdiJCR1N2IkY2xvc3VyZSR1N2QkJHU3ZCQxN2g1OGI0NzJlYTVmMzRhODdhRQBfWk4zc3RkOXBhbmlja2luZzExcGFuaWNfY291bnQxOWZpbmlzaGVkX3BhbmljX2hvb2sxN2hiMDUxMmU5OTBkODQ3MDVhRQBfWk4zc3RkOXBhbmlja2luZzQxYmVnaW5fcGFuaWMkdTdiJCR1N2IkcmVpZnkuc2hpbSR1N2QkJHU3ZCQxN2gyNzQ2Yjg1NzhlNzA4NTRhRQBfWk40Y29yZTNmMzIyMV8kTFQkaW1wbCR1MjAkZjMyJEdUJDd0b19iaXRzMTdoOGQ3MzBiMDAxNjQwY2ViOUUAX1pOM3N0ZDNzeXM5YmFja3RyYWNlMjZfX3J1c3RfZW5kX3Nob3J0X2JhY2t0cmFjZTE3aGQyNDk2OWFlMTc0ZjYyZDhFAF9aTjRjb3JlM21lbTdyZXBsYWNlMTdoNThjOWQwZDg1NDViZTliOEUAX1pONGNvcmU1c2xpY2UyOV8kTFQkaW1wbCR1MjAkJHU1YiRUJHU1ZCQkR1QkMTNnZXRfdW5jaGVja2VkMTdoZDJkMjkxMjAxYWI0YzY5OEUAX1pONGNvcmU0Y2VsbDEzQ2VsbCRMVCRUJEdUJDNnZXQxN2gzMzY2NzdhMDYzZjMzZmY3RQBfWk4zc3RkOXBhbmlja2luZzIwcnVzdF9wYW5pY193aXRoX2hvb2sxN2g0ZmEzZGFlYWQ5YzRlMGE3RQBfWk40Y29yZTRpdGVyNXJhbmdlMTEwXyRMVCRpbXBsJHUyMCRjb3JlLi5pdGVyLi50cmFpdHMuLml0ZXJhdG9yLi5JdGVyYXRvciR1MjAkZm9yJHUyMCRjb3JlLi5vcHMuLnJhbmdlLi5SYW5nZUluY2x1c2l2ZSRMVCRBJEdUJCRHVCQ0bmV4dDE3aDMyN2NkMTEwN2U1MGI3NTdFAF9aTjRjb3JlNHN5bmM2YXRvbWljMTBhdG9taWNfYWRkMTdoMWJjZTQyNGYwNjgzNmZlNkUAX1pONGNvcmU0Y2VsbDEzQ2VsbCRMVCRUJEdUJDNzZXQxN2g2ZWRiZDVhZjFhNTE0ZWM2RQBfWk4xN2NvbXBpbGVyX2J1aWx0aW5zNG1hdGg5bGlibV9tYXRoN3N1cHBvcnQxMmZsb2F0X3RyYWl0czVGbG9hdDEwZnJvbV9wYXJ0czE3aDAyYjI4Njk4OThkNmYzYjZFAF9aTjNzdGQ0c3luYzZwb2lzb242cndsb2NrMTVSd0xvY2skTFQkVCRHVCQ0cmVhZDE3aDhjNDAyMDAzMzAxYjI4NzZFAF9aTjNzdGQzc3lzNHN5bmM2cndsb2NrMTBub190aHJlYWRzNlJ3TG9jazRyZWFkMTdoZTVmYjQ2YzcyYTg1NWQ2NkUAX1pONTRfJExUJHU2NCR1MjAkYXMkdTIwJGNvcmUuLm9wcy4uYml0Li5TaGwkTFQkdTMyJEdUJCRHVCQzc2hsMTdoZDBlOWNmZGE5N2Q2NTQ2NkUAX1pOM3N0ZDZ0aHJlYWQ1bG9jYWwxN0xvY2FsS2V5JExUJFQkR1QkNHdpdGgxN2gxNmFkOTQzMjY1ZWQyOTI2RQBfWk43NV8kTFQkdXNpemUkdTIwJGFzJHUyMCRjb3JlLi5zbGljZS4uaW5kZXguLlNsaWNlSW5kZXgkTFQkJHU1YiRUJHU1ZCQkR1QkJEdUJDE3Z2V0X3VuY2hlY2tlZF9tdXQxN2g0MTQyOWY0N2NmYzJkNDI2RQBfWk4xN2NvbXBpbGVyX2J1aWx0aW5zNG1hdGg5bGlibV9tYXRoOXJlbV9waW8yZjlyZW1fcGlvMmYxN2hjY2IwMzA2YTNkNmI2ZTA2RQBfWk43NV8kTFQkdXNpemUkdTIwJGFzJHUyMCRjb3JlLi5zbGljZS4uaW5kZXguLlNsaWNlSW5kZXgkTFQkJHU1YiRUJHU1ZCQkR1QkJEdUJDEzZ2V0X3VuY2hlY2tlZDE3aGUyMmQwNzNiN2NiMTMxODVFAF9aTjUxXyRMVCRmNjQkdTIwJGFzJHUyMCRjb3JlLi5vcHMuLmFyaXRoLi5NdWxBc3NpZ24kR1QkMTBtdWxfYXNzaWduMTdoZjVhNzczNWRmNzkzY2Y2NUUAX1pOMTdjb21waWxlcl9idWlsdGluczRtYXRoOWxpYm1fbWF0aDZzY2FsYm42c2NhbGJuMTdoMDM1MmE1MjM2YTRiYjNmNEUAX1pONGNvcmU0Y2VsbDEzQ2VsbCRMVCRUJEdUJDNnZXQxN2g3M2E3ZjExNjk4NzBjZGQ0RQBfWk40Y29yZTNmMzIyMV8kTFQkaW1wbCR1MjAkZjMyJEdUJDlmcm9tX2JpdHMxN2g2ZGJkZTI5ZjVhZWEyODk0RQBfWk4xN2NvbXBpbGVyX2J1aWx0aW5zNG1hdGg5bGlibV9tYXRoNWV4cDJmNWV4cDJmMTdoM2VjZmEzMjc5YTIzMGJiM0UAX1pONGNvcmU0c3luYzZhdG9taWMxMUF0b21pY1VzaXplOWZldGNoX2FkZDE3aDAyNmFlYjA0NjFlZWNkNTNFAF9aTjRjb3JlM2NtcDVpbXBsczU3XyRMVCRpbXBsJHUyMCRjb3JlLi5jbXAuLlBhcnRpYWxPcmQkdTIwJGZvciR1MjAkdXNpemUkR1QkMmx0MTdoMTViYjMzODRhYzlhMWExM0UAX1pOMTdjb21waWxlcl9idWlsdGluczRtYXRoOWxpYm1fbWF0aDZrX3NpbmY2a19zaW5mMTdoOTQxZTllZTY1ODNiM2FlMkUAX1pOM3N0ZDZ0aHJlYWQ1bG9jYWwxN0xvY2FsS2V5JExUJFQkR1QkNHdpdGgxN2g1NTZmNGI2MDI5ZmQ5OWQyRQBfWk4zc3RkOXBhbmlja2luZzExYmVnaW5fcGFuaWMxN2g0ZGQ5ZjFiMDNlMDk0OTgyRQBfWk40Y29yZTVzbGljZTI5XyRMVCRpbXBsJHUyMCQkdTViJFQkdTVkJCRHVCQxN2dldF91bmNoZWNrZWRfbXV0MTdoODViYmUwOGMyNDFiZmUwMkUAX1pONGNvcmUzb3BzNXJhbmdlMTFSYW5nZUJvdW5kczhjb250YWluczE3aDc0ODhlNTA4M2NjZGQ3ZjFFAF9aTjE3Y29tcGlsZXJfYnVpbHRpbnM0bWF0aDlsaWJtX21hdGg0YXJjaDZ3YXNtMzI1Zmxvb3IxN2hmNjE1Mjc1MGM0MjdjOGQxRQBfWk4zc3RkOXBhbmlja2luZzExcGFuaWNfY291bnQ4aW5jcmVhc2UxN2g3NTRkODE5NDcwYTM5NTIxRQBfWk4xN2NvbXBpbGVyX2J1aWx0aW5zNG1hdGgyMHBhcnRpYWxfYXZhaWxhYmlsaXR5NHNpbmYxN2hjMmZjZGYzZmIwYmY3NWUwRQBfWk40Y29yZTRjZWxsMTNDZWxsJExUJFQkR1QkN3JlcGxhY2UxN2g4NWYwNDdiNmY1YjNiMjgwRQBfWk40Y29yZTNvcHM1cmFuZ2UyNVJhbmdlSW5jbHVzaXZlJExUJElkeCRHVCQ4aXNfZW1wdHkxN2g4YjQxYzQxYTVhODRhNDYwRQBfWk43NV8kTFQkdXNpemUkdTIwJGFzJHUyMCRjb3JlLi5zbGljZS4uaW5kZXguLlNsaWNlSW5kZXgkTFQkJHU1YiRUJHU1ZCQkR1QkJEdUJDEzZ2V0X3VuY2hlY2tlZDE3aDY5ZGZhZjk5MTBhOGIxMzBFAF9aTjNzdGQ2dGhyZWFkNWxvY2FsMTdMb2NhbEtleSRMVCRUJEdUJDh0cnlfd2l0aDE3aDNhOWRlNDk4NjdmMGRhMTBFAHtjbG9zdXJlIzB9PCZzdHI+AGJlZ2luX3BhbmljPCZzdHI+AHJlYWQ8c3RkOjpwYW5pY2tpbmc6Okhvb2s+AGlzX2VtcHR5PHVzaXplPgBzcGVjX25leHQ8dXNpemU+AHNwZWNfbmV4dF9iYWNrPHVzaXplPgBnZXRfdW5jaGVja2VkPHVzaXplPgBhdG9taWNfYWRkPHVzaXplPgBnZXRfdW5jaGVja2VkPHVzaXplLCB1c2l6ZT4AZ2V0X3VuY2hlY2tlZDx1NjQsIHVzaXplPgBnZXRfdW5jaGVja2VkX211dDxmNjQsIHVzaXplPgBnZXRfdW5jaGVja2VkPGY2NCwgdXNpemU+AGdldF91bmNoZWNrZWRfbXV0PGkzMiwgdXNpemU+AGdldF91bmNoZWNrZWQ8aTMyLCB1c2l6ZT4AZ2V0PGlzaXplPgB0cnlfd2l0aDxjb3JlOjpjZWxsOjpDZWxsPCh1c2l6ZSwgYm9vbCk+LCBzdGQ6OnBhbmlja2luZzo6cGFuaWNfY291bnQ6OmluY3JlYXNlOjp7Y2xvc3VyZV9lbnYjMH0sIGNvcmU6Om9wdGlvbjo6T3B0aW9uPHN0ZDo6cGFuaWNraW5nOjpwYW5pY19jb3VudDo6TXVzdEFib3J0Pj4AYXNfc3RyPHN0ZDo6cGFuaWNraW5nOjpiZWdpbl9wYW5pYzo6UGF5bG9hZDwmc3RyPj4AbmV4dDxjb3JlOjpvcHM6OnJhbmdlOjpSYW5nZUluY2x1c2l2ZTx1c2l6ZT4+AGdldF91bmNoZWNrZWQ8dTY0PgBnZXRfdW5jaGVja2VkX211dDxmNjQ+AGZyb21fcGFydHM8ZjY0PgBzY2FsYm48ZjY0PgBnZXRfdW5jaGVja2VkPGY2ND4AY2FzdF9mcm9tPHU2NCwgdTMyPgBjb250YWluczx1MzIsIHUzMj4AY29udGFpbnM8Y29yZTo6b3BzOjpyYW5nZTo6UmFuZ2U8dTMyPiwgdTMyLCB1MzI+AGdldF91bmNoZWNrZWRfbXV0PGkzMj4AZ2V0X3VuY2hlY2tlZDxpMzI+AHJlYWRfdm9sYXRpbGU8ZjMyPgBzZXQ8KHVzaXplLCBib29sKT4AZ2V0PCh1c2l6ZSwgYm9vbCk+AHJlcGxhY2U8KHVzaXplLCBib29sKT4AYmxhY2tfYm94PCgpPgB0cnlfd2l0aDxjb3JlOjpjZWxsOjpDZWxsPCh1c2l6ZSwgYm9vbCk+LCBzdGQ6OnBhbmlja2luZzo6cGFuaWNfY291bnQ6OmZpbmlzaGVkX3BhbmljX2hvb2s6OntjbG9zdXJlX2VudiMwfSwgKCk+AF9fcnVzdF9lbmRfc2hvcnRfYmFja3RyYWNlPHN0ZDo6cGFuaWNraW5nOjpiZWdpbl9wYW5pYzo6e2Nsb3N1cmVfZW52IzB9PCZzdHI+LCAhPgBsaWJyYXJ5L2NvbXBpbGVyLWJ1aWx0aW5zL2NvbXBpbGVyLWJ1aWx0aW5zL3NyYy9saWIucnMvQC9jb21waWxlcl9idWlsdGlucy4zMGNiZmJmNGVmNjg1Mzk1LWNndS4wNDkAbGlicmFyeS9jb21waWxlci1idWlsdGlucy9jb21waWxlci1idWlsdGlucy9zcmMvbGliLnJzL0AvY29tcGlsZXJfYnVpbHRpbnMuMzBjYmZiZjRlZjY4NTM5NS1jZ3UuMTI5AGxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjL2xpYi5ycy9AL2NvbXBpbGVyX2J1aWx0aW5zLjMwY2JmYmY0ZWY2ODUzOTUtY2d1LjAyOABsaWJyYXJ5L2NvbXBpbGVyLWJ1aWx0aW5zL2NvbXBpbGVyLWJ1aWx0aW5zL3NyYy9saWIucnMvQC9jb21waWxlcl9idWlsdGlucy4zMGNiZmJmNGVmNjg1Mzk1LWNndS4wMTgAbGlicmFyeS9jb21waWxlci1idWlsdGlucy9jb21waWxlci1idWlsdGlucy9zcmMvbGliLnJzL0AvY29tcGlsZXJfYnVpbHRpbnMuMzBjYmZiZjRlZjY4NTM5NS1jZ3UuMDk3AGxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjL2xpYi5ycy9AL2NvbXBpbGVyX2J1aWx0aW5zLjMwY2JmYmY0ZWY2ODUzOTUtY2d1LjAzNgBsaWJyYXJ5L2NvbXBpbGVyLWJ1aWx0aW5zL2NvbXBpbGVyLWJ1aWx0aW5zL3NyYy9saWIucnMvQC9jb21waWxlcl9idWlsdGlucy4zMGNiZmJmNGVmNjg1Mzk1LWNndS4wMDYAbGlicmFyeS9jb21waWxlci1idWlsdGlucy9jb21waWxlci1idWlsdGlucy9zcmMvbGliLnJzL0AvY29tcGlsZXJfYnVpbHRpbnMuMzBjYmZiZjRlZjY4NTM5NS1jZ3UuMTc1AGxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjL2xpYi5ycy9AL2NvbXBpbGVyX2J1aWx0aW5zLjMwY2JmYmY0ZWY2ODUzOTUtY2d1LjI4NABmNjQAbGlicmFyeS9jb21waWxlci1idWlsdGlucy9jb21waWxlci1idWlsdGlucy9zcmMvbGliLnJzL0AvY29tcGlsZXJfYnVpbHRpbnMuMzBjYmZiZjRlZjY4NTM5NS1jZ3UuMDU0AC9ydXN0Yy8yOTQ4Mzg4M2VlZDY5ZDVmYjRkYjAxOTY0Y2RmMmFmNGQ4NmU5Y2IyAGxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjL2xpYi5ycy9AL2NvbXBpbGVyX2J1aWx0aW5zLjMwY2JmYmY0ZWY2ODUzOTUtY2d1LjA4MgB3YXNtMzIAZjMyAGxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjL2xpYi5ycy9AL2NvbXBpbGVyX2J1aWx0aW5zLjMwY2JmYmY0ZWY2ODUzOTUtY2d1LjAzMgBsaWJyYXJ5L3BhbmljX2Fib3J0L3NyYy9saWIucnMvQC9wYW5pY19hYm9ydC5kN2ViNmMyNDAxOTBjM2VlLWNndS4wAGxpYnJhcnkvc3RkL3NyYy9saWIucnMvQC9zdGQuNTM3NjVkZjVkNjI1ZDQ2MS1jZ3UuMABjbGFuZyBMTFZNIChydXN0YyB2ZXJzaW9uIDEuODkuMCAoMjk0ODM4ODNlIDIwMjUtMDgtMDQpKQAAtUULLmRlYnVnX2xpbmUUAwAABADmAQAAAQEB+w4NAAEBAQEAAAABAAABbGlicmFyeS9zdGQvc3JjAGxpYnJhcnkvc3RkL3NyYy9zeXMAbGlicmFyeS9jb3JlL3NyYwBsaWJyYXJ5L2NvcmUvc3JjL3N5bmMAbGlicmFyeS9jb3JlL3NyYy9tZW0AbGlicmFyeS9zdGQvc3JjL3N5cy9zeW5jL3J3bG9jawBsaWJyYXJ5L3N0ZC9zcmMvdGhyZWFkAGxpYnJhcnkvc3RkL3NyYy9zeW5jL3BvaXNvbgBsaWJyYXJ5L3N0ZC9zcmMvc3lzL3BhbC93YXNtLy4uL3Vuc3VwcG9ydGVkAGxpYnJhcnkvcGFuaWNfYWJvcnQvc3JjAGxpYnJhcnkvc3RkL3NyYy9zeXMvcGVyc29uYWxpdHkAAHBhbmlja2luZy5ycwABAABiYWNrdHJhY2UucnMAAgAAaGludC5ycwADAABhdG9taWMucnMABAAAY2VsbC5ycwADAABtb2QucnMABQAAbm9fdGhyZWFkcy5ycwAGAABsb2NhbC5ycwAHAAByd2xvY2sucnMACAAAY29tbW9uLnJzAAkAAHByb2Nlc3MucnMAAQAAcnQucnMAAQAAbGliLnJzAAoAAHBhbmljLnJzAAMAAG1vZC5ycwALAAAABQEKAAUC/////wPXBQECDAABAQUFCgAFAv////8DgAYBAgwAAQEEAgUSCgAFAv////8DpwEBBAMFBQO6Ap4CAgABAQAFAv////8DgAYBBRIKCD4FCdUCFwABAQAFAv////8DmgYBBAQFGAoD8RgIPAQBBQwDoGQIugYD1Hw8BAUFEgYDoARmBAEFEAOTf3QEBQUSA+0ALgQBBRQDln/IBAYFCQPBAyAEBQUSA6l9dAYuBAcFDAYD9HuQBgNsWAQBBS0GA6oGIAUABgPWeQg8BAYFCQYD9wZmBAEDW3QFBWAGA6Z5dAIDAAEBBAoFBQoABQL/////AxsBAgIAAQEEDgAFAv////8DuwEBBQYKWgIEAAEBBA8FDQoABQL/////AxoBAgIAAQE8AAAABAA2AAAAAQEB+w4NAAEBAQEAAAABAAABbGlicmFyeS9wYW5pY19hYm9ydC9zcmMAAGxpYi5ycwABAAAAWAIAAAQADAEAAAEBAfsODQABAQEBAAAAAQAAAWxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjL21hdGgvLi4vLi4vLi4vbGlibS9zcmMvbWF0aABsaWJyYXJ5L2NvcmUvc3JjL29wcwBsaWJyYXJ5L2NvcmUvc3JjL3B0cgBsaWJyYXJ5L2NvcmUvc3JjL251bQBsaWJyYXJ5L2NvcmUvc3JjL3NsaWNlAABleHAyZi5ycwABAAByYW5nZS5ycwACAABtb2QucnMAAwAAZjMyLnJzAAQAAGluZGV4LnJzAAUAAG1vZC5ycwABAABmNjQucnMABAAAbW9kLnJzAAUAAAAABQL/////A8wAAQUOCgMOCPIFCJEGA6R/PAUPBgPxAIIGA49/PAUQBgPzAHQFAgMUIAYD+X4gBQwGA94AyAYDon88BAIFCQYDsgaeBAEFDAOweiAGA55/LgYD5wBKBgOZfzwFEAYD6QCCBgOXfzwFJQPpAGYFJCADl388BR0GA+oAdAQDBQkDyg9mBAEFEAO4cGYGA5R/LgUNBgPkAIIGA5x/PAUCBgOHASAGA/l+PAUdBgPqAIIEAwUJA8oPZgQBBQID03CsBgP5fiAFGwYD9wCCBAQFEgPNByAEAQUFA7V4WFsEBQUNA/4APAQGBRIDkH6CBAEFBQP0ANYFEiEFJ8wFGgaeBRIGHwUWWQUSBjwFU7oFRp4FPCAFOFgFEkoFDQYDd1gFH0sFHgYgBAcFEgYD9gdKBAEFBQOVeCAFAi8CAQABAecCAAAEAIgBAAABAQH7Dg0AAQEBAQAAAAEAAAFsaWJyYXJ5L2NvbXBpbGVyLWJ1aWx0aW5zL2NvbXBpbGVyLWJ1aWx0aW5zL3NyYwBsaWJyYXJ5L2NvbXBpbGVyLWJ1aWx0aW5zL2NvbXBpbGVyLWJ1aWx0aW5zL3NyYy9tYXRoLy4uLy4uLy4uL2xpYm0vc3JjL21hdGgAbGlicmFyeS9jb3JlL3NyYy9vcHMAbGlicmFyeS9jb3JlL3NyYy9wdHIAbGlicmFyeS9jb3JlL3NyYy9udW0AbGlicmFyeS9jb3JlL3NyYy9zbGljZQBsaWJyYXJ5L2NvbXBpbGVyLWJ1aWx0aW5zL2NvbXBpbGVyLWJ1aWx0aW5zL3NyYy9tYXRoAABtYWNyb3MucnMAAQAAZXhwMmYucnMAAgAAcmFuZ2UucnMAAwAAbW9kLnJzAAQAAGYzMi5ycwAFAABpbmRleC5ycwAGAABtb2QucnMAAgAAZjY0LnJzAAUAAG1vZC5ycwAHAABtb2QucnMABgAAAAAFAtkEAAAD3QMBBAIFDgoD/XwI8gUIkQYDpH88BQ8GA/EAggYDj388BRAGA/MAdAQBBQ4D7gIgBgOffCAEAgUMBgPeAMgGA6J/PAQDBQkGA7IGngQCBQwDsHogBgOefy4GA+cASgYDmX88BRAGA+kAggYDl388BSUD6QBmBSQgA5d/PAUdBgPqAHQEBAUJA8oPZgQCBRADuHBmBgOUfy4FDQYD5ACCBgOcfzwEAQUOBgPhAyAGA598PAQCBR0GA+oAggQEBQkDyg9mBAEFDgOtc6wGA598IAQCBRsGA/cAggQFBRIDzQcgBAIFBQO1eFhbBAYFDQP+ADwEBwUSA5B+ggQCBQUD9ADWBRIhBSfMBRoGngUSBh8FFlkFEgY8BVO6BUaeBTwgBThYBRJKBQ0GA3dYBR9LBR4GIAQIBRIGA/YHSgQCBQUDlXggBAEFDgPbAi4CAQABAQgBAAAEAAIBAAABAQH7Dg0AAQEBAQAAAAEAAAFsaWJyYXJ5L2NvbXBpbGVyLWJ1aWx0aW5zL2NvbXBpbGVyLWJ1aWx0aW5zL3NyYy9tYXRoLy4uLy4uLy4uL2xpYm0vc3JjL21hdGgAbGlicmFyeS9jb3JlL3NyYy9vcHMAbGlicmFyeS9jb3JlL3NyYy9wdHIAbGlicmFyeS9jb3JlL3NyYy9udW0AbGlicmFyeS9jb3JlL3NyYy9zbGljZQAAZXhwMmYucnMAAQAAcmFuZ2UucnMAAgAAbW9kLnJzAAMAAGYzMi5ycwAEAABpbmRleC5ycwAFAABtb2QucnMABQAAZjY0LnJzAAQAAABXAAAABABRAAAAAQEB+w4NAAEBAQEAAAABAAABbGlicmFyeS9jb21waWxlci1idWlsdGlucy9jb21waWxlci1idWlsdGlucy9zcmMAAG1hY3Jvcy5ycwABAAAAfA4AAAQA/gIAAAEBAfsODQABAQEBAAAAAQAAAWxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjL21hdGgvLi4vLi4vLi4vbGlibS9zcmMvbWF0aABsaWJyYXJ5L2NvcmUvc3JjL3NsaWNlAGxpYnJhcnkvY29yZS9zcmMvb3BzAGxpYnJhcnkvY29yZS9zcmMAbGlicmFyeS9jb3JlL3NyYy9pdGVyAGxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjL21hdGgvLi4vLi4vLi4vbGlibS9zcmMvbWF0aC9nZW5lcmljAGxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjL21hdGgv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YWxibi5ycwABAABzY2FsYm4ucnMAAgAAYXJpdGgucnMAAwAAAH8AAAAEAHkAAAABAQH7Dg0AAQEBAQAAAAEAAAFsaWJyYXJ5L2NvbXBpbGVyLWJ1aWx0aW5zL2NvbXBpbGVyLWJ1aWx0aW5zL3NyYy9tYXRoLy4uLy4uLy4uL2xpYm0vc3JjL21hdGgvc3VwcG9ydAAAaW50X3RyYWl0cy5ycwABAAAAvwAAAAQAuQAAAAEBAfsODQABAQEBAAAAAQAAAWxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjL21hdGgvLi4vLi4vLi4vbGlibS9zcmMvbWF0aC9zdXBwb3J0AGxpYnJhcnkvY29yZS9zcmMvb3BzAGxpYnJhcnkvY29yZS9zcmMvbnVtAABmbG9hdF90cmFpdHMucnMAAQAAYml0LnJzAAIAAGY2NC5ycwADAAAAvQAAAAQAtwAAAAEBAfsODQABAQEBAAAAAQAAAWxpYnJhcnkvY29yZS9zcmMvLi4vLi4vc3RkYXJjaC9jcmF0ZXMvY29yZV9hcmNoL3NyYy93YXNtMzIAbGlicmFyeS9jb21waWxlci1idWlsdGlucy9jb21waWxlci1idWlsdGlucy9zcmMvbWF0aC8uLi8uLi8uLi9saWJtL3NyYy9tYXRoL2FyY2gAAG1vZC5ycwABAAB3YXNtMzIucnMAAgAAAHIAAAAEAGwAAAABAQH7Dg0AAQEBAQAAAAEAAAFsaWJyYXJ5L2NvbXBpbGVyLWJ1aWx0aW5zL2NvbXBpbGVyLWJ1aWx0aW5zL3NyYy9tYXRoLy4uLy4uLy4uL2xpYm0vc3JjL21hdGgAAGZsb29yLnJzAAEAAAABBQAABAAXAQAAAQEB+w4NAAEBAQEAAAABAAABbGlicmFyeS9jb21waWxlci1idWlsdGlucy9jb21waWxlci1idWlsdGlucy9zcmMvbWF0aC8uLi8uLi8uLi9saWJtL3NyYy9tYXRoAGxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjAGxpYnJhcnkvY29yZS9zcmMvbnVtAGxpYnJhcnkvY29yZS9zcmMvcHRyAABzaW5mLnJzAAEAAHJlbV9waW8yZi5ycwABAABsaWIucnMAAgAAZjMyLnJzAAMAAGtfY29zZi5ycwABAABrX3NpbmYucnMAAQAAbW9kLnJzAAQAAG1vZC5ycwABAAAAAAUC0hUAAAMeAQUPCgjJBQUIQgUIkgYDWDwGAzaeBgNKPAYDxgCeBgO6fzwGA9QACCAGA6x/PAQCBRwGAydKBQjoBgNVPAUTBgMuyAhBBSO7BR0GIAUyugUdIAURPAQDBQADTGYEAgUPBgM8rAUOBkoFIQZZBRwGIAQEBRIGA7YIIAQCBQUDyncgBQ2DBAEFEANnCIIEAgUIAxogBQkxBQJ1BgO9fy4FEQYDwAA8BRYGWAUVWANAPAQBBQsGA9oAWAUFBiADpn90BRAGA9UAIAQDBQAGA6t/dAQFBQ0GAxk8BQ71BQcGngUNBh4FGPQFBgYgBSIgBRIG8QUNBp4FIgYhBQUGIAQBBQ4GA8IALgUXBjwDon8uBAYFDQYDGSB3OgUgdwUSuAUNBp4FIAYiBRUG8gUPngULIAUGIAUFIAQBBRYGAz5KBgOlfy4EBQUNBgMZIAUO9QUHBp4FDQYeBRj0BQYGIAUiIAUSBvEFDQaeBSIGIQUFBiAEAQUWBgPAAEoGA6R/LgQGBQ0GAxkgBAEFFQPEAFgEBgUNA79/WB4FIHcFErgFDQaeBSAGIgUVBtYFD54FCyAFBiAFBTwDY2YEAQUMBgPIAKwGA7h/PAUQBgMlCFgFGgMrIAQGBQ0DSUp3OgUgdwUSuAUNBp4FIAYiBRUG8gUPngULIAUGIAUFIAQBBQkGAzNKBgOwfy4FEAYDJXQDJSAGA7Z/LgUgBgPNAKwEBQUNA0wgBQ71BQcGngUNBh4FGPQFBgYgBSIgBRIG8QUNBp4FIgYhBQUGIAQBBRgGAzEuBREGPAOzfy4FHwYDywC6BAUFDQNOIAUO9QUHBp4FDQYeBRj0BQYGIAUiIAUSBvEFDQaeBSIGIQUFBiAEAQURBgMvSgYDtX8uBQwGAzisBgNIPAUQBgMlCFgFGgMbIAQGBQ0DWUoEAQUaAydYBAYFDQNcWB4FIHcFErgFDQaeBSAGIgUVBtYFD54FCyAFBiAFBTwEAQUJBgMjSgYDQC4FEAYDJXQDFSAGA0YuBR8GAz2sBAUFDQNcIAUO9QUHBp4FDQYeBRj0BQYGIAUiIAUSBvEFDQaeBSIGIQUFBiAEAQURBgMhSgYDQy4FIAYDO7oEBQUNA14gBQ71BQcGngUNBh4FGPQFBgYgBSIgBRIG8QUNBp4FIgYhBQUGIAQBBRgGAx8uBREGPANFLgUMBgMqrAQGBQ0DbzxbVgUgdwUSuAUNBp4FIAYiBRUG1gUPngULIAUGIAUFPAQBBQkGAxdKBgNMLgUcBgMtngUABgNTCCAEBwUJBgO0EDwGA8xvZgQBBQIGA+AAIAIOAAEBlQAAAAQAjwAAAAEBAfsODQABAQEBAAAAAQAAAWxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjL21hdGgvLi4vLi4vLi4vbGlibS9zcmMvbWF0aABsaWJyYXJ5L2NvcmUvc3JjL251bQAAcmVtX3BpbzJmLnJzAAEAAGYzMi5ycwACAAAAsAAAAAQAkAAAAAEBAfsODQABAQEBAAAAAQAAAWxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjL21hdGgAbGlicmFyeS9jb21waWxlci1idWlsdGlucy9jb21waWxlci1idWlsdGlucy9zcmMAAG1vZC5ycwABAABtYWNyb3MucnMAAgAAAAUVCgAFAjobAAADDAEEAgUOA9QDggIBAAEBVwAAAAQAUQAAAAEBAfsODQABAQEBAAAAAQAAAWxpYnJhcnkvY29tcGlsZXItYnVpbHRpbnMvY29tcGlsZXItYnVpbHRpbnMvc3JjAABtYWNyb3MucnMAAQAAAAC4AgRuYW1lABAPc2lkX2VuZ2luZS53YXNtAfcBCwAEaW5pdAEHbm90ZV9vbgIIbm90ZV9vZmYDCnNldF9maWx0ZXIECnNldF9nbG9iYWwFDmdldF9idWZmZXJfcHRyBgZyZW5kZXIHBWV4cDJmCFlfWk4xN2NvbXBpbGVyX2J1aWx0aW5zNG1hdGg5bGlibV9tYXRoMTRyZW1fcGlvMl9sYXJnZTE0cmVtX3BpbzJfbGFyZ2UxN2hlMTAzMDNhYWFlODUyZmFkRQlDX1pOMTdjb21waWxlcl9idWlsdGluczRtYXRoOWxpYm1fbWF0aDRzaW5mNHNpbmYxN2gzNzY1MDIwYzE2NjJhNzFmRQoEc2luZgcSAQAPX19zdGFja19wb2ludGVyCRECAAcucm9kYXRhAQUuZGF0YQBNCXByb2R1Y2VycwIIbGFuZ3VhZ2UBBFJ1c3QADHByb2Nlc3NlZC1ieQEFcnVzdGMdMS44OS4wICgyOTQ4Mzg4M2UgMjAyNS0wOC0wNCkAlAEPdGFyZ2V0X2ZlYXR1cmVzCCsLYnVsay1tZW1vcnkrD2J1bGstbWVtb3J5LW9wdCsWY2FsbC1pbmRpcmVjdC1vdmVybG9uZysKbXVsdGl2YWx1ZSsPbXV0YWJsZS1nbG9iYWxzKxNub250cmFwcGluZy1mcHRvaW50Kw9yZWZlcmVuY2UtdHlwZXMrCHNpZ24tZXh0';
let webSidBytes=null;
let webSidWorkletLoaded=false;
async function ensureWebSid(){
  if(!webSidWorkletLoaded){
    const blob=new Blob([sidWorkletCode],{type:'application/javascript'});
    await ctx.audioWorklet.addModule(URL.createObjectURL(blob));
    webSidWorkletLoaded=true;
  }
}
async function loadWebSidBytes(){
  if(webSidBytes) return webSidBytes;
  const bin=atob(SID_WASM_BASE64);
  webSidBytes=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) webSidBytes[i]=bin.charCodeAt(i);
  return webSidBytes;
}

const webSidState={
  node:null,
  ready:false,
  initPromise:null,
  pendingParams:new Map(),
  pendingEvents:[],
  outputTarget:null
};
const webSidParamOrder=['setFilter','setGlobal','setMaster'];

function queueWebSidParam(msg){
  if(!webSidState.node) return;
  if(!webSidState.ready){
    webSidState.pendingParams.set(msg.type, msg);
  } else {
    webSidState.node.port.postMessage(msg);
  }
}

function queueWebSidEvent(msg){
  if(!webSidState.node) return;
  if(!webSidState.ready){
    webSidState.pendingEvents.push(msg);
  } else {
    webSidState.node.port.postMessage(msg);
  }
}

function flushWebSidQueues(){
  if(!webSidState.node || !webSidState.ready) return;
  webSidParamOrder.forEach(type=>{
    const msg=webSidState.pendingParams.get(type);
    if(msg){ webSidState.node.port.postMessage(msg); webSidState.pendingParams.delete(type); }
  });
  webSidState.pendingParams.forEach(msg=>{ webSidState.node.port.postMessage(msg); });
  webSidState.pendingParams.clear();
  while(webSidState.pendingEvents.length){
    webSidState.node.port.postMessage(webSidState.pendingEvents.shift());
  }
}

function disposeWebSidNode(){
  const node=webSidState.node;
  if(node){
    try{ if(webSidState.outputTarget) node.disconnect(webSidState.outputTarget); }catch(_){ }
    try{ node.disconnect(); }catch(_){ }
    node.port.onmessage=null;
    node.onprocessorerror=null;
  }
  webSidState.node=null;
  webSidState.ready=false;
  webSidState.outputTarget=null;
  webSidState.initPromise=null;
  webSidState.pendingParams.clear();
  webSidState.pendingEvents.length=0;
  if(typeof voices!=='undefined'){
    voices.forEach(v=>{ if(v.sidNode) delete v.sidNode; v.sidReady=false; v.nextId=0; });
  }
}

function syncWebSidParams(){
  const filterMode=filterModeMap[state.filter]||0;
  const cutoff=sanitizeCutoff(valNum('sidCutoff',1700));
  const q=sanitizeResonance(valNum('sidRes',5));
  const pwmRate=sanitizeLfoRate(valNum('sidPWMRate',3));
  const pwmDepth=sanitizePwmDepth(valNum('sidPWMDepth',0.25));
  const vibRate=sanitizeLfoRate(valNum('vibRate',5));
  const vibCents=sanitizeLfoDepth(valNum('vibAmt',8));
  const masterValue=sanitizeMaster(master.gain.value);
  queueWebSidParam({type:'setFilter', mode:filterMode, cutoff, q});
  queueWebSidParam({type:'setGlobal', pwmRate, pwmDepth, vibRate, vibCents, master:masterValue});
  queueWebSidParam({type:'setMaster', master:masterValue});
}

function handleWebSidMessage(e){
  const data=e.data||{};
  const type=data.type;
  if(type==='wasmReady' && state.engine!=='websid'){
    disposeWebSidNode();
    return;
  }
  if(type==='wasmReady'){
    console.log('webSID ready');
    if(webSidState.node){ webSidState.node.port.postMessage({type:'wasmReadyAck'}); }
    webSidState.ready=true;
    if(typeof voices!=='undefined'){
      voices.forEach(v=>{ v.sidNode=webSidState.node; v.sidReady=true; v.nextId=0; });
    }
    syncWebSidParams();
    updateWebSidRouting();
    flushWebSidQueues();
    return;
  }
  if(type==='underrun'){
    console.warn('SID underrun');
    return;
  }
  if(type==='wasmError'){
    console.warn('webSID error', data.message);
    showBanner('webSID \u2192 Hybrid');
    setEngine('classic').catch(()=>{});
  }
}

async function ensureWebSidNode(){
  if(webSidState.node) return webSidState.node;
  if(webSidState.initPromise) return webSidState.initPromise;
  const promise=(async ()=>{
    await ensureWebSid();
    const node=new AudioWorkletNode(ctx,'sid-processor',{
      numberOfInputs:0,
      outputChannelCount:[2],
      channelCount:2,
      channelCountMode:'explicit',
      channelInterpretation:'speakers'
    });
    node.port.onmessage=handleWebSidMessage;
    node.onprocessorerror=e=>{
      console.warn('SID processor error', e);
      showBanner('webSID \u2192 Hybrid');
      setEngine('classic').catch(()=>{});
    };
    const target=(typeof voices!=='undefined' && voices.length>0)?voices[0].gain:master;
    webSidState.outputTarget=target;
    if(target) node.connect(target);
    webSidState.node=node;
    webSidState.ready=false;
    webSidState.pendingParams.clear();
    webSidState.pendingEvents.length=0;
    if(typeof voices!=='undefined'){
      voices.forEach(v=>{ v.sidNode=node; v.sidReady=false; v.nextId=0; });
    }
    const bytes=await loadWebSidBytes();
    node.port.postMessage({type:'loadWasm', bytes, sampleRate:ctx.sampleRate});
    return node;
  })();
  webSidState.initPromise=promise.then(node=>{ webSidState.initPromise=null; return node; }).catch(err=>{
    webSidState.initPromise=null;
    throw err;
  });
  return webSidState.initPromise;
}

function showBanner(msg){
  const msgEl=document.createElement('div');
  msgEl.textContent=msg;
  Object.assign(msgEl.style,{
    position:'fixed',top:'10px',left:'50%',transform:'translateX(-50%)',
    background:'rgba(0,0,0,0.8)',color:'var(--c64-accent)',padding:'8px 12px',
    border:'2px solid var(--c64-border)',borderRadius:'8px',zIndex:10000
  });
  document.body.appendChild(msgEl);
  setTimeout(()=>msgEl.remove(),4000);
}


function updateWebSidRouting(){
  if(state.engine!=='websid') return;
  const node=webSidState.node;
  if(!node) return;
  const crushOn=get('crush')?get('crush').checked:false;
  const firstVoice=voices[0];
  const targetGain=firstVoice?firstVoice.gain:master;
  if(!targetGain) return;
  const desiredTarget=crushOn?crusher:targetGain;
  if(webSidState.outputTarget!==desiredTarget){
    try{
      if(webSidState.outputTarget) node.disconnect(webSidState.outputTarget);
    }catch(_){ }
    try{ node.connect(desiredTarget); }catch(_){ }
    webSidState.outputTarget=desiredTarget;
  }
  if(crushOn && !crusherOutputs.has(targetGain)){
    crusher.connect(targetGain);
    crusherOutputs.add(targetGain);
  }
}

const filterModeMap = { off:0, lowpass:1, highpass:2, bandpass:3 };

// Global synth state
const state = {
  wave: 'pulse',
  filter: 'lowpass',
  audioReady: false,
  engine: 'classic'
};
const ENGINE_STORAGE_KEY = 'c64piano_engine';
const engineSel = get('engineSel');

function toNumber(value){ return typeof value==='number'?value:parseFloat(value); }
function finiteOr(value, fallback){ const num=toNumber(value); return Number.isFinite(num)?num:fallback; }
function clampValue(value, min, max){ return Math.min(max, Math.max(min, value)); }
function sanitizeFrequency(v){ return clampValue(finiteOr(v, 440), 1, 20000); }
function sanitizePulseWidth(v){ return clampValue(finiteOr(v, 0.5), 0.02, 0.98); }
function sanitizeAdsr(v, fallback){ return Math.max(0, finiteOr(v, fallback)); }
function sanitizeSustain(v){ return clampValue(finiteOr(v, 0.5), 0, 1); }
function sanitizeLfoRate(v){ return Math.max(0, finiteOr(v, 0)); }
function sanitizeLfoDepth(v){ return clampValue(finiteOr(v, 0), -2400, 2400); }
function sanitizePwmDepth(v){ return clampValue(finiteOr(v, 0), 0, 0.96); }
function sanitizeMaster(v){ return clampValue(finiteOr(v, 0.2), 0, 1.5); }
function sanitizeCutoff(v){ return clampValue(finiteOr(v, 1000), 20, 20000); }
function sanitizeResonance(v){ return clampValue(finiteOr(v, 1), 0.1, 20); }

// Voices and oscilloscopes
const oscWrap = document.getElementById('oscWrap');
const voices = [];

function resizeOsc(){
  const h = window.innerHeight / (voices.length || 1);
  voices.forEach(v=>{
    v.canvas.width = window.innerWidth;
    v.canvas.height = h;
  });
}
window.addEventListener('resize', resizeOsc);

function drawVoice(v){
  function draw(){
    requestAnimationFrame(draw);
    const analyserNode=(state.engine==='websid' && voices[0])?voices[0].analyser:v.analyser;
    analyserNode.getByteTimeDomainData(v.data);
    v.ctx.fillStyle='rgba(0,0,0,0.05)';
    v.ctx.fillRect(0,0,v.canvas.width,v.canvas.height);
    v.ctx.lineWidth=2;
    v.ctx.strokeStyle='rgba(214,224,255,0.6)';
    v.ctx.beginPath();
    const slice=v.canvas.width/v.data.length;
    let x=0;
    for(let i=0;i<v.data.length;i++){
      const y=(v.data[i]/128)*v.canvas.height/2;
      if(i===0) v.ctx.moveTo(x,y); else v.ctx.lineTo(x,y);
      x+=slice;
    }
    v.ctx.stroke();
  }
  draw();
}

function addVoice(){
  const gain=ctx.createGain(); gain.gain.value=1;
  const analyser=ctx.createAnalyser(); analyser.fftSize=2048;
  gain.connect(analyser); analyser.connect(master);
  const canvas=document.createElement('canvas'); canvas.className='osc'; oscWrap.appendChild(canvas);
  const g=canvas.getContext('2d');
  const data=new Uint8Array(analyser.fftSize);
  const shared=voices[0];
  const patterns=shared?shared.patterns:Array(8).fill(0).map(()=>[]);
  const patternNames=shared?shared.patternNames:Array(8).fill(0).map((_,i)=>'Pattern '+(i+1));
  const voice={gain, analyser, canvas, ctx:g, data, patterns, patternNames, playTimeouts:[], sidReady:false, sidNode:null, nextId:0};
  voice.trackerTrack=0;
  if(state.engine==='websid' && webSidState.node){
    voice.sidNode=webSidState.node;
    voice.sidReady=webSidState.ready;
    voice.nextId=0;
  }
  voices.push(voice);
  if(voices.length===1){
    populatePatternSelect();
    showPattern();
  }
  resizeOsc();
  drawVoice(voice);
  if(state.engine==='websid') updateWebSidRouting();
  populateTrackerSelects();
  renderTracker(voices.length-1);
}


const stopBtn = get('stopPatternBtn');
const playBtn = get('playPatternBtn');
const clearBtn = get('clearPatternBtn');
const saveBtn = get('savePatternBtn');
const loadBtn = get('loadPatternBtn');
const patternSel = get('patternSel');
const stepResSel = get('stepResSel');
const patternLenInput = get('patternLen');
const drumLenInput = get('drumLen');
const patternStatus = get('patternStatus');

// Pattern editor note data
let history = [];                // {note,row,start,dur}
const patternGrid = document.getElementById('patternGrid');
const cursorEl=document.createElement('div');
cursorEl.className='patternCursor';
let cursor={row:0,col:0};
const noteOrder = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
let patternRows = 12, patternCols = 16;
let drag = null; // current drag state

function removeOverlaps(entry){
  history = history.filter(h=>h===entry || h.start>=entry.start+entry.dur || entry.start>=h.start+h.dur);
}

function gridCols(){
  return (parseInt(stepResSel.value)||16) * (parseInt(patternLenInput.value)||1);
}

function drumCols(){
  return 16 * (parseInt(drumLenInput.value)||1);
}

function stepSeconds(){
  return (60/valNum('bpm',120))*4/(parseInt(stepResSel.value)||16);
}

function ensureCursorVisible(){
  const idx=cursor.row*patternCols+cursor.col;
  const cell=patternGrid.children[idx];
  if(cell) cell.scrollIntoView({block:'nearest', inline:'nearest'});
}

function updateStatus(){
  let info=`Step ${cursor.col+1}/${patternCols} | Note ${noteOrder[cursor.row]}`;
  const h=history.find(h=>h.row===cursor.row && cursor.col>=h.start && cursor.col<h.start+h.dur);
  if(h) info+=` | Len ${h.dur}`;
  info+=` | Time ${(cursor.col*stepSeconds()).toFixed(2)}s`;
  patternStatus.textContent=info;
}

function updateStatusPlayback(now,startAt){
  patternStatus.textContent=`Time ${(now-startAt).toFixed(2)}s`;
}

function updateCursor(){
  cursorEl.style.gridRowStart=cursor.row+1;
  cursorEl.style.gridColumnStart=cursor.col+1;
  ensureCursorVisible();
  updateStatus();
}

const playhead=document.createElement('div');
playhead.className='playhead';
let playheadRAF=null;

function startPlayhead(duration, startAt){
  stopPlayhead();
  playhead.style.left='0%';
  patternGrid.appendChild(playhead);
  const endAt=startAt+duration;
  const step=()=>{
    const now=ctx.currentTime;
    if(now>=endAt){ stopPlayhead(); return; }
    const p=(now-startAt)/duration;
    playhead.style.left=(p*100)+"%";
    updateStatusPlayback(now,startAt);
    playheadRAF=requestAnimationFrame(step);
  };
  playheadRAF=requestAnimationFrame(step);
}

function stopPlayhead(){
  if(playheadRAF){ cancelAnimationFrame(playheadRAF); playheadRAF=null; }
  if(playhead.parentNode) playhead.remove();
  playhead.style.left='0%';
  updateCursor();
}

function renderPattern(){
  patternGrid.querySelectorAll('.patternNote').forEach(el=>el.remove());
  history.forEach((h,i)=>{
    const el=document.createElement('div');
    el.className='patternNote';
    el.style.gridRowStart=h.row+1;
    el.style.gridColumnStart=h.start+1;
    el.style.gridColumnEnd=h.start+h.dur+1;
    el.dataset.index=i;
    patternGrid.appendChild(el);
  });
  patternGrid.appendChild(cursorEl);
  updateCursor();
}

function cellFromEvent(e){
  const rect=patternGrid.getBoundingClientRect();
  const x=e.clientX-rect.left+patternGrid.scrollLeft;
  const y=e.clientY-rect.top+patternGrid.scrollTop;
  const col=Math.floor(x/rect.width*patternCols);
  const row=Math.floor(y/rect.height*patternRows);
  return {col:Math.max(0,Math.min(patternCols-1,col)), row:Math.max(0,Math.min(patternRows-1,row))};
}

function buildPatternGrid(rows = 12, cols = gridCols()) {
  patternRows = rows; patternCols = cols;
  patternGrid.innerHTML = '';
  patternGrid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
  patternGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      const cell = document.createElement('div');
      cell.className = 'patternCell';
      patternGrid.appendChild(cell);
    }
  }
  cursor.row=Math.min(cursor.row, rows-1);
  cursor.col=Math.min(cursor.col, cols-1);
  renderPattern();
}

function fmtTime(sec){ return (sec).toFixed(3)+'s'; }
function fmtNote(n, o){ return n + (o>0? ('+'+o) : (o<0? o : '')); }

function startDrag(e){
  if(e.button!==0) return;
  e.preventDefault();
  if(e.target.classList.contains('patternNote')){
    const idx=parseInt(e.target.dataset.index);
    const h=history[idx];
    const rect=e.target.getBoundingClientRect();
    const resize=(e.clientX-rect.right)>=-6 && (e.clientX-rect.right)<=6;
    drag={mode:resize?'resize':'move', index:idx, el:e.target, startCol:h.start, startRow:h.row, startDur:h.dur, dur:h.dur, row:h.row, col:h.start, moved:false};
    cursor.row=h.row; cursor.col=h.start;
  }else{
    const {row,col}=cellFromEvent(e);
    const el=document.createElement('div');
    el.className='patternNote';
    el.style.gridRowStart=row+1;
    el.style.gridColumnStart=col+1;
    el.style.gridColumnEnd=col+2;
    patternGrid.appendChild(el);
    drag={mode:'create', el, startCol:col, startRow:row, dur:1, moved:false};
    cursor.row=row; cursor.col=col;
  }
  updateCursor();
  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);
}

function onMouseMove(e){
  if(!drag) return;
  drag.moved=true;
  if(drag.mode==='move'){
    const {row,col}=cellFromEvent(e);
    const start=Math.min(Math.max(0,col), patternCols-drag.startDur);
    drag.el.style.gridRowStart=row+1;
    drag.el.style.gridColumnStart=start+1;
    drag.el.style.gridColumnEnd=start+drag.startDur+1;
    drag.row=row; drag.col=start;
  }else{
    const {col}=cellFromEvent(e);
    const end=Math.max(drag.startCol, Math.min(col, patternCols-1));
    drag.dur=end-drag.startCol+1;
    drag.el.style.gridColumnEnd=drag.startCol+drag.dur+1;
  }
  if(drag.mode==='move'){ cursor.row=drag.row; cursor.col=drag.col; }
  else { cursor.row=drag.startRow; cursor.col=drag.startCol; }
  updateCursor();
}

function onMouseUp(){
  if(!drag) return;
  if(drag.mode==='create'){
    const noteName=noteOrder[drag.startRow];
    const entry={note:noteName,row:drag.startRow,start:drag.startCol,dur:drag.dur};
    history.push(entry);
    removeOverlaps(entry);
    drag.el.dataset.index=history.indexOf(entry);
  }else if(drag.mode==='move'){
    if(!drag.moved){
      history.splice(drag.index,1);
    }else{
      const h=history[drag.index];
      h.row=drag.row; h.start=drag.col; h.note=noteOrder[drag.row];
      removeOverlaps(h);
    }
  }else if(drag.mode==='resize'){
    const h=history[drag.index];
    h.dur=drag.dur;
    removeOverlaps(h);
  }
  drag=null;
  document.removeEventListener('mousemove', onMouseMove);
  document.removeEventListener('mouseup', onMouseUp);
  renderPattern();
}

function insertNoteAtCursor(){
  const existing=history.find(h=>h.row===cursor.row && cursor.col>=h.start && cursor.col<h.start+h.dur);
  if(!existing){
    const entry={note:noteOrder[cursor.row], row:cursor.row, start:cursor.col, dur:1};
    history.push(entry);
    removeOverlaps(entry);
    renderPattern();
  }
}

function deleteNoteAtCursor(){
  const idx=history.findIndex(h=>h.row===cursor.row && cursor.col>=h.start && cursor.col<h.start+h.dur);
  if(idx>=0){
    history.splice(idx,1);
    renderPattern();
  }
}

patternGrid.addEventListener('mousedown', startDrag);

stepResSel.addEventListener('change', ()=>{ buildPatternGrid(); voices.forEach((_,i)=>renderTracker(i)); });
patternLenInput.addEventListener('input', ()=>{ buildPatternGrid(); voices.forEach((_,i)=>renderTracker(i)); });
drumLenInput.addEventListener('input', ()=>{ buildGrid(); });

buildPatternGrid();

function populatePatternSelect(){
  const v=voices[0];
  patternSel.innerHTML='';
  for(let i=0;i<v.patterns.length;i++){
    const o=document.createElement('option');
    o.value=i;
    o.textContent=v.patternNames[i]||('Pattern '+(i+1));
    patternSel.appendChild(o);
  }
  populateTrackerSelects();
}

function selectedPatternIndex(){ return parseInt(patternSel.value)||0; }

function showPattern(){
  const v=voices[0];
  const p=v.patterns[selectedPatternIndex()]||[];
  history=[]; buildPatternGrid();
  const stepSec=stepSeconds();
  p.forEach(ev=>{
    if(ev.type==='note'){
      const row=noteOrder.indexOf(ev.note);
      const start=Math.round(ev.t0/stepSec);
      const dur=Math.max(1,Math.round(ev.dur/stepSec));
      history.push({note:ev.note,row,start,dur});
    }
  });
  renderPattern();
  voices.forEach((_,i)=>renderTracker(i));
}

function historyToPattern(){
  const stepSec=stepSeconds();
  return history
    .filter(h=>h.start!=null)
    .map(h=>({type:'note', note:h.note, t0:h.start*stepSec, dur:h.dur*stepSec, params:snapshotParams()}));
}

function savePattern(){
  const v=voices[0];
  const idx=selectedPatternIndex();
  const name=prompt('Pattern name?', v.patternNames[idx]||'');
  if(name===null) return;
  v.patternNames[idx]=name||('Pattern '+(idx+1));
  v.patterns[idx] = historyToPattern();
  populatePatternSelect();
  patternSel.value=idx;
  showPattern();
}

function loadPatternByName(){
  const v=voices[0];
  const name=prompt('Load pattern name?', v.patternNames.join(', '));
  if(!name) return;
  const idx=v.patternNames.indexOf(name);
  if(idx>=0){ patternSel.value=idx; showPattern(); }
}

function playSelected(){
  const v=voices[0];
  playPattern(v, historyToPattern());
}

function clearPattern(){
  const v=voices[0];
  v.patterns[selectedPatternIndex()] = [];
  history=[]; buildPatternGrid();
  populateTrackerSelects();
  voices.forEach((_,i)=>renderTracker(i));
}

function populateTrackerSelects(){
  document.querySelectorAll('.trackerTrackSel').forEach(sel=>{
    const idx=parseInt(sel.dataset.voice);
    const v=voices[idx];
    sel.innerHTML='';
    if(!v) return;
    for(let i=0;i<v.patterns.length;i++){
      const o=document.createElement('option');
      o.value=i; o.textContent=v.patternNames[i]||('Pattern '+(i+1)); sel.appendChild(o);
    }
    sel.value=v.trackerTrack||0;
  });
}

function renderTracker(idx){
  const v=voices[idx]; if(!v) return;
  const track=v.trackerTrack||0;
  const el=get('tracker'+(idx+1));
  el.innerHTML='';
  const p=v.patterns[track]||[];
  const stepSec=stepSeconds();
  const steps=gridCols();
  for(let s=0;s<steps;s++){
    const row=document.createElement('div');
    row.className='trackerRow';
    const ev=p.find(ev=>ev.type==='note' && Math.round(ev.t0/stepSec)===s);
    row.textContent=ev?`${fmtNote(ev.note,0)} @ ${ev.t0.toFixed(2)}s`:'';
    el.appendChild(row);
  }
  const len=p.reduce((m,ev)=>ev.type==='note'?Math.max(m,ev.t0+(ev.dur||0)):m,0);
  const lenEl=get('trackerLen'+(idx+1));
  if(lenEl) lenEl.textContent=`Len ${len.toFixed(2)}s`;
}

document.querySelectorAll('.trackerTrackSel').forEach(sel=>{
  sel.addEventListener('change',()=>{
    const idx=parseInt(sel.dataset.voice);
    const v=voices[idx];
    v.trackerTrack=parseInt(sel.value);
    renderTracker(idx);
  });
});

stopBtn.addEventListener('click', ()=>{ stopPlayback(voices[0]); });
playBtn.addEventListener('click', playSelected);
clearBtn.addEventListener('click', clearPattern);
saveBtn.addEventListener('click', savePattern);
loadBtn.addEventListener('click', loadPatternByName);
patternSel.addEventListener('change', showPattern);
addVoice();
addVoice();
populateTrackerSelects();
renderTracker(0);
renderTracker(1);

const transportPlay = get('transportPlay');
const transportStop = get('transportStop');
transportPlay.addEventListener('click',()=>{
  voices.forEach(v=>{ const idx=v.trackerTrack||0; playPattern(v, v.patterns[idx], false); });
  playDrums();
});
transportStop.addEventListener('click',()=>{
  voices.forEach(stopPlayback);
  stopDrums();
});

document.addEventListener('keydown', e=>{
  if(!document.getElementById('trackTab').classList.contains('active')) return;
  if(['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)) return;
  switch(e.key){
    case 'ArrowLeft': cursor.col=Math.max(0,cursor.col-1); updateCursor(); e.preventDefault(); break;
    case 'ArrowRight': cursor.col=Math.min(patternCols-1,cursor.col+1); updateCursor(); e.preventDefault(); break;
    case 'ArrowUp': cursor.row=Math.max(0,cursor.row-1); updateCursor(); e.preventDefault(); break;
    case 'ArrowDown': cursor.row=Math.min(patternRows-1,cursor.row+1); updateCursor(); e.preventDefault(); break;
    case 'Enter': insertNoteAtCursor(); e.preventDefault(); break;
    case 'Delete':
    case 'Backspace': deleteNoteAtCursor(); e.preventDefault(); break;
  }
});

document.querySelectorAll('.tabBtns').forEach(group=>{
  const btns=group.querySelectorAll('.tabBtn');
  btns.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const tab=btn.dataset.tab;
      btns.forEach(b=>b.classList.toggle('active', b===btn));
      group.parentElement.querySelectorAll('.tabContent').forEach(c=>c.classList.toggle('active', c.id===tab+'Tab'));
    });
  });
});

function attachNumberInputs(){
  document.querySelectorAll('input[type=range]').forEach(r=>{
    if(r.dataset.num) return;
    const num=document.createElement('input');
    num.type='number';
    num.min=r.min; num.max=r.max; num.step=r.step; num.value=r.value;
    num.className='numField';
    const wrap=document.createElement('div'); wrap.className='sliderWrap';
    r.parentNode.insertBefore(wrap,r);
    wrap.appendChild(r); wrap.appendChild(num);
    r.dataset.num='1';
    r.addEventListener('input',()=>num.value=r.value);
    num.addEventListener('input',()=>{ r.value=num.value; r.dispatchEvent(new Event('input'));});
  });
}
attachNumberInputs();

const sampleInstruments={
  'Bright Lead':{wave:'sawtooth',vibRate:6,vibAmt:12,filter:'highpass',cutoff:2000,res:3,A:5,D:120,S:0.5,R:200},
  'Soft Pad':{wave:'triangle',vibRate:4,vibAmt:6,filter:'lowpass',cutoff:1000,res:1.5,A:30,D:400,S:0.7,R:600},
  'Chiptune Bass':{wave:'pulse',pw:0.25,pwmRate:0.6,pwmDepth:0.08,vibRate:0,vibAmt:0,filter:'lowpass',cutoff:600,res:2,A:3,D:80,S:0.4,R:80}
};
let instruments=JSON.parse(localStorage.getItem('instruments')||'{}');
Object.entries(sampleInstruments).forEach(([k,v])=>{ if(!instruments[k]) instruments[k]=v; });
localStorage.setItem('instruments',JSON.stringify(instruments));
const instSel=get('instrumentSel');
const instName=get('instName');
const instBtnWrap=get('instBtnWrap');
function populateInstrumentSelect(){
  if(!instSel) return;
  instSel.innerHTML='';
  Object.keys(instruments).forEach(name=>{
    const o=document.createElement('option'); o.value=name; o.textContent=name; instSel.appendChild(o);
  });
}
populateInstrumentSelect();
function updateInstName(){ if(instName) instName.textContent=instSel.value||'Default'; }
if(instSel){
  instSel.addEventListener('change', ()=>{
    selectInstrument(instSel.value).catch(err=>console.warn('Instrument select failed', err));
  });
  updateInstName();
}

async function selectInstrument(name){
  if(!instruments[name]) return;
  instSel.value=name;
  updateInstName();
  await applyParams(instruments[name]);
  if(instBtnWrap){
    [...instBtnWrap.children].forEach(b=>b.classList.toggle('active', b.dataset.inst===name));
  }
}

if(instBtnWrap){
  const shortlist=Object.keys(instruments).slice(0,6);
  shortlist.forEach(n=>{
    const btn=document.createElement('button');
    btn.className='c64-btn';
    btn.textContent=n;
    btn.dataset.inst=n;
    btn.addEventListener('click',()=>{ selectInstrument(btn.dataset.inst).catch(err=>console.warn('Instrument select failed', err)); });
    btn.addEventListener('contextmenu',e=>{
      e.preventDefault();
      const name=prompt('Instrument name?', btn.dataset.inst);
      if(name && instruments[name]){ btn.dataset.inst=name; btn.textContent=name; }
    });
    instBtnWrap.appendChild(btn);
  });
}

get('instLoadBtn').addEventListener('click',()=>{ selectInstrument(instSel.value).catch(err=>console.warn('Instrument select failed', err)); });
get('instSaveBtn').addEventListener('click',()=>{ const name=instSel.value||prompt('Instrument name?'); if(!name) return; instruments[name]=snapshotParams(); localStorage.setItem('instruments',JSON.stringify(instruments)); populateInstrumentSelect(); instSel.value=name; updateInstName(); });
get('instSaveAsBtn').addEventListener('click',()=>{ const name=prompt('Instrument name?'); if(!name) return; instruments[name]=snapshotParams(); localStorage.setItem('instruments',JSON.stringify(instruments)); populateInstrumentSelect(); instSel.value=name; updateInstName(); });

const openFx=get('openFx');
if(openFx){ openFx.addEventListener('click',()=>{ const btn=document.querySelector('.tabBtn[data-tab="fx"]'); if(btn) btn.click(); }); }

function playPattern(v, pattern, showPlayhead=true){
  if(ctx.state!=='running') return;
  stopPlayback(v);
  const startAt=ctx.currentTime+0.05;
  let playDur=0;
  pattern.forEach(ev=>{ if(ev.type==='note') playDur=Math.max(playDur, ev.t0+(ev.dur||0)); });
  if(showPlayhead){
    const stepSec=stepSeconds();
    playDur=Math.max(playDur, patternCols*stepSec);
    startPlayhead(playDur, startAt);
  }
  v.prevParams = snapshotParams();
  v.playTimeouts.push(setTimeout(()=>{ void applyParams(v.prevParams); }, (playDur+0.1)*1000));
  if(showPlayhead) v.playTimeouts.push(setTimeout(stopPlayhead, (playDur+0.1)*1000));
  pattern.forEach(ev=>{
    const when=startAt+ev.t0;
    if(ev.type==='note'){
      const id=setTimeout(async ()=>{
        const p=ev.params||snapshotParams();
        await applyParams(p);
        const voiceNode=createVoice(ev.note, v);
        setTimeout(()=>voiceNode.stop(), ev.dur*1000);
      }, Math.max(0,(when-ctx.currentTime)*1000));
      v.playTimeouts.push(id);
    } else if(ev.type==='drum'){
      const id=setTimeout(()=>triggerDrum(ev.drum, when), Math.max(0,(when-ctx.currentTime)*1000));
      v.playTimeouts.push(id);
    }
  });
}

function stopPlayback(v){
  if(v.playTimeouts){ v.playTimeouts.forEach(id=>clearTimeout(id)); v.playTimeouts=[]; }
  if(v.prevParams){ void applyParams(v.prevParams); v.prevParams=null; }
  stopPlayhead();
}

// Boot intro + audio unlock
function initBootIntro(){
  const overlay=document.getElementById('bootOverlay');
  if(!overlay) return;
  const skip=localStorage.getItem('c64piano_skip_intro')==='1';
  if(skip){
    overlay.remove();
    window.addEventListener('pointerdown', unlockAudio, {once:true});
    window.addEventListener('keydown', unlockAudio, {once:true});
    return;
  }
  overlay.style.display='flex';
  const startBtn=get('bootStart');
  const skipChk=get('bootSkip');
  const cursor=get('bootCursor');
  const controls=overlay.querySelector('.bootControls');
  controls.style.display='none';

  const header=document.createElement('div');
  header.style.textAlign='center';
  header.textContent='\n**** COMMODORE 64 BASIC V2 ****\n\n64K RAM SYSTEM  38911 BASIC BYTES FREE\n';
  cursor.before(header);
  cursor.before(document.createTextNode('\nREADY.\n\n'));

  const typingDone=runTypingSequence(cursor, controls, startBtn);

  function keyHandler(e){
    if(controls.style.display!=='none' && e.key==='Enter'){
      e.preventDefault();
      start();
    }
  }
  async function start(){
    await typingDone;
    window.removeEventListener('keydown', keyHandler);
    if(skipChk.checked) localStorage.setItem('c64piano_skip_intro','1');
    await unlockAudio();
    cursor.style.display='none';
    overlay.classList.add('poweroff');
    setTimeout(()=>overlay.remove(),800);
  }
  startBtn.addEventListener('click', start);
  window.addEventListener('keydown', keyHandler);
}
async function runTypingSequence(cursor, controls, startBtn){
  const delay=ms=>new Promise(r=>setTimeout(r,ms));

  // Type LOAD command
  const loadCmd='LOAD "C64 PIANO",8,1';
  for(const ch of loadCmd){
    cursor.before(document.createTextNode(ch));
    await delay(20+Math.random()*20);
  }
  // newline plus empty line
  cursor.before(document.createTextNode('\n\n'));
  cursor.style.display='none';

  // Simulate drive search/loading messages
  cursor.before(document.createTextNode('SEARCHING FOR C64 PIANO\n'));
  await delay(1000);
  cursor.before(document.createTextNode('LOADING\n'));
  await delay(2000);
  cursor.before(document.createTextNode('READY.\n'));
  cursor.style.display='inline-block';

  // Type RUN command
  const runCmd='RUN';
  for(const ch of runCmd){
    cursor.before(document.createTextNode(ch));
    await delay(20+Math.random()*20);
  }
  cursor.before(document.createTextNode('\n'));
  cursor.style.display='none';
  await delay(500);
  const msg='PRESS RETURN TO ENABLE SOUND';
  const msgEl=document.createElement('div');
  cursor.before(msgEl);
  const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789?*#$%';
  for(let i=0;i<20;i++){
    let out='';
    for(let j=0;j<msg.length;j++){
      out+=Math.random()<i/20?msg[j]:chars[Math.floor(Math.random()*chars.length)];
    }
    msgEl.textContent=out;
    await delay(50);
  }
  msgEl.textContent=msg;
  controls.style.display='flex';
  startBtn.focus();
}



// Bit‑crusher flavor (8‑bit)
function makeCrusher(bits=8){ const steps = 2**bits; const curve = new Float32Array(65536); for(let i=0;i<curve.length;i++){ const x=i/65535*2-1; const q=Math.round((x*0.5+0.5)*(steps-1))/(steps-1); curve[i]=(q-0.5)*2;} const sh=ctx.createWaveShaper(); sh.curve=curve; sh.oversample='4x'; return sh; }
let crusher = makeCrusher(8);
const crusherOutputs = new WeakSet();
const crushToggle=get('crush');
if(crushToggle){
  crushToggle.addEventListener('change', ()=>{
    if(state.engine==='websid') updateWebSidRouting();
  });
}

// Base note frequencies (A4=440)
const baseFreq = { 'C':261.63,'C#':277.18,'D':293.66,'D#':311.13,'E':329.63,'F':349.23,'F#':369.99,'G':392.00,'G#':415.30,'A':440.00,'A#':466.16,'B':493.88,'C2':523.25 };
let octave = 0; // -3..+3
const octBtns = [...document.querySelectorAll('#octBtns button')];
function updateOct(n){
  octave = Math.max(-3, Math.min(3, n));
  octBtns.forEach(btn=>btn.classList.toggle('active', Number(btn.dataset.oct)===octave));
}
octBtns.forEach(btn=>btn.addEventListener('click', ()=>updateOct(Number(btn.dataset.oct))));
get('octDown').addEventListener('click', ()=>updateOct(octave-1));
get('octUp').addEventListener('click', ()=>updateOct(octave+1));
updateOct(0);

function freqFor(note){ return (typeof note === 'number') ? note : baseFreq[note] * Math.pow(2, octave); }

// Pulse PeriodicWave
function makePulseWave(duty=0.5, harmonics=64){ duty=Math.min(0.98,Math.max(0.02,duty)); const real=new Float32Array(harmonics+1), imag=new Float32Array(harmonics+1); for(let n=1;n<=harmonics;n++){ const a=(1/(n*Math.PI))*(Math.sin(n*Math.PI*duty)*2); imag[n]=a; } return ctx.createPeriodicWave(real,imag,{disableNormalization:true}); }

// ======= Presets =======
const wavePresets = {
  pulse: {
    'Init': { pw:0.5, pwmRate:3, pwmDepth:0.25, vibRate:5, vibAmt:8 },
    'PWM Lead': { pw:0.5, pwmRate:3, pwmDepth:0.25, vibRate:5, vibAmt:8 },
    'Chiptune Bass': { pw:0.25, pwmRate:0.6, pwmDepth:0.08, vibRate:0, vibAmt:0 },
    'Detuned PWM': { pw:0.45, pwmRate:5, pwmDepth:0.35, vibRate:7, vibAmt:12 },
    'Thin Pulse': { pw:0.2, pwmRate:0, pwmDepth:0, vibRate:0, vibAmt:0 },
    'Wide Pulse': { pw:0.8, pwmRate:0, pwmDepth:0, vibRate:0, vibAmt:0 },
  },
  sawtooth: {
    'Init': { vibRate:0, vibAmt:0 },
    'SID Brass': { vibRate:5, vibAmt:10 },
    'Razor Lead': { vibRate:7, vibAmt:14 },
    'Super Saw': { vibRate:6, vibAmt:12 },
  },
  triangle: {
    'Init': { vibRate:0, vibAmt:0 },
    'Soft Bell': { vibRate:5, vibAmt:6 },
    'Flute': { vibRate:6, vibAmt:8 },
    'Organ': { vibRate:0, vibAmt:0 },
  },
  noise: {
    'Init': {},
    'Hi‑Hat': {},
    'Snare': {},
    'Crash': {},
  }
};

const filterPresets = {
  'Bright LP': { type:'lowpass', cutoff:4000, res:2 },
  'Muffled': { type:'lowpass', cutoff:800, res:1.2 },
  'Deep LP': { type:'lowpass', cutoff:500, res:4 },
  'Nasal BP': { type:'bandpass', cutoff:1500, res:8 },
  'Wide BP': { type:'bandpass', cutoff:1000, res:2 },
  'Thin HP': { type:'highpass', cutoff:1200, res:1.5 },
  'Bright HP': { type:'highpass', cutoff:2000, res:0.8 },
  'Off': { type:'off' }
};

const adsrPresets = {
  'Pluck': { A:5, D:120, S:0.2, R:120 },
  'Lead':  { A:8, D:140, S:0.5, R:220 },
  'Pad':   { A:40, D:400, S:0.7, R:600 },
  'Bass':  { A:3, D:100, S:0.3, R:80 }
};

const engines = {
  classic: { id:'classic', label:'Hybrid JS Synth', create:(note, voice)=>createClassicVoice(note, voice) },
  websid:  { id:'websid',  label:'webSID Engine', create:(note, voice)=>createWebSidVoice(note, voice) },
  jssid:   { id:'jssid',   label:'JS SID Engine', create:(note, voice)=>createJsSidVoice(note, voice) }
};

function populateEngineSelect(){
  if(!engineSel) return;
  engineSel.innerHTML='';
  Object.values(engines).forEach(engine=>{
    const opt=document.createElement('option');
    opt.value=engine.id;
    opt.textContent=engine.label;
    engineSel.appendChild(opt);
  });
}

async function setEngine(id, {persist=false}={}){
  const key=engines[id]?id:'classic';
  if(state.engine===key){
    if(engineSel) engineSel.value=key;
    if(persist){
      try{ localStorage.setItem(ENGINE_STORAGE_KEY, key); }
      catch(e){ /* ignore storage errors */ }
    }
    return state.engine;
  }
  if(key==='websid'){
    if(window.location.protocol==='file:' || !window.crossOriginIsolated){
      console.warn('webSID engine requires cross-origin isolation over HTTP; falling back to Hybrid');
      showBanner('webSID engine requires cross-origin isolation. Using Hybrid.');
      if(engineSel) engineSel.value=state.engine;
      if(persist){
        try{ localStorage.setItem(ENGINE_STORAGE_KEY, state.engine); }
        catch(e){ }
      }
      return state.engine;
    }
    try{
      await ensureWebSidNode();
      state.engine='websid';
      if(engineSel) engineSel.value='websid';
      syncWebSidParams();
      updateWebSidRouting();
      if(persist){
        try{ localStorage.setItem(ENGINE_STORAGE_KEY, 'websid'); }
        catch(e){ }
      }
      return 'websid';
    }catch(err){
      console.warn('webSID init failed; falling back to Hybrid', err);
      showBanner('webSID unavailable — using Hybrid');
      disposeWebSidNode();
      state.engine='classic';
      if(engineSel) engineSel.value='classic';
      if(persist){
        try{ localStorage.setItem(ENGINE_STORAGE_KEY, 'classic'); }
        catch(e){ }
      }
      return state.engine;
    }
  }
  if(state.engine==='websid'){
    disposeWebSidNode();
  }
  state.engine=key;
  if(engineSel) engineSel.value=key;
  if(persist){
    try{ localStorage.setItem(ENGINE_STORAGE_KEY, key); }
    catch(e){ }
  }
  return state.engine;
}

function setWaveButtons(type){
  document.querySelectorAll('#waveBtns .segBtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.wave===type);
    b.setAttribute('aria-pressed', b.dataset.wave===type);
  });
  state.wave = type;
  populateWavePresets();
  updateWaveVis();
  // enable/disable PW controls for non-pulse
  const pulseOnly = ['sidPW','sidPWMRate','sidPWMDepth'];
  pulseOnly.forEach(id=>{ const el=get(id); if(!el) return; el.disabled = (type!=='pulse'); el.parentElement.style.opacity = el.disabled?0.5:1; });
}

function populateWavePresets(){
  const sel = get('wavePreset');
  sel.innerHTML='';
  const list = wavePresets[state.wave] || { 'Init':{} };
  Object.keys(list).forEach(name=>{
    const o=document.createElement('option'); o.textContent=name; sel.appendChild(o);
  });
  sel.value = Object.keys(list)[0] || 'Init';
}

function applyWavePreset(){
  const sel = get('wavePreset'); const p = (wavePresets[state.wave]||{})[sel.value]||{};
  const setVal=(id,val)=>{ if(val!=null){ const el=get(id); if(el){ el.value=val; el.dispatchEvent(new Event('input')); }} };
  setVal('sidPW',p.pw);
  setVal('sidPWMRate',p.pwmRate);
  setVal('sidPWMDepth',p.pwmDepth);
  setVal('vibRate',p.vibRate);
  setVal('vibAmt',p.vibAmt);
  updateWaveVis();
}

function setFilterButtons(type){
  document.querySelectorAll('#filterBtns .segBtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.filter===type);
  });
  state.filter = type;
  updateFilterVis();
  if(state.engine==='websid') syncWebSidParams();
}

function populateFilterPresets(){
  const sel=get('filterPreset'); sel.innerHTML='';
  Object.keys(filterPresets).forEach(name=>{ const o=document.createElement('option'); o.textContent=name; sel.appendChild(o); });
}
function applyFilterPreset(){
  const sel=get('filterPreset'); const p=filterPresets[sel.value]; if(!p) return;
  state.filter = p.type;
  if(p.cutoff!=null) get('sidCutoff').value=p.cutoff;
  if(p.res!=null) get('sidRes').value=p.res;
  setFilterButtons(state.filter);
  updateFilterVis();
}

function snapshotParams(){
  return {
    engine: state.engine,
    wave: state.wave,
    pw: valNum('sidPW',0.5),
    pwmRate: valNum('sidPWMRate',3),
    pwmDepth: valNum('sidPWMDepth',0.25),
    vibRate: valNum('vibRate',5),
    vibAmt: valNum('vibAmt',8),
    A: valNum('sidA',8),
    D: valNum('sidD',120),
    S: valNum('sidS',0.5),
    R: valNum('sidR',240),
    filter: state.filter,
    cutoff: valNum('sidCutoff',1700),
    res: valNum('sidRes',5),
    master: master.gain.value,
    crush: get('crush')?get('crush').checked:false
  };
}

async function applyParams(p){
  if(!p) return;
  const setVal=(id,val)=>{ const el=get(id); if(el!=null && val!=null){ el.value=val; el.dispatchEvent(new Event('input')); } };
  if(p.engine) await setEngine(p.engine);
  setWaveButtons(p.wave||'pulse');
  setVal('sidPW',p.pw);
  setVal('sidPWMRate',p.pwmRate);
  setVal('sidPWMDepth',p.pwmDepth);
  setVal('vibRate',p.vibRate);
  setVal('vibAmt',p.vibAmt);
  setVal('sidA',p.A);
  setVal('sidD',p.D);
  setVal('sidS',p.S);
  setVal('sidR',p.R);
  setFilterButtons(p.filter||'off');
  setVal('sidCutoff',p.cutoff);
  setVal('sidRes',p.res);
  if(get('crush')) get('crush').checked=p.crush;
  if(Number.isFinite(p.master)) master.gain.value=sanitizeMaster(p.master);
  if(state.engine==='websid'){
    syncWebSidParams();
    updateWebSidRouting();
  }
  updateWaveVis();
  updateFilterVis();
  updateADSRVis();
}

function populateADSRPresets(){
  const sel=get('adsrPreset'); sel.innerHTML='';
  Object.keys(adsrPresets).forEach(name=>{ const o=document.createElement('option'); o.textContent=name; sel.appendChild(o); });
}
function applyADSRPreset(){
  const sel=get('adsrPreset'); const p=adsrPresets[sel.value]; if(!p) return;
  get('sidA').value=p.A; get('sidD').value=p.D; get('sidS').value=p.S; get('sidR').value=p.R;
  updateADSRVis();
}

// ======= Visuals =======
function clearCanvas(c){ const g=c.getContext('2d'); g.clearRect(0,0,c.width,c.height); return g; }

let waveAnimId=null;
function updateWaveVis(){
  if(waveAnimId) cancelAnimationFrame(waveAnimId);
  (function loop(){
    const c=get('waveVis');
    if(!c){ waveAnimId=null; return; }
    c.width=c.clientWidth;
    c.height=c.clientHeight;
    const g=clearCanvas(c); const w=c.width, h=c.height; g.strokeStyle='#d6e0ff'; g.lineWidth=2; g.beginPath();
    const wave=state.wave; let pw=parseFloat(get('sidPW').value); const depth=parseFloat(get('sidPWMDepth').value||0); const rate=parseFloat(get('sidPWMRate').value||0);
    if(wave==='pulse'){
      const t=performance.now()/1000; pw+=depth*Math.sin(2*Math.PI*rate*t); pw=Math.max(0.05,Math.min(0.95,pw));
      const y1=10, y2=h-10; const x=w*pw;
      g.moveTo(5,(y1+y2)/2);
      g.lineTo(x, y1);
      g.lineTo(x, y2);
      g.lineTo(w-5, y2);
      g.lineTo(w-5, y1);
    } else if(wave==='sawtooth'){
      g.moveTo(5,h-10); g.lineTo(w-5,10); g.moveTo(5,h-10); g.lineTo(5,10);
    } else if(wave==='triangle'){
      g.moveTo(5,h-10); g.lineTo(w*0.5,10); g.lineTo(w-5,h-10);
    } else { // noise
      g.moveTo(5, h/2);
      for(let x=5;x<=w-5;x+=4){ const y=10 + Math.random()*(h-20); g.lineTo(x,y); }
    }
    g.stroke();
    waveAnimId=requestAnimationFrame(loop);
  })();
}

function updateFilterVis(){
  const c=get('filterVis'); if(!c) return; c.width=c.clientWidth; c.height=c.clientHeight; const g=clearCanvas(c); const w=c.width, h=c.height; g.strokeStyle='#d6e0ff'; g.lineWidth=2;
  if(state.filter==='off'){ g.beginPath(); g.moveTo(5,h/2); g.lineTo(w-5,h/2); g.stroke(); return; }
  const biq=ctx.createBiquadFilter(); biq.type=state.filter; biq.Q.value=valNum('sidRes',5); biq.frequency.value=valNum('sidCutoff',1700);
  const N=256; const freq=new Float32Array(N); const mag=new Float32Array(N); const phase=new Float32Array(N);
  const ny=ctx.sampleRate/2; for(let i=0;i<N;i++){ const f=20*Math.pow( (ny/20), i/(N-1) ); freq[i]=f; }
  biq.getFrequencyResponse(freq,mag,phase);
  g.beginPath();
  for(let i=0;i<N;i++){
    const db = 20*Math.log10(mag[i]||1e-6);
    const x = 5 + (w-10)*i/(N-1);
    const y = h-10 - ( (db+40)/60 )*(h-20); // map -40..+20 dB
    if(i===0) g.moveTo(x,y); else g.lineTo(x,y);
  }
  g.stroke();
}

function updateADSRVis(){
  const c=get('adsrVis'); if(!c) return; const g=clearCanvas(c); const w=c.width, h=c.height; g.strokeStyle='#d6e0ff'; g.lineWidth=2;
  const A=valNum('sidA',8), D=valNum('sidD',120), S=valNum('sidS',0.5), R=valNum('sidR',240);
  const total = A + D + 200 + R; // include a hold segment
  const x0=10, x1=x0 + (w-20)*(A/total), x2=x1 + (w-20)*(D/total), x3=x2 + (w-20)*(200/total), x4=w-10;
  const y0=h-10, y1=10, yS = 10 + (1-S)*(h-20);
  g.beginPath(); g.moveTo(x0,y0); g.lineTo(x1,y1); g.lineTo(x2,yS); g.lineTo(x3,yS); g.lineTo(x4,h-10);
  g.stroke();
}

// ======= Synth voices =======
function createClassicVoice(note, voice=voices[0]){
  ensureAudio();
  const now=ctx.currentTime; const f=freqFor(note);
  const waveSel=state.wave; const cutoff=valNum('sidCutoff',1700); const res=valNum('sidRes',5);
  const A=valNum('sidA',8)/1000, D=valNum('sidD',120)/1000, S=valNum('sidS',0.5), R=valNum('sidR',240)/1000;
  const vibRate=valNum('vibRate',5), vibAmt=valNum('vibAmt',8); const filterMode=state.filter; const crushOn=(get('crush')?get('crush').checked:false); const pwBase=valNum('sidPW',0.5), pwmRate=valNum('sidPWMRate',3), pwmDepth=valNum('sidPWMDepth',0.25);

  let source, osc, noise;
  if(waveSel==='noise'){
    const len=2048, buf=ctx.createBuffer(1,len,ctx.sampleRate), d=buf.getChannelData(0); for(let i=0;i<len;i++) d[i]=Math.random()*2-1; noise=ctx.createBufferSource(); noise.buffer=buf; noise.loop=true; noise.playbackRate.value=f/440; source=noise;
  } else { osc=ctx.createOscillator(); if(waveSel==='pulse') osc.setPeriodicWave(makePulseWave(pwBase)); else osc.type=waveSel; osc.frequency.setValueAtTime(f,now); source=osc; }

  // Build graph with optional filter
  const vca=ctx.createGain(); vca.gain.setValueAtTime(0,now);
  if(filterMode!=='off'){
    const vcf = ctx.createBiquadFilter(); vcf.type=filterMode; vcf.Q.value=res; vcf.frequency.setValueAtTime(cutoff,now);
    source.connect(vcf); vcf.connect(vca);
  } else {
    source.connect(vca);
  }
  if(crushOn){ vca.connect(crusher); crusher.connect(voice.gain);} else { vca.connect(voice.gain); }

  // Envelope
  vca.gain.setValueAtTime(0,now); vca.gain.linearRampToValueAtTime(1,now+A); vca.gain.linearRampToValueAtTime(S,now+A+D);

  // PWM
  let pwmTimer=null, currentPW=pwBase; if(osc && waveSel==='pulse'){ const start=now; pwmTimer=setInterval(()=>{ const t=ctx.currentTime-start; const d=Math.max(0.02,Math.min(0.98,pwBase+pwmDepth*Math.sin(2*Math.PI*pwmRate*t))); if(Math.abs(d-currentPW)>0.004){ currentPW=d; osc.setPeriodicWave(makePulseWave(currentPW)); } },16); }
  // Vibrato
  let vib=null; if(osc && vibAmt>0 && vibRate>0){ vib=ctx.createOscillator(); vib.type='sine'; vib.frequency.value=vibRate; const g=ctx.createGain(); g.gain.value=vibAmt; vib.connect(g); g.connect(osc.detune); vib.start(now); }
  // Arpeggiator
  let arpTimer=null;
  const arpModeEl=document.querySelector('#arpModeBtns .active');
  const arpMode=arpModeEl?arpModeEl.dataset.mode:'off';
  const arpRate=valNum('arpRate',12);
  const arpGate=valNum('arpGate',0.5);
  const arpPatterns={
    off:[0],
    up:[0,4,7,12],
    down:[12,7,4,0],
    updown:[0,4,7,4],
    random:[0,4,7,12]
  };
  if(osc && arpMode!=='off'){
    let idx=0;
    const interval=Math.max(20, 1000*(1/arpRate));
    arpTimer=setInterval(()=>{
      let semis;
      if(arpMode==='random'){
        const arr=arpPatterns.random;
        semis=arr[Math.floor(Math.random()*arr.length)];
      } else {
        const arr=arpPatterns[arpMode];
        semis=arr[idx%arr.length];
        idx++;
      }
      const ff=f*Math.pow(2, semis/12);
      osc.frequency.setValueAtTime(ff, ctx.currentTime);
      vca.gain.cancelScheduledValues(ctx.currentTime);
      vca.gain.setValueAtTime(1, ctx.currentTime);
      vca.gain.setTargetAtTime(0.0001, ctx.currentTime + interval*arpGate, 0.01);
    }, interval);
  }

  source.start(now);
  return { stop:()=>{ const t=ctx.currentTime; vca.gain.setTargetAtTime(0.0001,t,Math.max(0.01,R)); source.stop(t+R+0.03); if(pwmTimer) clearInterval(pwmTimer); if(vib) vib.stop(t+0.01); if(arpTimer) clearInterval(arpTimer); } };
}

function createJsSidVoice(note, voice=voices[0]){
  if(typeof ctx.createScriptProcessor!=="function"){
    console.warn('ScriptProcessor not supported; falling back to classic engine');
    return createClassicVoice(note, voice);
  }
  ensureAudio();
  const sampleRate=ctx.sampleRate;
  const baseFreq=freqFor(note);
  const waveSel=state.wave;
  const cutoff=valNum('sidCutoff',1700);
  const res=valNum('sidRes',5);
  const crushOn=get('crush')?get('crush').checked:false;
  const A=Math.max(0.0001, valNum('sidA',8)/1000);
  const D=Math.max(0.0001, valNum('sidD',120)/1000);
  const S=Math.min(1, Math.max(0, valNum('sidS',0.5)));
  const R=Math.max(0.0001, valNum('sidR',240)/1000);
  const vibRate=Math.max(0, valNum('vibRate',5));
  const vibAmt=Math.max(0, valNum('vibAmt',8));
  const pwmBase=Math.min(0.98, Math.max(0.02, valNum('sidPW',0.5)));
  const pwmRate=Math.max(0, valNum('sidPWMRate',3));
  const pwmDepth=Math.max(0, Math.min(0.45, valNum('sidPWMDepth',0.25)));
  const filterMode=state.filter;

  const script=ctx.createScriptProcessor(1024,0,1);
  const mixGain=ctx.createGain();
  mixGain.gain.value=0.85;
  script.connect(mixGain);
  if(crushOn){
    mixGain.connect(crusher);
    if(!crusherOutputs.has(voice.gain)){
      crusher.connect(voice.gain);
      crusherOutputs.add(voice.gain);
    }
  } else {
    mixGain.connect(voice.gain);
  }

  const attackSamples=Math.max(1, Math.round(A*sampleRate));
  const decaySamples=Math.max(1, Math.round(D*sampleRate));
  const sustainLevel=S;
  const releaseSamples=Math.max(1, Math.round(R*sampleRate));
  const vibDepth=vibAmt/1200;
  let sampleIndex=0;
  let phase=0;
  let releaseStart=null;
  let releaseLevel=sustainLevel;
  let lastEnv=0;
  let finished=false;
  let noiseSeed=0x1234567;
  let lp=0, bp=0;
  const filterOn=filterMode && filterMode!=='off';
  const cutoffHz=filterOn?clampValue(cutoff,20,sampleRate/2-100):0;
  const filterF=filterOn?Math.min(1.9, 2*Math.sin(Math.PI*Math.min(0.25, cutoffHz/sampleRate))):0;
  const filterQ=filterOn?Math.max(0.001, 1-Math.min(0.98, res/20)):0;
  const sustainSilent=sustainLevel<=0.0001;

  const amplitude=filterOn?0.72:0.85;

  function nextNoise(){
    noiseSeed ^= noiseSeed << 13;
    noiseSeed ^= noiseSeed >>> 17;
    noiseSeed ^= noiseSeed << 5;
    return ((noiseSeed & 0x7fffffff)/0x3fffffff)*2-1;
  }

  function finalize(){
    if(finished) return;
    finished=true;
    script.disconnect();
    mixGain.disconnect();
    script.onaudioprocess=null;
  }

  script.onaudioprocess=e=>{
    const out=e.outputBuffer.getChannelData(0);
    for(let i=0;i<out.length;i++){
      if(finished){ out[i]=0; continue; }
      const t=sampleIndex/sampleRate;
      let freqNow=baseFreq;
      if(vibRate>0 && vibAmt>0){
        freqNow*=Math.pow(2, vibDepth*Math.sin(2*Math.PI*vibRate*t));
      }
      let pw=pwmBase;
      if(waveSel==='pulse' && pwmDepth>0 && pwmRate>0){
        pw=Math.max(0.02, Math.min(0.98, pwmBase+pwmDepth*Math.sin(2*Math.PI*pwmRate*t)));
      }
      phase+=freqNow/sampleRate;
      phase-=Math.floor(phase);
      let sample;
      if(waveSel==='sawtooth') sample=2*phase-1;
      else if(waveSel==='triangle') sample=4*Math.abs(phase-0.5)-1;
      else if(waveSel==='noise') sample=nextNoise();
      else sample=phase<pw?1:-1;

      let env;
      if(releaseStart!==null){
        const relIdx=sampleIndex-releaseStart;
        if(relIdx>=releaseSamples){
          for(let j=i;j<out.length;j++) out[j]=0;
          finalize();
          break;
        }
        const frac=1-relIdx/releaseSamples;
        env=releaseLevel*frac;
      } else if(sampleIndex<attackSamples){
        env=sampleIndex/attackSamples;
      } else if(sampleIndex<attackSamples+decaySamples){
        const pos=(sampleIndex-attackSamples)/Math.max(1,decaySamples);
        env=1+(sustainLevel-1)*pos;
      } else {
        env=sustainLevel;
        if(sustainSilent){
          for(let j=i;j<out.length;j++) out[j]=0;
          finalize();
          break;
        }
      }
      lastEnv=env;
      let val=sample*env*amplitude;
      if(filterOn){
        const hp=val - lp - filterQ*bp;
        bp += filterF*hp;
        lp += filterF*bp;
        if(filterMode==='lowpass') val=lp;
        else if(filterMode==='highpass') val=hp;
        else val=bp;
      }
      if(val>1) val=1; else if(val<-1) val=-1;
      out[i]=val;
      sampleIndex++;
    }
  };

  return {
    stop(){
      if(finished) return;
      if(releaseStart===null){
        releaseStart=sampleIndex;
        releaseLevel=lastEnv;
        if(releaseLevel<=0.0001){
          finalize();
        }
      }
    }
  };
}

function createWebSidVoice(note, voice=voices[0]){
  ensureAudio();
  if(state.engine!=='websid' || !webSidState.node){
    return createClassicVoice(note, voice);
  }
  updateWebSidRouting();
  const f=sanitizeFrequency(freqFor(note));
  const A=sanitizeAdsr(valNum('sidA',8)/1000, 0.008);
  const D=sanitizeAdsr(valNum('sidD',120)/1000, 0.12);
  const S=sanitizeSustain(valNum('sidS',0.5));
  const R=sanitizeAdsr(valNum('sidR',240)/1000, 0.24);
  const pwBase=sanitizePulseWidth(valNum('sidPW',0.5));
  const pwmRate=sanitizeLfoRate(valNum('sidPWMRate',3));
  const pwmDepth=sanitizePwmDepth(valNum('sidPWMDepth',0.25));
  const vibRate=sanitizeLfoRate(valNum('vibRate',5));
  const vibAmt=sanitizeLfoDepth(valNum('vibAmt',8));
  const cutoff=sanitizeCutoff(valNum('sidCutoff',1700));
  const res=sanitizeResonance(valNum('sidRes',5));
  const filterMode=filterModeMap[state.filter]||0;
  const masterValue=sanitizeMaster(master.gain.value);
  queueWebSidParam({type:'setFilter', mode:filterMode, cutoff, q:res});
  queueWebSidParam({type:'setGlobal', pwmRate, pwmDepth, vibRate, vibCents:vibAmt, master:masterValue});
  const id=voice.nextId||0;
  voice.nextId=(id+1)%3;
  queueWebSidEvent({type:'noteOn', voice:id, freq:f, pw:pwBase, a:A, d:D, s:S, r:R});
  return { stop:()=>queueWebSidEvent({type:'noteOff', voice:id}) };
}

function createVoice(note, voice){
  if(ctx.state!=='running') return {stop:()=>{}};
  const engineId=state.engine;
  const engine=engines[engineId]||engines.classic;
  return engine.create(note,voice);
}

// === Piano UI wiring ===
const whites=document.querySelectorAll('.white'); const blacks=document.querySelectorAll('.black');
const active=new Map(); const keyMap={}; [...whites,...blacks].forEach(k=>{ const kk=k.dataset.key; if(kk) keyMap[kk.toLowerCase()]=k; });

function noteOn(el){
  if(ctx.state!=='running') return;
  const n=el.dataset.note;
  const idx=0;
  const v=createVoice(n, voices[idx]);
  active.set(el,{node:v, voiceIndex:idx});
  el.classList.add('active');
}
function noteOff(el){
  const act=active.get(el);
  if(act){ act.node.stop(); active.delete(el); }
  el.classList.remove('active');
}

whites.forEach(w=>{ w.addEventListener('mousedown',e=>{ if(e.button!==0) return; noteOn(w); }); w.addEventListener('mouseup',()=>noteOff(w)); w.addEventListener('mouseleave',()=>noteOff(w)); w.addEventListener('touchstart',e=>{ e.preventDefault(); noteOn(w); },{passive:false}); w.addEventListener('touchend',e=>{ e.preventDefault(); noteOff(w); },{passive:false}); });
blacks.forEach(b=>{ const down=e=>{ e.stopPropagation(); if(e.type==='mousedown'&&e.button!==0) return; noteOn(b); }; const up=e=>{ e.stopPropagation(); noteOff(b); }; b.addEventListener('mousedown',down); b.addEventListener('mouseup',up); b.addEventListener('mouseleave',up); b.addEventListener('touchstart',e=>{ e.preventDefault(); e.stopPropagation(); noteOn(b); },{passive:false}); b.addEventListener('touchend',e=>{ e.preventDefault(); e.stopPropagation(); noteOff(b); },{passive:false}); });

const pressed=new Set();
document.addEventListener('keydown',e=>{
  // octave keys: , and . (also accept < and >)
  if(e.key===',' || e.key=='<'){ updateOct(octave-1); return; }
  if(e.key==='.' || e.key==='>'){ updateOct(octave+1); return; }
  const key=e.key.toLowerCase(); if(pressed.has(key)) return; const el=keyMap[key]; if(el){ pressed.add(key); noteOn(el);} 
});
document.addEventListener('keyup',e=>{ const key=e.key.toLowerCase(); const el=keyMap[key]; if(el){ noteOff(el);} pressed.delete(key); });

get('master').addEventListener('input', e=>{
  const newVal=sanitizeMaster(parseFloat(e.target.value));
  master.gain.value=newVal;
  if(state.engine==='websid'){
    queueWebSidParam({type:'setMaster', master:newVal});
    updateWebSidRouting();
  }
});


// ======= Drum machine =======
const drumGrid=get('drums');
let drumSteps=drumCols();
let rowInstruments=['Snare','Kick','Hat','Tom'];
const drumInstruments=['Kick','Snare','Hat','Tom','Clap','Cowbell'];
let pattern={0:Array(drumSteps).fill(false),1:Array(drumSteps).fill(false),2:Array(drumSteps).fill(false),3:Array(drumSteps).fill(false)};
const drumPatterns=Array(8).fill(0).map(()=>({pattern:null,instruments:null,steps:drumSteps}));
const drumPatternNames=Array(8).fill(0).map((_,i)=>'Drum '+(i+1));
let drumIndex=0;

function buildGrid(){
  drumSteps=drumCols();
  for(let r=0;r<4;r++){
    pattern[r]=pattern[r]||[];
    if(pattern[r].length<drumSteps) pattern[r]=pattern[r].concat(Array(drumSteps-pattern[r].length).fill(false));
    else pattern[r]=pattern[r].slice(0,drumSteps);
  }
  drumGrid.innerHTML='';
  const firstCol=getComputedStyle(document.documentElement).getPropertyValue('--drum-left')||'180px';
  drumGrid.style.gridTemplateColumns=firstCol.trim()+" repeat("+drumSteps+", 1fr)";
  drumGrid.appendChild(Object.assign(document.createElement('div'),{className:'hdr'}));
  for(let i=0;i<drumSteps;i++){ const h=document.createElement('div'); h.className='hdr colHdr'; h.textContent=(i+1); drumGrid.appendChild(h); }
  for(let r=0;r<4;r++){
    const left=document.createElement('div'); left.className='rowLbl';
    const tag=document.createElement('span'); tag.className='keytag'; tag.textContent=['Z','X','C','V'][r]; left.appendChild(tag);
    const sel=document.createElement('select'); sel.className='drumSel'; sel.title='Choose the drum sound for this row'; drumInstruments.forEach(n=>{ const o=document.createElement('option'); o.textContent=n; if(n===rowInstruments[r]) o.selected=true; sel.appendChild(o); }); sel.addEventListener('change',()=>{ rowInstruments[r]=sel.value; }); left.appendChild(sel);
    drumGrid.appendChild(left);
    for(let i=0;i<drumSteps;i++){ const cell=document.createElement('div'); cell.className='step'; cell.title=`Step ${i+1} (click to toggle)`; if(pattern[r][i]) cell.classList.add('on'); cell.addEventListener('click',()=>{ const on=pattern[r][i]; for(let rr=0;rr<4;rr++) pattern[rr][i]=false; if(!on) pattern[r][i]=true; const cells=drumGrid.querySelectorAll('.step'); for(let rr=0;rr<4;rr++){ cells[rr*drumSteps+i].classList.toggle('on', !on && rr===r); } }); drumGrid.appendChild(cell); }
  }
}
function populateDrumSelect(){
  const sel=get('drumPatternSel');
  sel.innerHTML='';
  drumPatternNames.forEach((n,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=n; sel.appendChild(o); });
  sel.value=drumIndex;
}
function showDrumPattern(){
  const data=drumPatterns[drumIndex];
  if(data && data.pattern){
    drumSteps=data.steps||drumCols();
    pattern=JSON.parse(JSON.stringify(data.pattern));
    rowInstruments=[...data.instruments];
  }else{
    drumSteps=drumCols();
    pattern={0:Array(drumSteps).fill(false),1:Array(drumSteps).fill(false),2:Array(drumSteps).fill(false),3:Array(drumSteps).fill(false)};
    rowInstruments=['Snare','Kick','Hat','Tom'];
  }
  drumLenInput.value=Math.max(1,Math.ceil(drumSteps/16));
  buildGrid();
}
function saveDrumPattern(){
  const idx=drumIndex;
  const name=prompt('Drum track name?', drumPatternNames[idx]||'');
  if(name===null) return;
  drumPatternNames[idx]=name||('Drum '+(idx+1));
  drumPatterns[idx]={pattern:JSON.parse(JSON.stringify(pattern)), instruments:[...rowInstruments], steps:drumSteps};
  populateDrumSelect();
}
function loadDrumPatternByName(){
  const name=prompt('Load drum track name?', drumPatternNames.join(', '));
  if(!name) return;
  const idx=drumPatternNames.indexOf(name);
  if(idx>=0){ drumIndex=idx; populateDrumSelect(); showDrumPattern(); }
}
function clearDrumPattern(){
  for(let r=0;r<4;r++) pattern[r].fill(false);
  buildGrid();
}
function playDrums(){ start(); }
function stopDrums(){ stop(); }

buildGrid();
populateDrumSelect();
showDrumPattern();

get('drumPatternSel').addEventListener('change',()=>{ drumIndex=parseInt(get('drumPatternSel').value); showDrumPattern(); });
get('saveDrumBtn').addEventListener('click', saveDrumPattern);
get('loadDrumBtn').addEventListener('click', loadDrumPatternByName);
get('clearDrumBtn').addEventListener('click', clearDrumPattern);
get('playDrumBtn').addEventListener('click', playDrums);
get('stopDrumBtn').addEventListener('click', stopDrums);

function loadSampleSong(){
  // Extend editor to two measures for a longer demo
  patternLenInput.value=2;
  buildPatternGrid();
  buildGrid();

  const steps=gridCols();

  // Distinct instrument snapshots for melody and bass
  const leadParams={...snapshotParams(), wave:'triangle'};
  const bassParams={...snapshotParams(), wave:'sawtooth', cutoff:1200};

  const v=voices[0];
  v.patternNames[0]='Sample Melody';
  v.patternNames[1]='Sample Bass';

  // 16-step melody with varied notes
  const melody=['C','E','G','B','C2','B','G','E','F','A','G','E','D','F','E','C'];
  v.patterns[0]=melody.map((n,i)=>({type:'note', note:n, t0:i*0.25, dur:0.25, params:leadParams}));

  // Simple bass accompaniment
  const bass=['C','G','A','F','C','G','A','F'];
  v.patterns[1]=bass.map((n,i)=>({type:'note', note:n, t0:i*0.5, dur:0.5, params:bassParams}));

  voices[0].trackerTrack=0;
  if(voices[1]) voices[1].trackerTrack=1;

  // Drum track with one hit per step
  const dp={0:Array(steps).fill(false),1:Array(steps).fill(false),2:Array(steps).fill(false),3:Array(steps).fill(false)};
  [0,8,16,24].forEach(i=>dp[1][i]=true);      // Kick
  [4,12,20,28].forEach(i=>dp[0][i]=true);     // Snare
  [2,6,10,14,18,22,26,30].forEach(i=>dp[2][i]=true); // Hat
  drumPatternNames[0]='Sample Drums';
  drumPatterns[0]={pattern:dp, instruments:['Snare','Kick','Hat','Tom'], steps};
  drumIndex=0;

  populatePatternSelect();
  patternSel.value=0;
  showPattern();
  populateTrackerSelects();
  renderTracker(0);
  if(voices[1]) renderTracker(1);
  populateDrumSelect();
  get('drumPatternSel').value=0;
  showDrumPattern();
}

// Drum synths
function playKick(t){ const o=ctx.createOscillator(); o.type='triangle'; const g=ctx.createGain(); g.gain.setValueAtTime(1,t); o.frequency.setValueAtTime(160,t); o.frequency.exponentialRampToValueAtTime(45,t+0.12); g.gain.exponentialRampToValueAtTime(0.001,t+0.18); o.connect(g); g.connect(master); o.start(t); o.stop(t+0.2); }
function playSnare(t){ const len=2048, buf=ctx.createBuffer(1,len,ctx.sampleRate), d=buf.getChannelData(0); for(let i=0;i<len;i++) d[i]=Math.random()*2-1; const n=ctx.createBufferSource(); n.buffer=buf; n.loop=true; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=800; const g=ctx.createGain(); g.gain.setValueAtTime(0.9,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.15); n.connect(hp); hp.connect(g); g.connect(master); n.start(t); n.stop(t+0.16); }
function playHat(t){ const len=2048, buf=ctx.createBuffer(1,len,ctx.sampleRate), d=buf.getChannelData(0); for(let i=0;i<len;i++) d[i]=Math.random()*2-1; const n=ctx.createBufferSource(); n.buffer=buf; n.loop=true; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000; const g=ctx.createGain(); g.gain.setValueAtTime(0.7,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.07); n.connect(hp); hp.connect(g); g.connect(master); n.start(t); n.stop(t+0.08); }
function playTom(t){ const o=ctx.createOscillator(); o.type='triangle'; const g=ctx.createGain(); g.gain.setValueAtTime(1,t); o.frequency.setValueAtTime(220,t); o.frequency.exponentialRampToValueAtTime(120,t+0.12); g.gain.exponentialRampToValueAtTime(0.001,t+0.18); o.connect(g); g.connect(master); o.start(t); o.stop(t+0.2); }
function playClap(t){ const bursts=[0,0.02,0.04]; bursts.forEach((dly)=>{ const len=2048, buf=ctx.createBuffer(1,len,ctx.sampleRate), data=buf.getChannelData(0); for(let i=0;i<len;i++) data[i]=Math.random()*2-1; const n=ctx.createBufferSource(); n.buffer=buf; n.loop=true; const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2000; bp.Q.value=0.7; const g=ctx.createGain(); g.gain.setValueAtTime(0.7,t+dly); g.gain.exponentialRampToValueAtTime(0.001,t+dly+0.08); n.connect(bp); bp.connect(g); g.connect(master); n.start(t+dly); n.stop(t+dly+0.09); }); }
function playCowbell(t){ const o1=ctx.createOscillator(), o2=ctx.createOscillator(); o1.type=o2.type='square'; o1.frequency.setValueAtTime(560,t); o2.frequency.setValueAtTime(845,t); const g=ctx.createGain(); g.gain.setValueAtTime(0.8,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.2); o1.connect(g); o2.connect(g); g.connect(master); o1.start(t); o2.start(t); o1.stop(t+0.22); o2.stop(t+0.22); }
function triggerDrum(name,t){
  if(ctx.state!=='running') return;
  ({Kick:playKick,Snare:playSnare,Hat:playHat,Tom:playTom,Clap:playClap,Cowbell:playCowbell}[name] || playKick)(t);
}

let isPlaying=false, currStep=0, schedId=null, lastSchedule=0;
function schedule(){ const secPerStep=stepSeconds(); const lookahead=0.1; const now=ctx.currentTime; while(lastSchedule < now+lookahead){ for(let r=0;r<4;r++){ if(pattern[r][currStep]) triggerDrum(rowInstruments[r], lastSchedule); } const cells=drumGrid.querySelectorAll('.step'); cells.forEach((c,i)=>{ const col=i%drumSteps; c.classList.toggle('playing', col===currStep); }); currStep=(currStep+1)%drumSteps; lastSchedule+=secPerStep; } }
function start(){ if(isPlaying) return; isPlaying=true; currStep=0; lastSchedule=ctx.currentTime; schedId=setInterval(schedule,25); }
function stop(){ if(!isPlaying) return; isPlaying=false; clearInterval(schedId); schedId=null; drumGrid.querySelectorAll('.step').forEach(c=>c.classList.remove('playing')); }

// Keyboard triggers for drums
const drumKeyMap={z:0,x:1,c:2,v:3};
document.addEventListener('keydown',e=>{ const k=e.key.toLowerCase(); if(drumKeyMap.hasOwnProperty(k)){ triggerDrum(['Kick','Snare','Hat','Tom','Clap','Cowbell'].includes(rowInstruments[drumKeyMap[k]])?rowInstruments[drumKeyMap[k]]:'Kick', ctx.currentTime); }});

// ======= Wire up segmented controls & presets =======
populateEngineSelect();
let savedEngine=null;
try{ savedEngine=localStorage.getItem(ENGINE_STORAGE_KEY); }catch(e){ savedEngine=null; }
(async()=>{
  try{ await setEngine(savedEngine||state.engine); }
  catch(e){ console.warn('Engine init failed', e); }
})();
if(engineSel){
  engineSel.addEventListener('change', ()=>{
    setEngine(engineSel.value,{persist:true}).catch(err=>{
      console.warn('Engine switch failed', err);
      engineSel.value=state.engine;
    });
  });
}
// Wave buttons
Array.from(document.querySelectorAll('#waveBtns .segBtn')).forEach(btn=>{
  btn.addEventListener('click', ()=>{ setWaveButtons(btn.dataset.wave); });
});
populateWavePresets();
get('wavePreset').addEventListener('change', applyWavePreset);
applyWavePreset();

// Filter buttons
Array.from(document.querySelectorAll('#filterBtns .segBtn')).forEach(btn=>{
  btn.addEventListener('click', ()=>{ setFilterButtons(btn.dataset.filter); });
});
populateFilterPresets();
get('filterPreset').addEventListener('change', applyFilterPreset);
// Arp mode buttons
Array.from(document.querySelectorAll('#arpModeBtns .segBtn')).forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#arpModeBtns .segBtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
});
if(instSel) selectInstrument(instSel.value).catch(err=>console.warn('Instrument select failed', err));
loadSampleSong();
updateFilterVis();

// ADSR presets
populateADSRPresets();
get('adsrPreset').addEventListener('change', applyADSRPreset);
updateADSRVis();

// Live updates -> visuals
['sidPW','sidPWMRate','sidPWMDepth','vibRate','vibAmt'].forEach(id=>{
  const el=get(id);
  if(el) el.addEventListener('input', ()=>{
    updateWaveVis();
    if(state.engine==='websid') syncWebSidParams();
  });
});
['sidCutoff','sidRes'].forEach(id=>{
  const el=get(id);
  if(el) el.addEventListener('input', ()=>{
    updateFilterVis();
    if(state.engine==='websid') syncWebSidParams();
  });
});
['sidA','sidD','sidS','sidR'].forEach(id=>{ const el=get(id); if(el) el.addEventListener('input', updateADSRVis); });

// Initial visuals
updateWaveVis(); updateFilterVis(); updateADSRVis();
initBootIntro();

// Help modal
const helpBtn=get('helpBtn');
const helpModal=get('helpModal');
const helpClose=get('helpClose');
let helpPopup=null;
function openHelp(section, anchor){
  if(section && anchor){
    if(helpPopup) helpPopup.remove();
    const src=document.querySelector('#help-'+section);
    if(!src) return;
    const pop=document.createElement('div');
    pop.className='helpPopup';
    pop.innerHTML=src.innerHTML;
    document.body.appendChild(pop);
    const rect=anchor.getBoundingClientRect();
    pop.style.left=(rect.right+8+window.scrollX)+'px';
    pop.style.top=(rect.top+window.scrollY)+'px';
    helpPopup=pop;
    const close=e=>{ if(!pop.contains(e.target) && e.target!==anchor){ pop.remove(); helpPopup=null; document.removeEventListener('click',close); }};
    setTimeout(()=>document.addEventListener('click', close));
  }else{
    if(helpPopup){ helpPopup.remove(); helpPopup=null; }
    helpModal.classList.add('show');
  }
}
function closeHelp(){
  helpModal.classList.remove('show');
}
if(helpBtn && helpModal && helpClose){
  helpBtn.addEventListener('click', ()=>openHelp());
  helpClose.addEventListener('click', closeHelp);
  helpModal.addEventListener('click', e=>{ if(e.target===helpModal) closeHelp(); });
  document.querySelectorAll('.cardHelp').forEach(b=>b.addEventListener('click', e=>{ e.stopPropagation(); openHelp(b.dataset.help, b); }));
}
</script>
</body>
</html>
